<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Y.M.I.R AI Dashboard - Advanced Emotion Detection & Analysis Platform</title>
    <meta name="description" content="Professional AI-powered emotion detection platform with real-time facial analysis, text sentiment analysis, and personalized music recommendations. Advanced microservices architecture for enterprise applications.">
    <meta name="keywords" content="AI emotion detection, facial analysis, sentiment analysis, emotion AI, machine learning, microservices, enterprise AI, emotional intelligence, mood analysis">
    <meta name="author" content="Y.M.I.R Development Team">
    <meta property="og:title" content="Y.M.I.R AI Dashboard - Advanced Emotion Detection Platform">
    <meta property="og:description" content="Professional AI-powered emotion detection with real-time analysis and personalized recommendations">
    <meta property="og:type" content="website">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='40' fill='%234F46E5'/><text x='50' y='60' font-family='Arial,sans-serif' font-size='35' font-weight='bold' fill='white' text-anchor='middle'>Y</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase Authentication Styles -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/auth-styles.css') }}">
    <style>
        /* Root Variables */
        :root {
            --color-primary: #000000;
            --color-secondary: #0f172a;
            --color-accent: #3b82f6;
            --color-text: #ffffff;
            --color-card: rgba(15, 23, 42, 0.7);
            --color-card-hover: rgba(30, 41, 59, 0.8);
            --color-border: rgba(59, 130, 246, 0.3);
            --color-glow: rgba(59, 130, 246, 0.6);
            --color-neon-blue: rgba(59, 130, 246, 0.9);
            --color-neon-white: rgba(255, 255, 255, 0.8);
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
            background: linear-gradient(125deg, #000000, #0f172a, #1e293b);
            background-size: 300% 300%;
            animation: gradientFlow 15s ease infinite;
            color: var(--color-text);
            min-height: 100vh;
        }

        @keyframes gradientFlow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Floating Particles */
        @keyframes float {
            0% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(180deg); }
            100% { transform: translateY(0) rotate(360deg); }
        }

        .floating {
            animation: float 6s ease-in-out infinite;
        }

        /* Glowing Text */
        .glow-text {
            text-shadow: 0 0 8px rgba(59, 130, 246, 0.6), 0 0 12px rgba(59, 130, 246, 0.4);
        }

        /* Fade In Animation */
        .fade-in {
            opacity: 0;
            animation: fadeIn 1s forwards;
            animation-delay: var(--delay, 0s);
        }

        @keyframes fadeIn {
            to { opacity: 1; }
        }

        /* Slide in animations */
        .slide-in-left {
            opacity: 0;
            transform: translateX(-50px);
            animation: slideInLeft 0.8s forwards;
        }

        .slide-in-right {
            opacity: 0;
            transform: translateX(50px);
            animation: slideInRight 0.8s forwards;
        }

        @keyframes slideInLeft {
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideInRight {
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .content-wrapper {
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Header */
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px 0;
            border-bottom: 2px solid var(--color-accent);
            position: relative;
            z-index: 10;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin: 0;
            background: linear-gradient(45deg, var(--color-accent), #06b6d4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 8px rgba(59, 130, 246, 0.6);
        }
        
        .header p {
            font-size: 1.1rem;
            color: var(--color-neon-white);
            margin: 10px 0 0 0;
        }
        
        /* Status Cards */
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .status-card {
            background: var(--color-card);
            backdrop-filter: blur(12px);
            border-radius: 16px;
            border: 1px solid var(--color-border);
            padding: 20px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
            transition: all 0.4s ease;
            position: relative;
            z-index: 10;
            overflow: hidden;
        }

        .status-card:hover {
            transform: translateY(-5px);
            border-color: var(--color-accent);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3), 0 0 15px var(--color-glow);
        }

        .status-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--color-accent), transparent);
            transform: scaleX(0);
            transition: transform 0.4s ease;
        }

        .status-card:hover::before {
            transform: scaleX(1);
        }
        
        .status-card.healthy {
            border-color: rgba(34, 197, 94, 0.5);
        }
        
        .status-card.unhealthy {
            border-color: rgba(239, 68, 68, 0.5);
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-indicator.healthy {
            background: #22c55e;
            box-shadow: 0 0 10px rgba(34, 197, 94, 0.5);
        }
        
        .status-indicator.unhealthy {
            background: #ef4444;
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
        }
        
        /* Main Dashboard */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 30px;
        }
        
        .camera-section {
            background: var(--color-card);
            backdrop-filter: blur(12px);
            border-radius: 16px;
            border: 1px solid var(--color-border);
            padding: 25px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
            transition: all 0.4s ease;
            position: relative;
            z-index: 10;
            overflow: hidden;
        }

        .camera-section:hover {
            transform: translateY(-5px);
            border-color: var(--color-accent);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3), 0 0 15px var(--color-glow);
        }
        
        .emotion-panel {
            background: var(--color-card);
            backdrop-filter: blur(12px);
            border-radius: 16px;
            border: 1px solid var(--color-border);
            padding: 25px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
            transition: all 0.4s ease;
            position: relative;
            z-index: 10;
            overflow: hidden;
        }

        .emotion-panel:hover {
            transform: translateY(-5px);
            border-color: var(--color-accent);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3), 0 0 15px var(--color-glow);
        }
        
        h2 {
            color: var(--color-text);
            font-size: 1.5rem;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--color-accent);
            display: inline-block;
            background: linear-gradient(45deg, var(--color-accent), #06b6d4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* Camera Controls */
        .camera-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            justify-content: center;
        }
        
        button {
            padding: 12px 24px;
            background: linear-gradient(135deg, var(--color-accent), #2563eb);
            color: var(--color-text);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s ease;
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.6);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 0 25px rgba(59, 130, 246, 0.8);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-stop {
            background: linear-gradient(45deg, #dc3545, #e83e8c);
        }
        
        /* Video Container */
        .video-container {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            border: 3px solid var(--color-accent);
            min-height: 300px;
            align-items: center;
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
        }
        
        .video-container img {
            max-width: 100%;
            height: auto;
            display: block;
        }
        
        .video-placeholder {
            text-align: center;
            color: #666;
            font-size: 1.2rem;
            padding: 40px;
        }
        
        /* Emotion Display */
        .emotion-display {
            background: rgba(59, 130, 246, 0.1);
            border-radius: 12px;
            border-left: 4px solid var(--color-accent);
            padding: 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(8px);
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.2);
        }
        
        .emotion-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .emotion-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .emotion-label {
            font-weight: 500;
            text-transform: capitalize;
        }
        
        .emotion-value {
            color: var(--color-accent);
            font-weight: 600;
        }
        
        .stable-emotion {
            background: rgba(34, 197, 94, 0.1);
            border-left-color: #22c55e;
            color: #22c55e;
        }
        
        /* Service Status */
        .service-status {
            background: rgba(40, 40, 40, 0.5);
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            font-family: monospace;
            font-size: 0.9rem;
        }
        
        /* Text Emotion Styles */
        .text-emotion-section {
            background: var(--color-card);
            backdrop-filter: blur(12px);
            border-radius: 16px;
            border: 1px solid var(--color-border);
            padding: 25px;
            margin-top: 20px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
            transition: all 0.4s ease;
            position: relative;
            z-index: 10;
            overflow: hidden;
        }

        .text-emotion-section:hover {
            transform: translateY(-5px);
            border-color: var(--color-accent);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3), 0 0 15px var(--color-glow);
        }
        
        .chat-container {
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            height: 500px; /* Expanded height to use empty space */
        }
        
        .chat-history {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 15px 15px 30px 15px; /* Extra bottom padding */
            flex: 1; /* Take all available space */
            overflow-y: auto;
            margin-bottom: 15px;
            border: 1px solid var(--color-border);
            display: flex;
            flex-direction: column;
            scroll-behavior: smooth; /* Smooth scrolling */
            backdrop-filter: blur(8px);
        }
        
        .chat-message {
            margin-bottom: 15px;
            padding: 12px 16px;
            border-radius: 12px;
            max-width: 85%;
            word-wrap: break-word;
            position: relative;
        }
        
        .chat-message.user {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.25), rgba(59, 130, 246, 0.15));
            border: 1px solid var(--color-border);
            margin-left: auto;
            text-align: right;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2);
            backdrop-filter: blur(8px);
        }
        
        .chat-message.bot {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.2), rgba(34, 197, 94, 0.1));
            border: 1px solid rgba(34, 197, 94, 0.3);
            margin-right: auto;
            box-shadow: 0 2px 8px rgba(34, 197, 94, 0.15);
        }
        
        .chat-message-emotion {
            font-size: 0.8rem;
            color: #888;
            margin-top: 5px;
        }
        
        .chat-input-container {
            display: flex;
            gap: 10px;
        }
        
        .chat-input {
            flex: 1;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            padding: 12px;
            color: var(--color-text);
            font-size: 1rem;
            backdrop-filter: blur(8px);
        }
        
        .chat-input:focus {
            outline: none;
            border-color: var(--color-accent);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }
        
        .send-btn {
            background: linear-gradient(135deg, var(--color-accent), #22c55e);
            border: none;
            border-radius: 8px;
            color: var(--color-text);
            padding: 12px 20px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.6);
        }
        
        .send-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 0 25px rgba(59, 130, 246, 0.8);
        }
        
        .text-service-status {
            background: rgba(59, 130, 246, 0.1);
            border-radius: 8px;
            padding: 15px;
            border-left: 4px solid var(--color-accent);
            backdrop-filter: blur(8px);
        }
        
        .text-service-status h4 {
            color: var(--color-accent);
            margin-bottom: 10px;
        }
        
        /* Loading States */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(59, 130, 246, 0.3);
            border-radius: 50%;
            border-top-color: var(--color-accent);
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Error States */
        .error-message {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 8px;
            padding: 15px;
            color: #ef4444;
            margin: 10px 0;
        }
        
        /* Advanced Controls Styling */
        .toggle-label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            transition: background-color 0.2s;
            font-size: 0.9em;
        }

        .toggle-label:hover {
            background: rgba(255,255,255,0.05);
        }

        .toggle-label input[type="checkbox"] {
            appearance: none;
            width: 18px;
            height: 18px;
            border: 2px solid #4fd1c7;
            border-radius: 3px;
            position: relative;
            cursor: pointer;
            transition: all 0.2s;
        }

        .toggle-label input[type="checkbox"]:checked {
            background: #4fd1c7;
            border-color: #4fd1c7;
        }

        .toggle-label input[type="checkbox"]:checked::after {
            content: 'âœ“';
            position: absolute;
            top: -2px;
            left: 2px;
            color: #1f2937;
            font-size: 14px;
            font-weight: bold;
        }

        .control-section {
            border-left: 3px solid #4fd1c7;
            padding-left: 15px;
        }

        /* ðŸŽµ AI Music Discovery System - Hackathon Winner Design */
        .music-carousel-container {
            margin: 40px 0;
            padding: 35px;
            background: 
                radial-gradient(ellipse at top left, rgba(59, 130, 246, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at top right, rgba(96, 165, 250, 0.06) 0%, transparent 50%),
                radial-gradient(ellipse at bottom, rgba(30, 58, 138, 0.05) 0%, transparent 40%),
                linear-gradient(145deg, rgba(15, 23, 42, 0.98), rgba(30, 58, 138, 0.95));
            border-radius: 30px;
            border: 2px solid transparent;
            background-clip: padding-box;
            position: relative;
            box-shadow: 
                0 30px 100px rgba(0, 0, 0, 0.6),
                0 0 60px rgba(59, 130, 246, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.12),
                inset 0 -1px 0 rgba(59, 130, 246, 0.05);
            overflow: hidden;
            backdrop-filter: blur(20px);
            cursor: grab;
            user-select: none;
        }

        .music-carousel-container:active {
            cursor: grabbing;
        }

        /* Carousel Controls */
        .carousel-controls {
            position: absolute;
            bottom: 15px;
            right: 20px;
            display: flex;
            gap: 8px;
            z-index: 10;
        }

        .carousel-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .carousel-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.3);
        }

        .carousel-btn.active {
            background: rgba(79, 209, 199, 0.3);
            border-color: #4fd1c7;
            color: #4fd1c7;
        }

        /* Scroll indicator */
        .scroll-indicator {
            position: absolute;
            bottom: 8px;
            left: 50%;
            transform: translateX(-50%);
            color: rgba(255, 255, 255, 0.4);
            font-size: 0.65em;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .music-carousel-container:hover .scroll-indicator {
            opacity: 1;
        }

        /* Animated Holographic Border - Dark Blue Theme */
        .music-carousel-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 30px;
            padding: 2px;
            background: linear-gradient(45deg, #1e3a8a, #3b82f6, #60a5fa, #93c5fd, #1e3a8a);
            background-size: 400% 400%;
            animation: holographicBorder 6s ease infinite;
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask-composite: xor;
            -webkit-mask-composite: xor;
            z-index: -1;
        }

        @keyframes holographicBorder {
            0%, 100% { background-position: 0% 50%; }
            25% { background-position: 100% 0%; }
            50% { background-position: 100% 100%; }
            75% { background-position: 0% 100%; }
        }

        /* Enhanced Floating Particles Effect - Dark Blue Theme */
        .music-carousel-container::after {
            content: '';
            position: absolute;
            top: -10px;
            left: -10px;
            width: calc(100% + 20px);
            height: calc(100% + 20px);
            background-image: 
                radial-gradient(circle at 15% 85%, rgba(59, 130, 246, 0.15) 0%, transparent 45%),
                radial-gradient(circle at 85% 15%, rgba(96, 165, 250, 0.12) 0%, transparent 45%),
                radial-gradient(circle at 45% 35%, rgba(30, 58, 138, 0.1) 0%, transparent 40%),
                radial-gradient(circle at 65% 75%, rgba(147, 197, 253, 0.08) 0%, transparent 40%),
                radial-gradient(circle at 25% 25%, rgba(191, 219, 254, 0.06) 0%, transparent 35%),
                radial-gradient(circle at 75% 65%, rgba(59, 130, 246, 0.05) 0%, transparent 35%);
            animation: floatingParticles 12s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
            border-radius: 35px;
        }

        @keyframes floatingParticles {
            0%, 100% { 
                transform: translateY(0px) translateX(0px) rotate(0deg); 
                opacity: 1; 
                filter: blur(0px);
            }
            25% { 
                transform: translateY(-8px) translateX(3px) rotate(2deg); 
                opacity: 0.8; 
                filter: blur(0.5px);
            }
            50% { 
                transform: translateY(-15px) translateX(-2px) rotate(4deg); 
                opacity: 1; 
                filter: blur(1px);
            }
            75% { 
                transform: translateY(-10px) translateX(5px) rotate(-2deg); 
                opacity: 0.9; 
                filter: blur(0.3px);
            }
        }

        /* AI Music Header Styling */
        .music-carousel-header {
            text-align: center;
            margin-bottom: 25px;
            position: relative;
            z-index: 1;
        }

        .ai-music-title {
            background: linear-gradient(135deg, #3b82f6, #60a5fa, #93c5fd);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 42px;  /* ðŸš€ INCREASED: 32px â†’ 42px for bigger title */
            transition: all 0.3s ease;
            font-weight: 800;
            margin: 0 0 15px 0;
            text-shadow: 0 0 30px rgba(59, 130, 246, 0.4);
            letter-spacing: 1px;
            position: relative;
        }

        .music-update-status {
            text-align: center;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin: 10px 0;
            animation: fadeInBounce 0.5s ease-out;
        }

        .music-update-status.loading {
            background: rgba(59, 130, 246, 0.2);
            color: #60A5FA;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .music-update-status.success {
            background: rgba(34, 197, 94, 0.2);
            color: #4ADE80;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .music-update-status.error {
            background: rgba(239, 68, 68, 0.2);
            color: #F87171;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        @keyframes fadeInBounce {
            0% { opacity: 0; transform: translateY(-10px) scale(0.9); }
            50% { transform: translateY(2px) scale(1.02); }
            100% { opacity: 1; transform: translateY(0) scale(1); }
        }

        .emotion-pulse {
            animation: emotionPulse 2s ease-in-out infinite;
        }

        @keyframes emotionPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* Enhanced AI Badge Styling - Dark Blue Neon Theme */
        .ai-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            background: linear-gradient(135deg, rgba(30, 58, 138, 0.3), rgba(59, 130, 246, 0.2));
            border: 2px solid transparent;
            border-radius: 30px;
            padding: 12px 24px;
            font-size: 15px;
            color: #60a5fa;
            font-weight: 700;
            margin: 15px 0 25px 0;
            backdrop-filter: blur(20px);
            box-shadow: 
                0 8px 32px rgba(59, 130, 246, 0.25),
                inset 0 1px 0 rgba(96, 165, 250, 0.2);
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
        }

        .ai-badge::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 30px;
            padding: 2px;
            background: linear-gradient(45deg, #1e3a8a, #3b82f6, #60a5fa, #93c5fd);
            background-size: 300% 300%;
            animation: badgeBorder 3s ease infinite;
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask-composite: xor;
            -webkit-mask-composite: xor;
            z-index: -1;
        }

        @keyframes badgeBorder {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .ai-badge:hover {
            transform: translateY(-2px);
            box-shadow: 
                0 12px 40px rgba(59, 130, 246, 0.4),
                inset 0 1px 0 rgba(96, 165, 250, 0.3);
        }

        .ai-icon {
            width: 20px;
            height: 20px;
            background: linear-gradient(135deg, #4fd1c7, #06d6a0);
            border-radius: 50%;
            position: relative;
            animation: aiPulse 2s ease-in-out infinite;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .ai-icon::before {
            content: 'ðŸ§ ';
            font-size: 12px;
        }

        @keyframes aiPulse {
            0%, 100% { 
                box-shadow: 0 0 0 0 rgba(79, 209, 199, 0.7);
                transform: scale(1);
            }
            50% { 
                box-shadow: 0 0 0 10px rgba(79, 209, 199, 0);
                transform: scale(1.1);
            }
        }


        /* Enhanced AI Status Indicator */
        .ai-status {
            margin: 20px 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.9), rgba(30, 58, 138, 0.7));
            border-radius: 25px;
            padding: 12px 20px;
            border: 1px solid rgba(59, 130, 246, 0.4);
            backdrop-filter: blur(15px);
            box-shadow: 
                0 4px 20px rgba(0, 0, 0, 0.4),
                0 0 15px rgba(59, 130, 246, 0.2),
                inset 0 1px 0 rgba(96, 165, 250, 0.1);
            font-size: 14px;
            font-weight: 500;
            color: #dbeafe;
            text-align: center;
            white-space: nowrap;
            min-width: 280px;
            transition: all 0.3s ease;
        }

        .status-indicator:hover {
            transform: translateY(-1px);
            box-shadow: 
                0 6px 25px rgba(0, 0, 0, 0.5),
                0 0 25px rgba(59, 130, 246, 0.3),
                inset 0 1px 0 rgba(96, 165, 250, 0.2);
        }

        .pulse-dot {
            width: 10px;
            height: 10px;
            background: radial-gradient(circle, #3b82f6, #1e40af);
            border-radius: 50%;
            animation: enhancedStatusPulse 2.5s ease-in-out infinite;
            box-shadow: 0 0 8px rgba(59, 130, 246, 0.6);
        }

        @keyframes enhancedStatusPulse {
            0% {
                transform: scale(0.9);
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.8);
                opacity: 1;
            }
            50% {
                transform: scale(1.1);
                box-shadow: 0 0 0 8px rgba(59, 130, 246, 0.2);
                opacity: 0.8;
            }
            100% {
                transform: scale(0.9);
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0);
                opacity: 1;
            }
        }

        #aiStatus {
            font-size: 14px;
            color: #e2e8f0;
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
            letter-spacing: 0.5px;
        }

        .music-carousel {
            overflow: hidden;
            width: 100%;
            position: relative;
            height: 200px;
        }

        /* CSS Version 6.0 - Optimal Speed with Manual Controls */
        .music-track {
            display: flex;
            gap: 20px;
            animation: scroll-left 60s linear infinite;
            width: fit-content;
            transition: transform 0.5s cubic-bezier(0.4, 0.0, 0.2, 1);
        }

        .music-track.dragging {
            animation-play-state: paused !important;
            cursor: grabbing !important;
            transition: none !important;
        }

        .music-track.paused {
            animation-play-state: paused !important;
        }

        .music-carousel {
            cursor: grab;
        }

        .music-carousel:active {
            cursor: grabbing;
        }

        /* ðŸŽ¨ ENHANCED AI SONG CARDS - STUNNING VISUAL DESIGN */
        .ai-song-card {
            min-width: 320px;
            height: 200px;
            border-radius: 20px;
            padding: 0;
            border: none;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            cursor: pointer;
            position: relative;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3), 
                        0 0 0 1px rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        .ai-song-card:hover {
            transform: translateY(-10px) scale(1.02) rotateX(5deg);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4), 
                        0 0 0 1px rgba(255, 255, 255, 0.2),
                        0 0 40px rgba(255, 255, 255, 0.1);
            animation-play-state: paused;
        }

        /* Floating Music Icon */
        .floating-music-icon {
            position: absolute;
            top: 15px;
            left: 15px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            animation: float 3s ease-in-out infinite;
        }

        .music-note {
            font-size: 18px;
            color: white;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        .music-wave {
            position: absolute;
            width: 60px;
            height: 60px;
            border: 2px solid rgba(79, 209, 199, 0.4);
            border-radius: 50%;
            animation: pulse-ring 2s ease-in-out infinite;
        }

        /* Card Content */
        .card-content {
            padding: 20px;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            position: relative;
            z-index: 2;
        }

        /* Enhanced Song Title */
        .enhanced-song-title {
            position: relative;
            margin-bottom: 8px;
        }

        .title-text {
            font-size: 1.2em;
            font-weight: 700;
            color: white;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
            display: block;
            line-height: 1.2;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 220px;
        }

        .title-glow {
            position: absolute;
            bottom: -2px;
            left: 0;
            height: 2px;
            width: 0;
            background: linear-gradient(90deg, #4fd1c7, rgba(79, 209, 199, 0.5));
            transition: width 0.4s ease;
        }

        .ai-song-card:hover .title-glow {
            width: 100%;
        }

        /* Enhanced Artist */
        .enhanced-artist {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
        }

        .artist-icon {
            font-size: 14px;
            opacity: 0.8;
        }

        .artist-text {
            font-size: 0.95em;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 500;
            text-shadow: 0 1px 5px rgba(0, 0, 0, 0.3);
        }

        /* Popularity Stats */
        .popularity-stats {
            display: flex;
            gap: 12px;
            margin-top: auto;
        }

        .stat-bubble {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 8px 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stat-bubble:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
        }

        .stat-icon {
            font-size: 14px;
            margin-bottom: 2px;
        }

        .stat-value {
            font-size: 0.85em;
            font-weight: bold;
            color: white;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
        }

        .stat-label {
            font-size: 0.7em;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 500;
        }

        /* Enhanced Play Button */
        .enhanced-play-btn {
            position: absolute;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            width: 50px;
            height: 50px;
            cursor: pointer;
            z-index: 3;
        }

        .play-btn-inner {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.3), rgba(255, 255, 255, 0.1));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .play-icon-enhanced {
            font-size: 18px;
            color: white;
            margin-left: 3px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
            z-index: 2;
        }

        .play-ripple {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: scale(0);
            opacity: 0;
            transition: all 0.4s ease;
        }

        .enhanced-play-btn:hover .play-btn-inner {
            transform: scale(1.1);
            background: linear-gradient(135deg, rgba(79, 209, 199, 0.4), rgba(79, 209, 199, 0.2));
            box-shadow: 0 0 20px rgba(79, 209, 199, 0.4);
        }

        .enhanced-play-btn:active .play-ripple {
            transform: scale(1.2);
            opacity: 1;
        }

        .play-glow {
            position: absolute;
            width: 70px;
            height: 70px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1), transparent);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .enhanced-play-btn:hover .play-glow {
            opacity: 1;
        }

        /* Card Shine Effect */
        .card-shine {
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transform: rotate(45deg) translateX(-100%);
            transition: transform 0.6s ease;
        }

        .ai-song-card:hover .card-shine {
            transform: rotate(45deg) translateX(100%);
        }

        /* Animations */
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
        }

        @keyframes pulse-ring {
            0% { transform: scale(0.8); opacity: 1; }
            100% { transform: scale(1.4); opacity: 0; }
        }

        /* Legacy song-card styles for compatibility */
        .song-card {
            min-width: 280px;
            background: linear-gradient(135deg, #1f2937, #374151);
            border-radius: 12px;
            padding: 15px;
            border: 1px solid rgba(79, 209, 199, 0.3);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .song-info {
            margin-bottom: 15px;
        }

        .song-title {
            font-size: 1.1em;
            font-weight: bold;
            color: #4fd1c7;
            margin-bottom: 5px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .song-artist {
            color: #fbbf24;
            font-size: 0.9em;
            margin-bottom: 3px;
        }

        .song-duration {
            color: #9ca3af;
            font-size: 0.8em;
        }

        .song-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .play-btn {
            background: linear-gradient(135deg, #4fd1c7, #06d6a0);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
            font-size: 1.2em;
        }

        .play-btn:hover {
            background: linear-gradient(135deg, #06d6a0, #4fd1c7);
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(79, 209, 199, 0.4);
        }

        .song-mood {
            background: rgba(79, 209, 199, 0.2);
            color: #4fd1c7;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7em;
            border: 1px solid rgba(79, 209, 199, 0.3);
        }

        @keyframes scroll-left {
            0% {
                transform: translateX(0%);
            }
            100% {
                transform: translateX(-25%);
            }
        }

        .music-track:hover {
            animation-play-state: paused;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .camera-controls {
                flex-direction: column;
                align-items: center;
            }

            .advanced-controls {
                margin: 15px 0 !important;
                padding: 10px !important;
            }

            .control-section > div {
                grid-template-columns: 1fr !important;
            }

            .music-carousel-container {
                margin: 20px 0;
                padding: 15px;
            }

            .song-card {
                min-width: 240px;
            }

            .music-track {
                animation-duration: 100s !important;
            }
        }

        /* Header Styles */
        .text-glow {
            text-shadow: 0 0 10px rgba(56, 189, 248, 0.5);
        }
        
        .nav-link::after {
            content: '';
            position: absolute;
            left: 50%;
            bottom: 0;
            width: 0;
            height: 2px;
            background: linear-gradient(to right, #3b82f6, #8b5cf6);
            transition: all 0.3s ease;
            transform: translateX(-50%);
        }
        
        .nav-link:hover::after {
            width: 80%;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        @keyframes rotate {
            0% { transform: rotate(0deg) scale(1); }
            25% { transform: rotate(5deg) scale(1.05); }
            75% { transform: rotate(-5deg) scale(1.05); }
            100% { transform: rotate(0deg) scale(1); }
        }
        
        .logo-container:hover .professional-icon {
            animation: rotate 0.6s ease;
        }
        
        .professional-icon {
            position: relative;
            overflow: hidden;
        }
        
        .professional-icon::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.3), transparent);
            transform: rotate(45deg);
            transition: all 0.6s;
            opacity: 0;
        }
        
        .logo-container:hover .professional-icon::before {
            left: 100%;
            opacity: 1;
        }
        
        .pulse-btn {
            animation: pulse 2s infinite;
        }
        
        .burger-menu {
            width: 30px;
            height: 25px;
            position: relative;
            cursor: pointer;
        }
        
        .burger-line {
            display: block;
            width: 100%;
            height: 2px;
            background-color: white;
            margin: 6px 0;
            transition: all 0.3s ease;
        }
        
        .burger-menu.active .burger-line:nth-child(1) {
            transform: rotate(45deg) translate(5px, 5px);
        }
        
        .burger-menu.active .burger-line:nth-child(2) {
            opacity: 0;
        }
        
        .burger-menu.active .burger-line:nth-child(3) {
            transform: rotate(-45deg) translate(7px, -7px);
        }
        
        @keyframes slideIn {
            0% { opacity: 0; transform: translateY(-10px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        
        .mobile-link {
            animation: slideIn 0.3s ease forwards;
            opacity: 0;
        }
        
        .mobile-link:nth-child(1) { animation-delay: 0.1s; }
        .mobile-link:nth-child(2) { animation-delay: 0.2s; }
        .mobile-link:nth-child(3) { animation-delay: 0.3s; }
        .mobile-link:nth-child(4) { animation-delay: 0.4s; }
        .mobile-link:nth-child(5) { animation-delay: 0.5s; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        nav {
            animation: fadeIn 0.5s ease forwards;
        }
        
        .nav-links {
            animation: fadeIn 0.7s ease forwards;
        }

        /* Professional Music Player Styles */
        .music-player-popup {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 380px;
            height: 480px;
            min-width: 300px;  /* ðŸ”§ Minimum resize limits */
            min-height: 400px;
            max-width: 800px;  /* ðŸ”§ Maximum resize limits */
            max-height: 1000px;
            background: linear-gradient(145deg, #1a1a2e 0%, #1e3a8a 50%, #0f172a 100%);
            border-radius: 20px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(59, 130, 246, 0.2);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8), 0 0 40px rgba(59, 130, 246, 0.15);
            z-index: 10000;
            overflow: hidden;
            opacity: 0;
            transform: scale(0.8) translateY(100px);
            resize: none; /* Disable default browser resize */
            transition: all 0.6s cubic-bezier(0.16, 1, 0.3, 1);
            pointer-events: none;
            cursor: move;
            user-select: none;
        }

        .music-player-popup.visible {
            opacity: 1;
            transform: scale(1) translateY(0);
            pointer-events: all;
        }

        /* Wind Leaves Animation */
        .wind-animation {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        .wind-animation.active {
            opacity: 1;
        }

        .wind-particle {
            position: absolute;
            background: linear-gradient(45deg, #4fd1c7, #81e6d9);
            border-radius: 50% 85% 50% 85%;
            opacity: 0;
            animation: windFloat 2s ease-in-out infinite;
        }

        @keyframes windFloat {
            0% {
                opacity: 0;
                transform: translateX(-50px) translateY(50px) rotate(0deg);
            }
            20% {
                opacity: 1;
            }
            80% {
                opacity: 1;
            }
            100% {
                opacity: 0;
                transform: translateX(450px) translateY(-100px) rotate(360deg);
            }
        }

        /* Player Content */
        .player-content {
            position: relative;
            width: 100%;
            height: 100%;
            padding: 25px;
            display: flex;
            flex-direction: column;
            opacity: 0;
            transform: scale(0.8);
            transition: all 0.4s ease;
        }

        .player-content.visible {
            opacity: 1;
            transform: scale(1);
        }

        /* Close Button */
        .close-player-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 35px;
            height: 35px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            color: white;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 10;
        }

        .close-player-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        /* Album Art Section */
        .album-art-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
            cursor: grab; /* ðŸŽ¯ Indicate draggable area */
            user-select: none; /* Prevent text selection during drag */
        }
        
        .album-art-section:active {
            cursor: grabbing; /* Show grabbing cursor when dragging */
        }

        /* ðŸ”§ RESIZE HANDLES STYLES */
        .resize-handle {
            position: absolute;
            background: rgba(59, 130, 246, 0.3);
            transition: all 0.2s ease;
            opacity: 0;
            pointer-events: none; /* Disable by default to prevent accidental triggers */
        }

        .music-player-popup:hover .resize-handle {
            opacity: 1; /* Show handles on hover */
            pointer-events: auto; /* Enable only when popup is hovered */
        }

        .resize-handle:hover {
            background: rgba(59, 130, 246, 0.6);
        }

        /* Corner Resize Handles */
        .resize-corner {
            width: 15px;
            height: 15px;
            border-radius: 50%;
        }

        .resize-nw { top: -5px; left: -5px; cursor: nw-resize; }
        .resize-ne { top: -5px; right: -5px; cursor: ne-resize; }
        .resize-sw { bottom: -5px; left: -5px; cursor: sw-resize; }
        .resize-se { bottom: -5px; right: -5px; cursor: se-resize; }

        /* Border Resize Handles */
        .resize-border {
            border-radius: 3px;
        }

        .resize-n { 
            top: -3px; left: 20px; right: 20px; 
            height: 6px; cursor: n-resize; 
        }
        .resize-s { 
            bottom: -3px; left: 20px; right: 20px; 
            height: 6px; cursor: s-resize; 
        }
        .resize-w { 
            left: -3px; top: 20px; bottom: 20px; 
            width: 6px; cursor: w-resize; 
        }
        .resize-e { 
            right: -3px; top: 20px; bottom: 20px; 
            width: 6px; cursor: e-resize; 
        }

        .album-art {
            width: 180px;
            height: 180px;
            border-radius: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            position: relative;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            margin-bottom: 15px;
            animation: albumRotate 20s linear infinite;
            animation-play-state: paused;
        }

        .album-art.playing {
            animation-play-state: running;
        }

        @keyframes albumRotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .album-art::before {
            content: 'â™ª';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 48px;
            color: rgba(255, 255, 255, 0.8);
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
        }

        /* Song Info */
        .song-info {
            text-align: center;
            margin-bottom: 20px;
        }

        .song-title {
            font-size: 18px;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 5px;
            line-height: 1.2;
        }

        .song-artist {
            font-size: 14px;
            color: #a0aec0;
            margin-bottom: 10px;
        }

        /* Progress Bar */
        .progress-section {
            margin-bottom: 20px;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            position: relative;
            cursor: pointer;
            margin-bottom: 8px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4fd1c7, #81e6d9);
            border-radius: 3px;
            width: 0%;
            transition: width 0.1s ease;
            position: relative;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            right: -6px;
            top: 50%;
            transform: translateY(-50%);
            width: 12px;
            height: 12px;
            background: #ffffff;
            border-radius: 50%;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .time-display {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #a0aec0;
        }

        /* Control Buttons */
        .player-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .control-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        .play-pause-btn {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #4fd1c7, #81e6d9);
            font-size: 20px;
            box-shadow: 0 5px 20px rgba(79, 209, 199, 0.4);
        }

        .play-pause-btn:hover {
            background: linear-gradient(135deg, #38b2ac, #4fd1c7);
            transform: scale(1.1);
        }

        /* Volume Control */
        .volume-section {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .volume-icon {
            color: #a0aec0;
            font-size: 16px;
        }

        .volume-slider {
            flex: 1;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            outline: none;
            cursor: pointer;
        }

        /* Loading Animation - Musical Icon */
        .loading-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #3b82f6;
            font-weight: 600;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .music-loading-icon {
            font-size: 48px;
            animation: musicPulse 1.5s ease-in-out infinite;
            color: #60a5fa;
            text-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
        }

        @keyframes musicPulse {
            0%, 100% { 
                transform: scale(1) rotate(0deg); 
                opacity: 0.8;
            }
            50% { 
                transform: scale(1.2) rotate(5deg); 
                opacity: 1;
            }
        }

        .loading-dots {
            display: flex;
            gap: 5px;
            justify-content: center;
        }

        .loading-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #3b82f6;
            animation: loadingDots 1.4s ease-in-out infinite both;
        }

        .loading-dot:nth-child(1) { animation-delay: -0.32s; }
        .loading-dot:nth-child(2) { animation-delay: -0.16s; }
        .loading-dot:nth-child(3) { animation-delay: 0s; }

        @keyframes loadingDots {
            0%, 80%, 100% {
                transform: scale(0);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(59, 130, 246, 0.1);
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Minimized Player */
        .mini-player {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 300px;
            height: 80px;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 15px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.8);
            z-index: 9999;
            opacity: 0;
            transform: translateY(100px);
            transition: all 0.5s cubic-bezier(0.16, 1, 0.3, 1);
            pointer-events: none;
            display: flex;
            align-items: center;
            padding: 10px;
            gap: 15px;
        }

        .mini-player.visible {
            opacity: 1;
            transform: translateY(0);
            pointer-events: all;
        }

        .mini-album-art {
            width: 60px;
            height: 60px;
            border-radius: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
            animation: miniAlbumRotate 20s linear infinite;
            animation-play-state: paused;
        }

        .mini-album-art.playing {
            animation-play-state: running;
        }

        @keyframes miniAlbumRotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .mini-album-art::before {
            content: 'â™ª';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            color: rgba(255, 255, 255, 0.8);
        }

        .mini-song-info {
            flex: 1;
            min-width: 0;
            color: white;
        }

        .mini-song-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .mini-song-artist {
            font-size: 12px;
            color: #a0aec0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .mini-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
        }

        .mini-control-btn {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .mini-control-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        .mini-play-pause-btn {
            background: linear-gradient(135deg, #4fd1c7, #81e6d9);
            width: 40px;
            height: 40px;
            font-size: 16px;
        }

        .mini-play-pause-btn:hover {
            background: linear-gradient(135deg, #38b2ac, #4fd1c7);
        }

        .mini-expand-btn {
            background: rgba(79, 209, 199, 0.2);
            border: 1px solid rgba(79, 209, 199, 0.4);
        }

        .mini-expand-btn:hover {
            background: rgba(79, 209, 199, 0.3);
        }

        .mini-close-btn {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.4);
        }

        .mini-close-btn:hover {
            background: rgba(239, 68, 68, 0.3);
        }

        /* Progress bar for mini player */
        .mini-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background: linear-gradient(90deg, #4fd1c7, #81e6d9);
            border-radius: 0 0 15px 15px;
            width: 0%;
            transition: width 0.1s ease;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .music-player-popup {
                width: 320px;
                height: 420px;
                bottom: 10px;
                right: 10px;
            }

            .album-art {
                width: 140px;
                height: 140px;
            }

            .song-title {
                font-size: 16px;
            }

            .mini-player {
                width: 280px;
                height: 70px;
                bottom: 10px;
                right: 10px;
                padding: 8px;
                gap: 10px;
            }

            .mini-album-art {
                width: 50px;
                height: 50px;
            }

            .mini-song-title {
                font-size: 13px;
            }

            .mini-song-artist {
                font-size: 11px;
            }
        }
        
        /* =================== THERAPIST FINDER MODAL STYLES =================== */
        .therapist-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .therapist-modal-content {
            background: linear-gradient(135deg, rgba(30, 30, 30, 0.95), rgba(20, 20, 40, 0.95));
            border-radius: 20px;
            border: 1px solid rgba(100, 100, 255, 0.3);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            width: 100%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }
        
        .therapist-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 25px 30px;
            border-bottom: 1px solid rgba(100, 100, 255, 0.2);
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.1));
        }
        
        .therapist-modal-header h2 {
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .close-button {
            background: none;
            border: none;
            color: #f0f0f0;
            font-size: 28px;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
        
        .close-button:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.1);
        }
        
        .therapist-search-section {
            padding: 25px 30px;
            border-bottom: 1px solid rgba(100, 100, 255, 0.1);
        }
        
        .location-status {
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(59, 130, 246, 0.1);
            border-radius: 12px;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }
        
        .location-loading {
            color: #60a5fa;
            font-weight: 500;
            text-align: center;
        }
        
        .search-filters {
            margin: 20px 0;
        }
        
        .filter-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .filter-select {
            padding: 12px;
            border-radius: 10px;
            border: 1px solid rgba(100, 100, 255, 0.3);
            background: rgba(30, 30, 30, 0.8);
            color: #f0f0f0;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .filter-select:focus {
            outline: none;
            border-color: rgba(59, 130, 246, 0.6);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .search-therapists-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(45deg, #22c55e, #16a34a);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3);
        }
        
        .search-therapists-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(34, 197, 94, 0.4);
        }
        
        .search-therapists-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .therapist-loading {
            padding: 40px;
            text-align: center;
            color: #b0b0b0;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(59, 130, 246, 0.2);
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .therapist-results {
            padding: 0 30px 30px;
        }
        
        .results-header {
            margin-bottom: 25px;
            text-align: center;
        }
        
        .results-header h3 {
            color: #60a5fa;
            font-size: 1.3rem;
            margin: 0;
        }
        
        .therapist-list {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .therapist-card {
            background: rgba(40, 40, 40, 0.6);
            border-radius: 16px;
            border: 1px solid rgba(100, 100, 255, 0.2);
            padding: 25px;
            display: flex;
            gap: 20px;
            transition: all 0.3s ease;
        }
        
        .therapist-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
            border-color: rgba(59, 130, 246, 0.4);
        }
        
        .therapist-photo {
            flex-shrink: 0;
        }
        
        .therapist-photo img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid rgba(59, 130, 246, 0.3);
        }
        
        .therapist-info {
            flex-grow: 1;
        }
        
        .therapist-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .therapist-header h4 {
            color: #f0f0f0;
            font-size: 1.2rem;
            margin: 0;
            font-weight: 600;
        }
        
        .therapist-rating {
            color: #fbbf24;
            font-size: 14px;
        }
        
        .therapist-rating span {
            color: #b0b0b0;
            margin-left: 5px;
        }
        
        .therapist-credentials {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .credential-badge, .distance-badge, .accepting-badge, .not-accepting-badge {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .credential-badge {
            background: rgba(59, 130, 246, 0.2);
            color: #93c5fd;
        }
        
        .distance-badge {
            background: rgba(139, 92, 246, 0.2);
            color: #c4b5fd;
        }
        
        .accepting-badge {
            background: rgba(34, 197, 94, 0.2);
            color: #86efac;
        }
        
        .not-accepting-badge {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
        }
        
        .therapist-specialties {
            color: #e2e8f0;
            margin-bottom: 15px;
            font-size: 14px;
        }
        
        .therapist-details {
            margin-bottom: 15px;
        }
        
        .detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            color: #b0b0b0;
            font-size: 13px;
        }
        
        .detail-row strong {
            color: #e2e8f0;
        }
        
        .therapist-bio {
            margin-bottom: 20px;
        }
        
        .therapist-bio p {
            color: #d1d5db;
            font-size: 14px;
            line-height: 1.5;
            margin: 0;
        }
        
        .therapist-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .contact-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }
        
        .contact-btn.primary {
            background: linear-gradient(45deg, #3b82f6, #1d4ed8);
            color: white;
        }
        
        .contact-btn.secondary {
            background: rgba(107, 114, 128, 0.2);
            color: #d1d5db;
            border: 1px solid rgba(107, 114, 128, 0.3);
        }
        
        .contact-btn:hover {
            transform: translateY(-1px);
        }
        
        .therapist-source {
            text-align: right;
        }
        
        .therapist-source small {
            color: #6b7280;
            font-size: 11px;
        }
        
        .no-results, .error-message {
            text-align: center;
            padding: 40px;
            color: #b0b0b0;
        }
        
        .no-results h3, .error-message h3 {
            color: #f0f0f0;
            margin-bottom: 15px;
        }
        
        .retry-btn {
            padding: 10px 20px;
            background: linear-gradient(45deg, #3b82f6, #1d4ed8);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 15px;
        }
        
        /* Mobile responsive */
        @media (max-width: 768px) {
            .therapist-modal-content {
                margin: 10px;
                max-height: 95vh;
            }
            
            .therapist-card {
                flex-direction: column;
                text-align: center;
            }
            
            .therapist-photo {
                align-self: center;
            }
            
            .therapist-header {
                flex-direction: column;
                gap: 5px;
            }
            
            .filter-row {
                grid-template-columns: 1fr;
            }
            
            .detail-row {
                flex-direction: column;
                gap: 5px;
            }
            
            .therapist-actions {
                justify-content: center;
            }
        }
        /* =================== END THERAPIST FINDER STYLES =================== */
        
        /* =================== VISUAL SETTINGS MODAL STYLES =================== */
        .settings-gear-btn {
            background: linear-gradient(45deg, #4f46e5, #7c3aed);
            border: none;
            border-radius: 12px;
            color: white;
            padding: 10px 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3);
        }

        .settings-gear-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(79, 70, 229, 0.4);
            background: linear-gradient(45deg, #5b21b6, #4338ca);
        }

        .gear-icon {
            font-size: 18px;
            animation: gear-rotate 3s linear infinite;
        }

        @keyframes gear-rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .settings-text {
            font-size: 14px;
        }

        .visual-settings-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            z-index: 10001;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .visual-settings-modal-content {
            background: linear-gradient(135deg, rgba(30, 30, 30, 0.95), rgba(20, 20, 40, 0.95));
            border-radius: 20px;
            border: 1px solid rgba(100, 100, 255, 0.3);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            width: 100%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .visual-settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 25px 30px;
            border-bottom: 1px solid rgba(100, 100, 255, 0.2);
            background: linear-gradient(135deg, rgba(79, 70, 229, 0.1), rgba(124, 58, 237, 0.1));
        }

        .visual-settings-header h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #4fd1c7;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .visual-settings-body {
            padding: 25px 30px;
        }

        .control-section {
            margin-bottom: 25px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(100, 100, 255, 0.1);
        }

        .control-section h4 {
            margin: 0 0 15px 0;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .control-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .toggle-label {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(100, 100, 255, 0.1);
        }

        .toggle-label:hover {
            background: rgba(100, 100, 255, 0.1);
            border-color: rgba(100, 100, 255, 0.3);
        }

        .toggle-label input[type="checkbox"] {
            accent-color: #4f46e5;
        }

        .settings-input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .settings-label {
            color: #a3a3a3;
            font-size: 0.9em;
            font-weight: 500;
        }

        .settings-select, .settings-range {
            width: 100%;
            padding: 8px 12px;
            background: #1f2937;
            color: white;
            border: 1px solid #374151;
            border-radius: 8px;
            font-size: 14px;
        }

        .settings-select:focus, .settings-range:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .range-value {
            color: #4fd1c7;
            font-weight: 600;
            font-size: 14px;
        }

        .full-width {
            grid-column: span 2;
        }

        @media (max-width: 768px) {
            .visual-settings-modal-content {
                margin: 10px;
                max-height: 95vh;
            }

            .control-grid {
                grid-template-columns: 1fr;
            }

            .full-width {
                grid-column: span 1;
            }

            .settings-gear-btn .settings-text {
                display: none;
            }
        }
        /* =================== END VISUAL SETTINGS MODAL STYLES =================== */
    </style>
</head>
<body>
{% include 'header.html' %}
    <!-- Background Particles -->
    <div class="absolute inset-0 z-0" style="position: fixed; width: 100%; height: 100%; overflow: hidden;">
        <div class="floating" style="position: absolute; top: 10%; left: 5%; width: 4px; height: 4px; background: linear-gradient(45deg, #3b82f6, #06b6d4); border-radius: 50%; animation-delay: 0s;"></div>
        <div class="floating" style="position: absolute; top: 60%; left: 80%; width: 6px; height: 6px; background: linear-gradient(45deg, #3b82f6, #06b6d4); border-radius: 50%; animation-delay: 2s;"></div>
        <div class="floating" style="position: absolute; top: 30%; left: 70%; width: 3px; height: 3px; background: linear-gradient(45deg, #3b82f6, #06b6d4); border-radius: 50%; animation-delay: 4s;"></div>
        <div class="floating" style="position: absolute; top: 80%; left: 20%; width: 5px; height: 5px; background: linear-gradient(45deg, #3b82f6, #06b6d4); border-radius: 50%; animation-delay: 1s;"></div>
        <div class="floating" style="position: absolute; top: 20%; left: 90%; width: 4px; height: 4px; background: linear-gradient(45deg, #3b82f6, #06b6d4); border-radius: 50%; animation-delay: 3s;"></div>
    </div>
    
    <div class="content-wrapper">
        <div class="header fade-in glow-text" style="--delay: 0.2s">
            <h1>Y.M.I.R AI Dashboard</h1>
            <p>Microservices Architecture - Real-time Emotion Detection</p>
        </div>
        
        <!-- Main Dashboard -->
        <div class="dashboard-grid">
            <!-- Camera Section -->
            <div class="camera-section slide-in-left" style="--delay: 0.4s">
                <h2>Real-Time Camera Feed</h2>
                
                <div class="camera-controls">
                    <button id="startBtn" onclick="startCamera()">ðŸ“¹ Start Camera</button>
                    <button id="stopBtn" onclick="stopCamera()" class="btn-stop" disabled>â¹ï¸ Stop Camera</button>
                    <button onclick="refreshStatus()">ðŸ”„ Refresh</button>
                    
                    <!-- Advanced Control Buttons -->
                    <button id="privacyModeBtn" onclick="togglePrivacyMode()" class="privacy-btn" title="Privacy Mode">
                        <span>ðŸ”’</span> Privacy
                    </button>
                    <button id="exportSessionBtn" onclick="exportSessionData()" class="export-btn" title="Export Session Data">
                        <span>ðŸ’¾</span> Export
                    </button>
                    
                    <!-- Settings Gear Icon -->
                    <button id="visualSettingsBtn" onclick="openVisualSettingsModal()" class="settings-gear-btn" title="Advanced Visual Controls">
                        <span class="gear-icon">âš™ï¸</span>
                        <span class="settings-text">Settings</span>
                    </button>
                </div>
                
                <div class="video-container" id="videoContainer">
                    <div class="video-placeholder">
                        <div class="loading" id="loadingIndicator" style="display: none;"></div>
                        <p id="videoStatus">Click "Start Camera" to begin emotion detection</p>
                    </div>
                    <div id="videoStreamContainer" style="position: relative; display: none;">
                        <img id="videoFeed" style="display: block; width: 100%; height: auto;" />
                        <canvas id="overlayCanvas" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;"></canvas>
                    </div>
                </div>
                
                <div id="errorDisplay"></div>
                
                <!-- Image Processing Controls -->
                <div class="image-processing-controls" style="margin: 20px 0; padding: 15px; background: rgba(255, 255, 255, 0.1); border-radius: 12px; backdrop-filter: blur(10px);">
                    <h4 style="color: var(--color-accent); margin-bottom: 15px;">ðŸ“¸ Advanced Image Processing</h4>
                    
                    <!-- Mode Toggle -->
                    <div style="margin-bottom: 20px; display: flex; align-items: center; justify-content: center; gap: 15px; padding: 10px; background: rgba(0, 0, 0, 0.2); border-radius: 8px;">
                        <span style="color: #fff; font-weight: 500;">Processing Mode:</span>
                        <label class="toggle-switch" style="position: relative; display: inline-block; width: 60px; height: 30px;">
                            <input type="checkbox" id="processingModeToggle" onchange="toggleProcessingMode()" style="opacity: 0; width: 0; height: 0;">
                            <span class="toggle-slider" style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(45deg, #8b5cf6, #06b6d4); border-radius: 30px; transition: 0.4s;">
                                <span style="position: absolute; content: ''; height: 22px; width: 22px; left: 4px; bottom: 4px; background: white; border-radius: 50%; transition: 0.4s; transform: translateX(0);"></span>
                            </span>
                        </label>
                        <div style="display: flex; flex-direction: column; align-items: center;">
                            <span id="modeLabel" style="color: var(--color-accent); font-weight: bold; font-size: 14px;">ðŸ“Š IVP Mode</span>
                            <span id="modeDescription" style="color: #ccc; font-size: 12px;">Image Processing Techniques</span>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-bottom: 15px;">
                        <button onclick="captureAndProcess('edges')" class="btn-primary" style="background: linear-gradient(45deg, #8b5cf6, #06b6d4);">
                            ðŸ” Edge Detection
                        </button>
                        <button onclick="captureAndProcess('color')" class="btn-primary" style="background: linear-gradient(45deg, #10b981, #3b82f6);">
                            ðŸŽ¨ Color Analysis
                        </button>
                        <button onclick="captureAndProcess('face')" class="btn-primary" style="background: linear-gradient(45deg, #f59e0b, #ef4444);">
                            ðŸ‘¤ Face Analysis
                        </button>
                        <button onclick="captureAndProcess('full')" class="btn-primary" style="background: linear-gradient(45deg, #6366f1, #8b5cf6);">
                            ðŸ”¬ Complete Analysis
                        </button>
                    </div>
                    <div id="imageProcessingResults" style="display: none; margin-top: 15px;"></div>
                </div>
                
                <!-- Emotion Display -->
                <div id="emotionDisplay" class="emotion-display" style="display: none;">
                    <h4>Current Emotions</h4>
                    <div id="emotionContent">
                        <p style="text-align: center; color: #666;">No emotions detected</p>
                    </div>
                    <div id="emotionLoading" class="loading" style="display: none;"></div>
                </div>
                
                <!-- Stable Emotion Display -->
                <div id="stableEmotion" class="emotion-display stable-emotion" style="display: none;">
                    <h4>Stable Emotion</h4>
                </div>
                
                <!-- Service Status -->
                <div class="service-status">
                    <h4>Face Service Status</h4>
                    <div id="emotionStatus">Checking face microservice status...</div>
                    <div id="serviceStatus">Loading...</div>
                </div>
                
                <!-- Enhanced Advanced Analytics Panel -->
                <div class="emotion-insights-panel" style="margin-top: 20px; background: rgba(40, 40, 40, 0.6); border-radius: 12px; padding: 20px; border: 1px solid rgba(100, 100, 255, 0.2);">
                    <h4 style="color: #4fd1c7; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                        <span>ðŸ“Š</span> Advanced Session Analytics
                    </h4>
                    
                    <!-- Primary Stats Grid -->
                    <div class="insights-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-bottom: 15px;">
                        <!-- Total Readings -->
                        <div class="insight-card" style="background: rgba(255, 255, 255, 0.05); border-radius: 8px; padding: 12px; text-align: center;">
                            <div style="color: #60a5fa; font-size: 0.8rem; margin-bottom: 4px;">Total Readings</div>
                            <div id="totalReadings" style="font-size: 1.3rem; font-weight: 600; color: #4fd1c7;">0</div>
                        </div>
                        
                        <!-- Average Confidence -->
                        <div class="insight-card" style="background: rgba(255, 255, 255, 0.05); border-radius: 8px; padding: 12px; text-align: center;">
                            <div style="color: #60a5fa; font-size: 0.8rem; margin-bottom: 4px;">Avg Confidence</div>
                            <div id="avgConfidence" style="font-size: 1.3rem; font-weight: 600; color: #22c55e;">--</div>
                        </div>
                        
                        <!-- Session Time -->
                        <div class="insight-card" style="background: rgba(255, 255, 255, 0.05); border-radius: 8px; padding: 12px; text-align: center;">
                            <div style="color: #60a5fa; font-size: 0.8rem; margin-bottom: 4px;">Session Time</div>
                            <div id="sessionTime" style="font-size: 1.3rem; font-weight: 600; color: #fbbf24;">00:00</div>
                        </div>
                        
                        <!-- Processing FPS -->
                        <div class="insight-card" style="background: rgba(255, 255, 255, 0.05); border-radius: 8px; padding: 12px; text-align: center;">
                            <div style="color: #60a5fa; font-size: 0.8rem; margin-bottom: 4px;">Processing FPS</div>
                            <div id="processingFPS" style="font-size: 1.3rem; font-weight: 600; color: #a855f7;">--</div>
                        </div>
                    </div>
                    
                    <!-- Performance Metrics -->
                    <div class="performance-section" style="margin-bottom: 15px;">
                        <h5 style="color: #fbbf24; font-size: 0.9rem; margin-bottom: 10px;">âš¡ Performance Metrics</h5>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div style="background: rgba(255, 255, 255, 0.03); border-radius: 6px; padding: 8px;">
                                <span style="color: #a3a3a3; font-size: 0.8rem;">Active Models:</span>
                                <span id="activeModels" style="color: #4fd1c7; font-weight: 600; margin-left: 5px;">0</span>
                            </div>
                            <div style="background: rgba(255, 255, 255, 0.03); border-radius: 6px; padding: 8px;">
                                <span style="color: #a3a3a3; font-size: 0.8rem;">Total Frames:</span>
                                <span id="totalFrames" style="color: #4fd1c7; font-weight: 600; margin-left: 5px;">0</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Current Detection Status -->
                    <div class="detection-status" style="margin-bottom: 15px; padding: 10px; background: rgba(255, 255, 255, 0.03); border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="color: #60a5fa; font-size: 0.8rem;">Current Emotion</div>
                                <div id="currentEmotion" style="font-size: 1.1rem; font-weight: 600; color: #4fd1c7;">Waiting...</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="color: #60a5fa; font-size: 0.8rem;">Confidence</div>
                                <div id="currentConfidence" style="font-size: 1.1rem; font-weight: 600; color: #22c55e;">--</div>
                            </div>
                        </div>
                        <div id="confidenceBar" style="height: 3px; background: rgba(79, 209, 199, 0.3); border-radius: 2px; margin-top: 8px; overflow: hidden;">
                            <div id="confidenceProgress" style="height: 100%; background: linear-gradient(90deg, #3b82f6, #06b6d4); width: 0%; transition: width 0.3s ease;"></div>
                        </div>
                    </div>
                    
                    <!-- Storage Status -->
                    <div class="storage-status" style="margin-bottom: 15px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span id="storageIndicator" style="color: #22c55e; font-weight: 600;">ðŸ”´ Local</span>
                            <span style="color: #a3a3a3; font-size: 0.8rem;">Storage Status</span>
                            <span id="bufferedReadings" style="color: #4fd1c7; font-size: 0.8rem; margin-left: auto;">0 buffered</span>
                        </div>
                    </div>
                    
                    <!-- Enhanced Quick Actions -->
                    <div class="quick-actions" style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button onclick="togglePrivacyMode()" id="privacyToggle" class="quick-action-btn" style="background: rgba(239, 68, 68, 0.2); color: #ef4444; border: 1px solid #ef4444; border-radius: 6px; padding: 6px 10px; font-size: 0.8rem; cursor: pointer; transition: all 0.3s ease;">
                            ðŸ”’ Privacy
                        </button>
                        <button onclick="exportSessionData()" class="quick-action-btn" style="background: rgba(34, 197, 94, 0.2); color: #22c55e; border: 1px solid #22c55e; border-radius: 6px; padding: 6px 10px; font-size: 0.8rem; cursor: pointer; transition: all 0.3s ease;">
                            ðŸ’¾ Export
                        </button>
                        <button onclick="takeEmotionSnapshot()" class="quick-action-btn" style="background: rgba(168, 85, 247, 0.2); color: #a855f7; border: 1px solid #a855f7; border-radius: 6px; padding: 6px 10px; font-size: 0.8rem; cursor: pointer; transition: all 0.3s ease;">
                            ðŸ“¸ Snapshot
                        </button>
                        <button onclick="openVisualSettingsModal()" class="quick-action-btn" style="background: rgba(79, 70, 229, 0.2); color: #4f46e5; border: 1px solid #4f46e5; border-radius: 6px; padding: 6px 10px; font-size: 0.8rem; cursor: pointer; transition: all 0.3s ease;">
                            âš™ï¸ Settings
                        </button>
                    </div>
                </div>
            </div>
            
            
            <!-- Text Emotion Section -->
            <div class="text-emotion-section slide-in-right" style="--delay: 0.6s">
                <h2>Text Emotion Analysis</h2>
                
                <div class="chat-container">
                    <div id="chatHistory" class="chat-history">
                        <div style="text-align: center; color: #666; margin: auto; font-style: italic;">
                            ðŸ’¬ Welcome to Y.M.I.R AI Chat<br>
                            <small style="color: #888;">Start a conversation to analyze emotions and get AI responses...</small>
                        </div>
                    </div>
                    
                    <div class="chat-input-container">
                        <input type="text" id="chatInput" placeholder="Type your message here..." 
                               class="chat-input" maxlength="500">
                        <button id="sendMessageBtn" class="send-btn">Send</button>
                    </div>
                </div>
                
                <div id="textEmotionDisplay" class="emotion-display">
                    <h4>Latest Text Emotion</h4>
                    <div id="textEmotionContent">
                        <p style="text-align: center; color: #666;">No text analyzed yet...</p>
                    </div>
                </div>
                
                <div class="text-service-status">
                    <h4>Text Service Status</h4>
                    <div id="textServiceStatus">Checking text microservice status...</div>
                </div>
            </div>
        </div>

        <!-- ðŸŽµ AI Music Discovery System -->
        <div class="music-carousel-container fade-in" style="--delay: 0.8s">
            <!-- AI Music Header -->
            <div class="music-carousel-header">
                <h2 class="ai-music-title" id="musicTitle">Therapeutic Music Recommendations</h2>
                <div class="music-update-status" id="musicUpdateStatus" style="display: none;"></div>
                <div class="ai-badge">
                    <div class="ai-icon"></div>
                    <span>Powered by Neural Emotion Analysis</span>
                </div>
                
                <!-- Status Indicator -->
                <div class="ai-status">
                    <div class="status-indicator">
                        <div class="pulse-dot"></div>
                        <span id="aiStatus">Discovering music based on your emotions...</span>
                    </div>
                </div>
            </div>
            
            <div class="music-carousel">
                <div class="music-track" id="musicTrack">
                    <!-- Initial loading placeholder -->
                    <div class="song-card" style="opacity: 0.7;">
                        <div class="song-info">
                            <div class="song-title">ðŸŽµ</div>
                            <div class="song-artist">â™ª â™« â™ª</div>
                            <div class="song-duration">â™¬</div>
                        </div>
                        <div class="song-controls">
                            <button class="play-btn" disabled>
                                <span class="play-icon">ðŸŽ¶</span>
                            </button>
                            <div class="song-mood">â™©</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Carousel Controls -->
            <div class="carousel-controls">
                <div class="carousel-btn" id="pauseBtn" onclick="toggleCarouselAnimation()">â¸</div>
                <div class="carousel-btn" id="scrollLeftBtn" onclick="scrollCarouselLeft()">â—€</div>
                <div class="carousel-btn" id="scrollRightBtn" onclick="scrollCarouselRight()">â–¶</div>
            </div>
            
            <!-- Scroll Indicator -->
            <div class="scroll-indicator">
                Drag to scroll â€¢ Use controls â€¢ Hover to pause
            </div>
        </div>

        <!-- ðŸ§  ULTIMATE DAILY CHECK-IN EXPERIENCE -->
        <div class="wellness-section card-primary" style="margin: 40px 0; padding: 40px; background: rgba(30, 30, 30, 0.95); backdrop-filter: blur(20px); border-radius: 24px; border: 1px solid rgba(64, 112, 255, 0.3); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 25px rgba(64, 112, 255, 0.2); position: relative; overflow: hidden;">
            
            <!-- Animated Background Effect -->
            <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(45deg, rgba(59, 130, 246, 0.05) 0%, rgba(147, 197, 253, 0.03) 50%, rgba(30, 58, 138, 0.05) 100%); background-size: 400% 400%; animation: holographicBorder 8s ease infinite; pointer-events: none; z-index: 0;"></div>
            
            <div style="position: relative; z-index: 1;">
                <div style="text-align: center; margin-bottom: 40px;">
                    <h2 class="text-gradient" style="background: linear-gradient(135deg, #3b82f6, #60a5fa, #93c5fd); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-size: 2.5rem; font-weight: 800; margin-bottom: 15px; text-shadow: 0 0 30px rgba(59, 130, 246, 0.4);">Daily Emotional Journey</h2>
                    <p style="color: #dbeafe; font-size: 1.1rem; opacity: 0.9;">Track your emotional wellness with AI-powered insights</p>
                </div>

                <!-- ðŸ† STREAK & ACHIEVEMENT BAR -->
                <div id="achievementBar" style="display: flex; justify-content: space-between; align-items: center; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 16px; padding: 20px; margin-bottom: 30px; backdrop-filter: blur(8px);">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div id="streakIndicator" style="display: flex; align-items: center; gap: 8px;">
                            <div style="width: 32px; height: 32px; background: linear-gradient(45deg, #f59e0b, #f97316); border-radius: 50%; display: flex; align-items: center; justify-content: center; animation: aiPulse 2s infinite;">
                                <span style="font-size: 16px;">ðŸ”¥</span>
                            </div>
                            <div>
                                <div style="color: #f59e0b; font-weight: 700; font-size: 1.1rem;"><span id="streakCount">0</span> Day Streak</div>
                                <div style="color: #93c5fd; font-size: 0.9rem;">Keep it going!</div>
                            </div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <div id="weeklyBadge" class="achievement-badge" style="background: rgba(34, 197, 94, 0.2); border: 1px solid #22c55e; border-radius: 20px; padding: 8px 12px; color: #22c55e; font-size: 0.85rem; font-weight: 600;">Weekly Warrior</div>
                        <div id="moodMaster" class="achievement-badge" style="background: rgba(139, 92, 246, 0.2); border: 1px solid #8b5cf6; border-radius: 20px; padding: 8px 12px; color: #8b5cf6; font-size: 0.85rem; font-weight: 600;">Mood Master</div>
                    </div>
                </div>

                <!-- ðŸŽ¯ ENHANCED MOOD CHECK-IN -->
                <div class="mood-check-in" style="margin-bottom: 40px;">
                    <div style="text-align: center; margin-bottom: 25px;">
                        <h3 style="color: #60a5fa; margin-bottom: 10px; font-size: 1.4rem; font-weight: 600;">How are you feeling right now?</h3>
                        <p id="contextualPrompt" style="margin-bottom: 15px; color: #b0b0b0; font-size: 1rem;">Track your emotional journey with us âœ¨</p>
                        
                        <!-- ðŸš€ LAZY USER QUICK ACTIONS -->
                        <div style="display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                            <button id="quickGoodBtn" class="quick-mood-btn" style="background: linear-gradient(45deg, rgba(34, 197, 94, 0.3), rgba(59, 130, 246, 0.3)); border: 1px solid #22c55e; border-radius: 20px; padding: 8px 16px; color: #22c55e; cursor: pointer; transition: all 0.3s ease; font-size: 0.9rem;">
                                âš¡ Just Good Today
                            </button>
                            <button id="quickOkayBtn" class="quick-mood-btn" style="background: linear-gradient(45deg, rgba(251, 146, 60, 0.3), rgba(156, 163, 175, 0.3)); border: 1px solid #fb923c; border-radius: 20px; padding: 8px 16px; color: #fb923c; cursor: pointer; transition: all 0.3s ease; font-size: 0.9rem;">
                                ðŸ˜ Meh, Whatever
                            </button>
                            <button id="skipTodayBtn" class="quick-mood-btn" style="background: rgba(100, 100, 100, 0.2); border: 1px solid #6b7280; border-radius: 20px; padding: 8px 16px; color: #9ca3af; cursor: pointer; transition: all 0.3s ease; font-size: 0.9rem;">
                                â­ï¸ Skip (Keep Streak)
                            </button>
                        </div>
                        
                        <!-- Smart Suggestions -->
                        <div id="smartSuggestions" style="display: none; background: rgba(79, 209, 199, 0.1); border-radius: 12px; padding: 15px; margin-bottom: 20px; border: 1px solid rgba(79, 209, 199, 0.3);">
                            <div style="color: #4fd1c7; font-size: 0.9rem; margin-bottom: 8px;">ðŸ’¡ Based on your patterns:</div>
                            <div id="suggestionText" style="color: #dbeafe; font-size: 0.95rem;"></div>
                            <button id="acceptSuggestionBtn" style="background: #4fd1c7; border: none; border-radius: 8px; color: #1a1a2e; padding: 6px 12px; cursor: pointer; margin-top: 8px; font-size: 0.8rem; font-weight: 600;">
                                âœ¨ Use This
                            </button>
                        </div>
                    </div>
                    
                    <!-- Enhanced Mood Buttons with Animations -->
                    <div class="mood-options" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <button class="mood-btn" data-mood="amazing" data-value="5" style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.2) 0%, rgba(16, 185, 129, 0.3) 100%); border: 2px solid #22c55e; border-radius: 16px; padding: 20px; color: #22c55e; cursor: pointer; transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); display: flex; flex-direction: column; align-items: center; gap: 12px; position: relative; overflow: hidden;">
                            <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(45deg, rgba(34, 197, 94, 0.1), transparent); opacity: 0; transition: opacity 0.3s ease;"></div>
                            <div style="font-size: 32px; transform: scale(1); transition: transform 0.3s ease;">âœ¨</div>
                            <span style="font-weight: 600; font-size: 1rem;">Amazing</span>
                            <span style="font-size: 0.8rem; opacity: 0.8;">Feeling fantastic!</span>
                        </button>
                        
                        <button class="mood-btn" data-mood="great" data-value="4" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.2) 0%, rgba(37, 99, 235, 0.3) 100%); border: 2px solid #3b82f6; border-radius: 16px; padding: 20px; color: #3b82f6; cursor: pointer; transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); display: flex; flex-direction: column; align-items: center; gap: 12px; position: relative; overflow: hidden;">
                            <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(45deg, rgba(59, 130, 246, 0.1), transparent); opacity: 0; transition: opacity 0.3s ease;"></div>
                            <div style="font-size: 32px; transform: scale(1); transition: transform 0.3s ease;">ðŸ˜Š</div>
                            <span style="font-weight: 600; font-size: 1rem;">Great</span>
                            <span style="font-size: 0.8rem; opacity: 0.8;">Really good day</span>
                        </button>
                        
                        <button class="mood-btn" data-mood="good" data-value="3" style="background: linear-gradient(135deg, rgba(156, 163, 175, 0.2) 0%, rgba(107, 114, 128, 0.3) 100%); border: 2px solid #9ca3af; border-radius: 16px; padding: 20px; color: #9ca3af; cursor: pointer; transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); display: flex; flex-direction: column; align-items: center; gap: 12px; position: relative; overflow: hidden;">
                            <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(45deg, rgba(156, 163, 175, 0.1), transparent); opacity: 0; transition: opacity 0.3s ease;"></div>
                            <div style="font-size: 32px; transform: scale(1); transition: transform 0.3s ease;">ðŸ™‚</div>
                            <span style="font-weight: 600; font-size: 1rem;">Good</span>
                            <span style="font-size: 0.8rem; opacity: 0.8;">Pretty decent</span>
                        </button>
                        
                        <button class="mood-btn" data-mood="okay" data-value="2" style="background: linear-gradient(135deg, rgba(251, 146, 60, 0.2) 0%, rgba(245, 158, 11, 0.3) 100%); border: 2px solid #fb923c; border-radius: 16px; padding: 20px; color: #fb923c; cursor: pointer; transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); display: flex; flex-direction: column; align-items: center; gap: 12px; position: relative; overflow: hidden;">
                            <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(45deg, rgba(251, 146, 60, 0.1), transparent); opacity: 0; transition: opacity 0.3s ease;"></div>
                            <div style="font-size: 32px; transform: scale(1); transition: transform 0.3s ease;">ðŸ˜</div>
                            <span style="font-weight: 600; font-size: 1rem;">Okay</span>
                            <span style="font-size: 0.8rem; opacity: 0.8;">Could be better</span>
                        </button>
                        
                        <button class="mood-btn" data-mood="rough" data-value="1" style="background: linear-gradient(135deg, rgba(239, 68, 68, 0.2) 0%, rgba(220, 38, 38, 0.3) 100%); border: 2px solid #ef4444; border-radius: 16px; padding: 20px; color: #ef4444; cursor: pointer; transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); display: flex; flex-direction: column; align-items: center; gap: 12px; position: relative; overflow: hidden;">
                            <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(45deg, rgba(239, 68, 68, 0.1), transparent); opacity: 0; transition: opacity 0.3s ease;"></div>
                            <div style="font-size: 32px; transform: scale(1); transition: transform 0.3s ease;">ðŸ˜”</div>
                            <span style="font-weight: 600; font-size: 1rem;">Rough</span>
                            <span style="font-size: 0.8rem; opacity: 0.8;">Having a tough time</span>
                        </button>
                    </div>

                    <!-- ðŸŽšï¸ ADDITIONAL CONTEXT SLIDERS -->
                    <div id="contextSliders" style="display: none; background: rgba(40, 40, 40, 0.6); border-radius: 16px; padding: 25px; margin-bottom: 30px; border: 1px solid rgba(100, 100, 255, 0.2);">
                        <h4 style="color: #60a5fa; margin-bottom: 20px; text-align: center;">Tell us more about your day</h4>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 25px;">
                            <div class="context-slider">
                                <label style="display: block; color: #93c5fd; font-weight: 500; margin-bottom: 8px;">Energy Level</label>
                                <input type="range" id="energySlider" min="1" max="10" value="5" style="width: 100%; height: 6px; border-radius: 3px; background: rgba(59, 130, 246, 0.3); outline: none;">
                                <div style="display: flex; justify-content: space-between; font-size: 0.8rem; color: #6b7280; margin-top: 5px;">
                                    <span>Drained</span>
                                    <span id="energyValue">5</span>
                                    <span>Energetic</span>
                                </div>
                            </div>
                            
                            <div class="context-slider">
                                <label style="display: block; color: #93c5fd; font-weight: 500; margin-bottom: 8px;">Stress Level</label>
                                <input type="range" id="stressSlider" min="1" max="10" value="5" style="width: 100%; height: 6px; border-radius: 3px; background: rgba(239, 68, 68, 0.3); outline: none;">
                                <div style="display: flex; justify-content: space-between; font-size: 0.8rem; color: #6b7280; margin-top: 5px;">
                                    <span>Relaxed</span>
                                    <span id="stressValue">5</span>
                                    <span>Stressed</span>
                                </div>
                            </div>
                            
                            <div class="context-slider">
                                <label style="display: block; color: #93c5fd; font-weight: 500; margin-bottom: 8px;">Social Connection</label>
                                <input type="range" id="socialSlider" min="1" max="10" value="5" style="width: 100%; height: 6px; border-radius: 3px; background: rgba(34, 197, 94, 0.3); outline: none;">
                                <div style="display: flex; justify-content: space-between; font-size: 0.8rem; color: #6b7280; margin-top: 5px;">
                                    <span>Lonely</span>
                                    <span id="socialValue">5</span>
                                    <span>Connected</span>
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 20px;">
                            <label style="display: block; color: #93c5fd; font-weight: 500; margin-bottom: 8px;">What's on your mind? (Optional)</label>
                            <textarea id="thoughtsInput" placeholder="Share what's been on your mind today..." style="width: 100%; height: 80px; background: rgba(30, 30, 30, 0.8); border: 1px solid rgba(100, 100, 255, 0.2); border-radius: 8px; padding: 12px; color: #f0f0f0; font-family: inherit; resize: vertical;"></textarea>
                        </div>
                        
                        <button id="submitMoodBtn" style="width: 100%; background: linear-gradient(45deg, #3b82f6, #06b6d4); border: none; border-radius: 12px; color: white; padding: 15px; font-weight: 600; font-size: 1.1rem; cursor: pointer; margin-top: 20px; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);">
                            Complete Check-In âœ¨
                        </button>
                    </div>
                </div>

                <div class="mood-history" style="background: rgba(40, 40, 40, 0.5); border-radius: 12px; padding: 20px;">
                    <h4 style="color: #60a5fa; margin-bottom: 15px;">Your Mood History</h4>
                    <div class="view-toggle" style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                        <button id="chartViewBtn" class="view-btn active" style="background: #3b82f6; color: white; border: none; border-radius: 8px; padding: 8px 16px; cursor: pointer;">Chart View</button>
                        <button id="tableViewBtn" class="view-btn" style="background: rgba(59, 130, 246, 0.2); color: #3b82f6; border: 1px solid #3b82f6; border-radius: 8px; padding: 8px 16px; cursor: pointer;">Table View</button>
                        <button id="exportDataBtn" class="action-btn" style="background: rgba(34, 197, 94, 0.2); color: #22c55e; border: 1px solid #22c55e; border-radius: 8px; padding: 8px 16px; cursor: pointer;">Export Data</button>
                        <button id="clearDataBtn" class="action-btn warning" style="background: rgba(239, 68, 68, 0.2); color: #ef4444; border: 1px solid #ef4444; border-radius: 8px; padding: 8px 16px; cursor: pointer;">Clear History</button>
                    </div>
                    <div class="mood-views">
                        <div id="chartView" class="mood-view active">
                            <div class="mood-chart">
                                <div class="mood-placeholder" style="text-align: center; color: #666; padding: 40px;">Track your first mood to see history</div>
                            </div>
                        </div>
                        <div id="tableView" class="mood-view" style="display: none;">
                            <table class="mood-table" style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="border-bottom: 1px solid #4fd1c7;">
                                        <th style="color: #4fd1c7; padding: 10px; text-align: left;">Date</th>
                                        <th style="color: #4fd1c7; padding: 10px; text-align: left;">Time</th>
                                        <th style="color: #4fd1c7; padding: 10px; text-align: left;">Mood</th>
                                        <th style="color: #4fd1c7; padding: 10px; text-align: left;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="moodTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="exercises-section" style="margin-bottom: 40px;">
                <h3 style="color: #60a5fa; margin-bottom: 20px;">Breathing & Meditation Exercises</h3>
                <div class="exercise-cards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
                    <div class="exercise-card" style="background: rgba(40, 40, 40, 0.5); border-radius: 12px; padding: 20px; border: 1px solid rgba(100, 100, 255, 0.2);">
                        <div class="exercise-icon" style="width: 48px; height: 48px; margin-bottom: 15px; color: #4fd1c7;">
                            <svg style="width: 100%; height: 100%; fill: currentColor;" viewBox="0 0 512 512">
                                <path d="M156.7 256H16c-8.8 0-16 7.2-16 16v32c0 8.8 7.2 16 16 16h142.2c15.9 0 30.8 10.9 33.4 26.6 3.3 20-12.1 37.4-31.6 37.4-14.1 0-26.1-9.2-30.4-21.9-2.1-6.3-8.6-10.1-15.2-10.1H81.6c-9.8 0-17.7 8.8-15.9 18.4 8.6 44.1 47.6 77.6 94.2 77.6 57.1 0 102.7-50.1 95.2-108.6C249 291 205.4 256 156.7 256zM16 224h336c59.7 0 106.8-54.8 93.8-116.7-7.6-36.2-36.9-65.5-73.1-73.1-55.4-11.6-105.1 24.9-114.9 75.5-1.9 9.6 6.1 18.3 15.8 18.3h32.8c6.7 0 13.1-3.8 15.2-10.1C325.9 105.2 337.9 96 352 96c19.4 0 34.9 17.4 31.6 37.4-2.6 15.7-17.4 26.6-33.4 26.6H16c-8.8 0-16 7.2-16 16v32c0 8.8 7.2 16 16 16zm384 32H243.7c19.3 16.6 33.2 38.8 39.8 64H400c26.5 0 48 21.5 48 48s-21.5 48-48 48c-17.9 0-33.3-9.9-41.6-24.4-2.9-5-8.7-7.6-14.5-7.6h-33.8c-10.9 0-19 10.8-15.3 21.1 17.8 50.6 70.5 84.8 129.4 72.3 41.2-8.7 75.1-41.6 84.7-82.7C526 321.5 470.5 256 400 256z"/>
                            </svg>
                        </div>
                        <h4 style="color: #60a5fa; margin-bottom: 10px;">4-7-8 Breathing</h4>
                        <p style="color: #b0b0b0; margin-bottom: 15px;">A calming breath exercise for anxiety relief</p>
                        <!-- Default View -->
                        <div id="breathingDefault">
                            <button onclick="startBreathingInCard()" style="background: linear-gradient(45deg, #3b82f6, #60a5fa); color: white; border: none; border-radius: 8px; padding: 12px 24px; cursor: pointer; transition: all 0.3s ease; font-weight: 600; width: 100%;">Start Exercise</button>
                        </div>
                        
                        <!-- Exercise Active View -->
                        <div id="breathingActive" style="display: none; text-align: center; margin-top: 10px;">
                            <div style="position: relative; margin: 15px 0;">
                                <div id="breathingCircle" style="width: 80px; height: 80px; margin: 0 auto; border-radius: 50%; background: linear-gradient(135deg, #4fd1c7, #3b82f6); box-shadow: 0 0 20px rgba(79, 209, 199, 0.6); transition: transform 4s ease-in-out; display: flex; align-items: center; justify-content: center;">
                                    <span id="breathingText" style="color: white; font-weight: 600; font-size: 0.8rem;">Ready</span>
                                </div>
                            </div>
                            <div id="breathingInstructions" style="color: #e2e8f0; margin: 10px 0; font-size: 0.85rem; min-height: 30px;">Get ready to breathe</div>
                            <div id="breathingTimer" style="color: #4fd1c7; font-size: 1.2rem; font-weight: bold; margin: 8px 0;">04:00</div>
                            <div style="display: flex; gap: 8px; justify-content: center; margin: 10px 0;">
                                <button id="startBreathingBtn" onclick="startBreathingSession()" style="background: #10b981; color: white; border: none; border-radius: 6px; padding: 6px 12px; cursor: pointer; font-size: 0.8rem;">Start</button>
                                <button id="pauseBreathingBtn" onclick="pauseBreathingSession()" style="display: none; background: #f59e0b; color: white; border: none; border-radius: 6px; padding: 6px 12px; cursor: pointer; font-size: 0.8rem;">Pause</button>
                                <button onclick="stopBreathingSession()" style="background: #ef4444; color: white; border: none; border-radius: 6px; padding: 6px 12px; cursor: pointer; font-size: 0.8rem;">Stop</button>
                            </div>
                            <div style="width: 100%; height: 3px; background: rgba(255, 255, 255, 0.1); border-radius: 2px; margin-top: 10px;">
                                <div id="breathingProgress" style="height: 100%; background: linear-gradient(90deg, #4fd1c7, #3b82f6); width: 0%; transition: width 0.3s ease; border-radius: 2px;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="exercise-card" style="background: rgba(40, 40, 40, 0.5); border-radius: 12px; padding: 20px; border: 1px solid rgba(100, 100, 255, 0.2);">
                        <div class="exercise-icon" style="width: 48px; height: 48px; margin-bottom: 15px; color: #4fd1c7;">
                            <svg style="width: 100%; height: 100%; fill: currentColor;" viewBox="0 0 512 512">
                                <path d="M360.6 60.94a10.43 10.43 0 0 0 14.76 0l21.57-21.56a10.43 10.43 0 0 0 0-14.76L375.35 3.06c-4.08-4.07-10.68-4.07-14.76 0l-21.57 21.56a10.43 10.43 0 0 0 0 14.76l21.58 21.56zM412.11 192c-26.69 0-51.77 10.39-70.64 29.25l-24.25 24.25c-6.78 6.77-15.78 10.5-25.38 10.5H245c10.54-22.1 14.17-48.11 7.73-75.23-10.1-42.55-46.36-76.11-89.52-83.19-36.15-5.93-70.9 5.04-96.01 28.78-7.36 6.96-6.97 18.85 1.12 24.93l26.15 19.63c5.72 4.3 13.66 4.32 19.2-.21 8.45-6.9 19.02-10.71 30.27-10.71 26.47 0 48.01 21.53 48.01 48s-21.54 48-48.01 48h-31.9c-11.96 0-19.74 12.58-14.39 23.28l16.09 32.17c2.53 5.06 7.6 8.1 13.17 8.55h33.03c35.3 0 64.01 28.7 64.01 64s-28.71 64-64.01 64c-96.02 0-122.35-54.02-145.15-92.03-4.53-7.55-14.77-3.58-14.79 5.22C-.09 416 41.13 512 159.94 512c70.59 0 128.02-57.42 128.02-128 0-23.42-6.78-45.1-17.81-64h21.69c26.69 0 51.77-10.39 70.64-29.25l24.25-24.25c6.78-6.77 15.78-10.5 25.38-10.5 19.78 0 35.88 16.09 35.88 35.88V392c0 13.23-18.77 24-32.01 24-39.4 0-66.67-24.24-81.82-42.89-4.77-5.87-14.2-2.54-14.2 5.02V416s0 64 96.02 64c48.54 0 96.02-39.47 96.02-88V291.88c0-55.08-44.8-99.88-99.89-99.88zm42.18-124.73c-85.55 65.12-169.05 2.75-172.58.05-6.02-4.62-14.44-4.38-20.14.55-5.74 4.92-7.27 13.17-3.66 19.8 1.61 2.95 40.37 72.34 118.8 72.34 79.92 0 98.78-31.36 101.75-37.66 1.02-2.12 1.53-4.47 1.53-6.83V80c0-13.22-15.14-20.69-25.7-12.73z"/>
                            </svg>
                        </div>
                        <h4 style="color: #60a5fa; margin-bottom: 10px;">5-Minute Meditation</h4>
                        <p style="color: #b0b0b0; margin-bottom: 15px;">Quick mindfulness for stress reduction</p>
                        <!-- Default View -->
                        <div id="meditationDefault">
                            <button onclick="startMeditationInCard()" style="background: linear-gradient(45deg, #8b5cf6, #a78bfa); color: white; border: none; border-radius: 8px; padding: 12px 24px; cursor: pointer; transition: all 0.3s ease; font-weight: 600; width: 100%;">Start Exercise</button>
                        </div>
                        
                        <!-- Exercise Active View -->
                        <div id="meditationActive" style="display: none; text-align: center; margin-top: 10px;">
                            <div style="position: relative; margin: 15px 0; width: 80px; height: 80px; margin: 0 auto;">
                                <div class="meditation-center" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(45deg, #8b5cf6, #a78bfa);"></div>
                                <div class="meditation-ring1" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 60px; height: 60px; border-radius: 50%; border: 2px solid rgba(139, 92, 246, 0.4);"></div>
                                <div class="meditation-ring2" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 80px; height: 80px; border-radius: 50%; border: 1px solid rgba(139, 92, 246, 0.2);"></div>
                            </div>
                            <div id="meditationInstructions" style="color: #e2e8f0; margin: 10px 0; font-size: 0.85rem; min-height: 30px;">Focus on your breath</div>
                            <div id="meditationTimer" style="color: #8b5cf6; font-size: 1.2rem; font-weight: bold; margin: 8px 0;">05:00</div>
                            <div style="display: flex; gap: 8px; justify-content: center; margin: 10px 0;">
                                <button id="startMeditationBtn" onclick="startMeditationSession()" style="background: #10b981; color: white; border: none; border-radius: 6px; padding: 6px 12px; cursor: pointer; font-size: 0.8rem;">Start</button>
                                <button id="pauseMeditationBtn" onclick="pauseMeditationSession()" style="display: none; background: #f59e0b; color: white; border: none; border-radius: 6px; padding: 6px 12px; cursor: pointer; font-size: 0.8rem;">Pause</button>
                                <button onclick="stopMeditationSession()" style="background: #ef4444; color: white; border: none; border-radius: 6px; padding: 6px 12px; cursor: pointer; font-size: 0.8rem;">Stop</button>
                            </div>
                            <div style="width: 100%; height: 3px; background: rgba(255, 255, 255, 0.1); border-radius: 2px; margin-top: 10px;">
                                <div id="meditationProgress" style="height: 100%; background: linear-gradient(90deg, #8b5cf6, #a78bfa); width: 0%; transition: width 0.3s ease; border-radius: 2px;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="exercise-card" style="background: rgba(40, 40, 40, 0.5); border-radius: 12px; padding: 20px; border: 1px solid rgba(100, 100, 255, 0.2);">
                        <div class="exercise-icon" style="width: 48px; height: 48px; margin-bottom: 15px; color: #4fd1c7;">
                            <svg style="width: 100%; height: 100%; fill: currentColor;" viewBox="0 0 512 512">
                                <path d="M462.3 62.6C407.5 15.9 326 24.3 275.7 76.2L256 96.5l-19.7-20.3C186.1 24.3 104.5 15.9 49.7 62.6c-62.8 53.6-66.1 149.8-9.9 207.9l193.5 199.8c12.5 12.9 32.8 12.9 45.3 0l193.5-199.8c56.3-58.1 53-154.3-9.8-207.9z"/>
                            </svg>
                        </div>
                        <h4 style="color: #60a5fa; margin-bottom: 10px;">Gratitude Practice</h4>
                        <p style="color: #b0b0b0; margin-bottom: 15px;">Focus on positivity and thankfulness</p>
                        <!-- Default View -->
                        <div id="gratitudeDefault">
                            <button onclick="startGratitudeInCard()" style="background: linear-gradient(45deg, #10b981, #34d399); color: white; border: none; border-radius: 8px; padding: 12px 24px; cursor: pointer; transition: all 0.3s ease; font-weight: 600; width: 100%;">Start Exercise</button>
                        </div>
                        
                        <!-- Exercise Active View -->
                        <div id="gratitudeActive" style="display: none; text-align: center; margin-top: 10px;">
                            <div style="position: relative; margin: 15px 0;">
                                <div class="gratitude-hearts" style="color: #f87171; font-size: 2rem; animation: gratitudeFloat 4s ease-in-out infinite;">â™¥</div>
                            </div>
                            <div id="gratitudeInstructions" style="color: #e2e8f0; margin: 10px 0; font-size: 0.85rem; min-height: 30px;">Think of what you're grateful for</div>
                            <div id="gratitudeTimer" style="color: #10b981; font-size: 1.2rem; font-weight: bold; margin: 8px 0;">03:00</div>
                            <div style="display: flex; gap: 8px; justify-content: center; margin: 10px 0;">
                                <button id="startGratitudeBtn" onclick="startGratitudeSession()" style="background: #10b981; color: white; border: none; border-radius: 6px; padding: 6px 12px; cursor: pointer; font-size: 0.8rem;">Start</button>
                                <button id="pauseGratitudeBtn" onclick="pauseGratitudeSession()" style="display: none; background: #f59e0b; color: white; border: none; border-radius: 6px; padding: 6px 12px; cursor: pointer; font-size: 0.8rem;">Pause</button>
                                <button onclick="stopGratitudeSession()" style="background: #ef4444; color: white; border: none; border-radius: 6px; padding: 6px 12px; cursor: pointer; font-size: 0.8rem;">Stop</button>
                            </div>
                            <div style="width: 100%; height: 3px; background: rgba(255, 255, 255, 0.1); border-radius: 2px; margin-top: 10px;">
                                <div id="gratitudeProgress" style="height: 100%; background: linear-gradient(90deg, #10b981, #34d399); width: 0%; transition: width 0.3s ease; border-radius: 2px;"></div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
            
            <div class="help-resources">
                <h3 style="color: #60a5fa; margin-bottom: 20px;">Professional Help Resources</h3>
                <p style="color: #b0b0b0; margin-bottom: 20px;">If you're experiencing persistent negative emotions, consider reaching out for professional support.</p>
                <div class="resources-list" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                    <div class="resource-item" style="background: rgba(40, 40, 40, 0.5); border-radius: 12px; padding: 20px; border: 1px solid rgba(100, 100, 255, 0.2); display: flex; align-items: center; gap: 15px;">
                        <svg style="width: 32px; height: 32px; fill: #ef4444; flex-shrink: 0;" viewBox="0 0 512 512">
                            <path d="M497.39 361.8l-112-48a24 24 0 0 0-28 6.9l-49.6 60.6A370.66 370.66 0 0 1 130.6 204.11l60.6-49.6a23.94 23.94 0 0 0 6.9-28l-48-112A24.16 24.16 0 0 0 122.6.61l-104 24A24 24 0 0 0 0 48c0 256.5 207.9 464 464 464a24 24 0 0 0 23.4-18.6l24-104a24.29 24.29 0 0 0-14.01-27.6z"/>
                        </svg>
                        <div class="resource-info" style="flex-grow: 1;">
                            <h4 style="color: #60a5fa; margin-bottom: 5px;">Crisis Helpline</h4>
                            <p style="color: #b0b0b0; margin: 0;">24/7 Support: 988</p>
                        </div>
                        <a href="tel:988" class="resource-btn" style="background: #ef4444; color: white; border: none; border-radius: 8px; padding: 8px 16px; text-decoration: none; cursor: pointer;">Call Now</a>
                    </div>
                    <div class="resource-item" style="background: rgba(40, 40, 40, 0.5); border-radius: 12px; padding: 20px; border: 1px solid rgba(100, 100, 255, 0.2); display: flex; align-items: center; gap: 15px;">
                        <svg style="width: 32px; height: 32px; fill: #3b82f6; flex-shrink: 0;" viewBox="0 0 576 512">
                            <path d="M416 192c0-88.4-93.1-160-208-160S0 103.6 0 192c0 34.3 14.1 65.9 38 92-13.4 30.2-35.5 54.2-35.8 54.5-2.2 2.3-2.8 5.7-1.5 8.7S4.8 352 8 352c36.6 0 66.9-12.3 88.7-25 32.2 15.7 70.3 25 111.3 25 114.9 0 208-71.6 208-160zm122 220c23.9-26 38-57.7 38-92 0-66.9-53.5-124.2-129.3-148.1.9 6.6 1.3 13.3 1.3 20.1 0 105.9-107.7 192-240 192-10.8 0-21.3-.8-31.7-1.9C207.8 439.6 281.8 480 368 480c41 0 79.1-9.2 111.3-25 21.8 12.7 52.1 25 88.7 25 3.2 0 6.1-1.9 7.3-4.8 1.3-2.9.7-6.3-1.5-8.7-.3-.3-22.4-24.2-35.8-54.5z"/>
                        </svg>
                        <div class="resource-info" style="flex-grow: 1;">
                            <h4 style="color: #60a5fa; margin-bottom: 5px;">Text Crisis Line</h4>
                            <p style="color: #b0b0b0; margin: 0;">Text HOME to 741741</p>
                        </div>
                        <a href="sms:741741?body=HOME" class="resource-btn" style="background: #3b82f6; color: white; border: none; border-radius: 8px; padding: 8px 16px; text-decoration: none; cursor: pointer;">Text Now</a>
                    </div>
                    <div class="resource-item" style="background: rgba(40, 40, 40, 0.5); border-radius: 12px; padding: 20px; border: 1px solid rgba(100, 100, 255, 0.2); display: flex; align-items: center; gap: 15px;">
                        <svg style="width: 32px; height: 32px; fill: #22c55e; flex-shrink: 0;" viewBox="0 0 448 512">
                            <path d="M224 256c70.7 0 128-57.3 128-128S294.7 0 224 0 96 57.3 96 128s57.3 128 128 128zM104 424c0 13.3 10.7 24 24 24s24-10.7 24-24-10.7-24-24-24-24 10.7-24 24zm216-135.4v49c36.5 7.4 64 39.8 64 78.4v41.7c0 7.6-5.4 14.2-12.9 15.7l-32.2 6.4c-4.3.9-8.5-1.9-9.4-6.3l-3.1-15.7c-.9-4.3 1.9-8.6 6.3-9.4l19.3-3.9V416c0-62.8-96-65.1-96 1.9v26.7l19.3 3.9c4.3.9 7.1 5.1 6.3 9.4l-3.1 15.7c-.9 4.3-5.1 7.1-9.4 6.3l-31.2-4.2c-7.9-1.1-13.8-7.8-13.8-15.9V416c0-38.6 27.5-70.9 64-78.4v-45.2c-2.2.7-4.4 1.1-6.6 1.9-18 6.3-37.3 9.8-57.4 9.8s-39.4-3.5-57.4-9.8c-7.4-2.6-14.9-4.2-22.6-5.2v81.6c23.1 6.9 40 28.1 40 53.4 0 30.9-25.1 56-56 56s-56-25.1-56-56c0-25.3 16.9-46.5 40-53.4v-80.4C48.5 301 0 355.8 0 422.4v44.8C0 491.9 20.1 512 44.8 512h358.4c24.7 0 44.8-20.1 44.8-44.8v-44.8c0-72-56.8-130.3-128-133.8z"/>
                        </svg>
                        <div class="resource-info" style="flex-grow: 1;">
                            <h4 style="color: #60a5fa; margin-bottom: 5px;">Find a Therapist</h4>
                            <p style="color: #b0b0b0; margin: 0;">Search for mental health professionals</p>
                        </div>
                        <button id="findTherapistBtn" class="resource-btn" style="background: #22c55e; color: white; border: none; border-radius: 8px; padding: 8px 16px; cursor: pointer;" onclick="window.open('/therapist_finder', '_blank')">Search</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Global state
        let isRunning = false;
        let emotionUpdateInterval = null;
        let statusUpdateInterval = null;
        
        // DOM elements
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const videoFeed = document.getElementById('videoFeed');
        const videoStatus = document.getElementById('videoStatus');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const errorDisplay = document.getElementById('errorDisplay');
        const emotionDisplay = document.getElementById('emotionDisplay');
        const emotionStatus = document.getElementById('emotionStatus');
        const emotionLoading = document.getElementById('emotionLoading');
        const stableEmotion = document.getElementById('stableEmotion');
        const serviceStatus = document.getElementById('serviceStatus');
        
        // API functions
        async function apiCall(endpoint, method = 'GET', body = null) {
            try {
                const options = {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                    }
                };
                
                // Add Firebase auth token if user is authenticated
                console.log('ðŸ” Auth Debug - window.ymirAuth:', !!window.ymirAuth);
                console.log('ðŸ” Auth Debug - currentUser:', window.ymirAuth?.currentUser);
                console.log('ðŸ” Auth Debug - getUserStatus:', window.ymirAuth?.getUserStatus?.());
                
                if (window.ymirAuth && window.ymirAuth.currentUser) {
                    try {
                        const token = await window.ymirAuth.currentUser.getIdToken();
                        options.headers['Authorization'] = `Bearer ${token}`;
                        console.log('ðŸ” Added auth token to API call:', token.substring(0, 50) + '...');
                    } catch (e) {
                        console.warn('Failed to get auth token:', e);
                    }
                } else {
                    console.warn('âŒ No auth available - window.ymirAuth:', !!window.ymirAuth, 'currentUser:', !!window.ymirAuth?.currentUser);
                }
                
                if (body) {
                    options.body = JSON.stringify(body);
                }
                
                const response = await fetch(endpoint, options);
                return await response.json();
            } catch (error) {
                return { success: false, error: error.message };
            }
        }
        
        // Camera control functions
        async function startCamera() {
            showLoading(true);
            clearError();
            
            try {
                console.log('ðŸŽ¥ Starting camera...');
                const result = await apiCall('/api/camera/start', 'POST');
                
                if (result.success) {
                    console.log('âœ… Camera start request successful');
                    
                    // Wait a moment for camera to initialize
                    showStatus('Camera initializing...', 'info');
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    
                    // Verify camera is actually running
                    const statusCheck = await apiCall('/api/camera/status', 'GET');
                    console.log('ðŸ” Camera status check:', statusCheck);
                    
                    if (statusCheck.running) {
                        isRunning = true;
                        startBtn.disabled = true;
                        stopBtn.disabled = false;
                        
                        // Start insights tracking
                        startInsightsTracking();
                        
                        // Start video feed with retry logic
                        await setupVideoFeed();
                        
                        // Show video container with overlay
                        const videoPlaceholder = document.querySelector('.video-placeholder');
                        const videoStreamContainer = document.getElementById('videoStreamContainer');
                        
                        videoPlaceholder.style.display = 'none';
                        videoStreamContainer.style.display = 'block';
                        
                        // Initialize canvas overlay
                        setupCanvasOverlay();
                        
                        // Start emotion updates
                        startEmotionUpdates();
                        
                        showStatus('Camera started successfully!', 'success');
                    } else {
                        throw new Error('Camera did not start properly - status check failed');
                    }
                } else {
                    throw new Error(result.error || result.message || 'Unknown camera start error');
                }
            } catch (error) {
                console.error('âŒ Camera start error:', error);
                showError('Failed to start camera: ' + error.message);
                
                // Reset button states
                isRunning = false;
                startBtn.disabled = false;
                stopBtn.disabled = true;
            }
            
            showLoading(false);
        }
        
        // Helper function to setup video feed with retry logic
        async function setupVideoFeed() {
            const maxRetries = 3;
            for (let i = 0; i < maxRetries; i++) {
                try {
                    console.log(`ðŸŽ¥ Setting up video feed (attempt ${i + 1}/${maxRetries})`);
                    
                    // Test if video feed is available
                    const testResponse = await fetch('/api/video_feed', { method: 'HEAD' });
                    if (testResponse.ok) {
                        videoFeed.src = '/api/video_feed?' + new Date().getTime();
                        console.log('âœ… Video feed URL set successfully');
                        return;
                    } else {
                        throw new Error(`Video feed not available (status: ${testResponse.status})`);
                    }
                } catch (error) {
                    console.warn(`âš ï¸ Video feed setup attempt ${i + 1} failed:`, error.message);
                    if (i < maxRetries - 1) {
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    } else {
                        throw new Error('Video feed setup failed after ' + maxRetries + ' attempts');
                    }
                }
            }
        }
        
        async function stopCamera() {
            showLoading(true);
            
            const result = await apiCall('/api/camera/stop', 'POST');
            
            if (result.success) {
                isRunning = false;
                startBtn.disabled = false;
                stopBtn.disabled = true;
                
                // Stop high-performance video loop
                stopHighPerformanceVideoLoop();
                
                // Stop video feed and hide overlay
                const videoFeed = document.getElementById('videoFeed');
                const videoPlaceholder = document.querySelector('.video-placeholder');
                const videoStreamContainer = document.getElementById('videoStreamContainer');
                
                if (videoFeed) {
                    videoFeed.src = '';
                }
                
                if (videoStreamContainer) {
                    videoStreamContainer.style.display = 'none';
                }
                
                if (videoPlaceholder) {
                    videoPlaceholder.style.display = 'block';
                }
                
                // Clear canvas overlay
                const overlayCanvas = document.getElementById('overlayCanvas');
                if (overlayCanvas) {
                    const ctx = overlayCanvas.getContext('2d');
                    ctx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
                }
                
                const videoStatus = document.getElementById('videoStatus');
                if (videoStatus) {
                    videoStatus.style.display = 'block';
                    videoStatus.textContent = 'Camera stopped';
                }
                
                // Stop emotion updates
                stopEmotionUpdates();
                
                // Stop overlay updates
                stopOverlayUpdates();
                
                showStatus('Camera stopped successfully!', 'success');
            } else {
                showError('Failed to stop camera: ' + (result.error || result.message));
            }
            
            showLoading(false);
        }
        
        // Emotion monitoring - DISABLED (music carousel handles emotions)
        function startEmotionUpdates() {
            emotionLoading.style.display = 'none';
            emotionStatus.textContent = 'Emotions handled by music carousel';
            
            // REMOVED: Duplicate emotion calls - music carousel handles this
            console.log('ðŸ’¡ Emotion monitoring disabled - music carousel handles emotion detection');
        }
        
        function stopEmotionUpdates() {
            if (emotionUpdateInterval) {
                clearInterval(emotionUpdateInterval);
                emotionUpdateInterval = null;
            }
            
            emotionLoading.style.display = 'none';
            emotionStatus.textContent = 'Emotion analysis stopped';
            emotionDisplay.innerHTML = '<p style="text-align: center; color: #666;">Emotion analysis stopped</p>';
            stableEmotion.style.display = 'none';
        }
        
        // =================== MEDIAPIPE VISUAL OVERLAYS ===================
        
        let overlayUpdateInterval = null;
        
        function setupCanvasOverlay() {
            const videoFeed = document.getElementById('videoFeed');
            const overlayCanvas = document.getElementById('overlayCanvas');
            
            if (!videoFeed || !overlayCanvas) return;
            
            // Resize canvas to match video when video loads
            videoFeed.addEventListener('loadedmetadata', () => {
                updateCanvasSize();
            });
            
            // Start drawing overlays
            startOverlayUpdates();
        }
        
        function updateCanvasSize() {
            const videoFeed = document.getElementById('videoFeed');
            const overlayCanvas = document.getElementById('overlayCanvas');
            
            if (videoFeed && overlayCanvas) {
                overlayCanvas.width = videoFeed.offsetWidth;
                overlayCanvas.height = videoFeed.offsetHeight;
            }
        }
        
        function startOverlayUpdates() {
            // Update overlays every 100ms for smooth rendering
            overlayUpdateInterval = setInterval(async () => {
                await updateMediaPipeOverlays();
            }, 100);
        }
        
        function stopOverlayUpdates() {
            if (overlayUpdateInterval) {
                clearInterval(overlayUpdateInterval);
                overlayUpdateInterval = null;
            }
        }
        
        async function updateMediaPipeOverlays() {
            try {
                // Fetch landmarks from backend
                const response = await fetch('/api/mediapipe/landmarks');
                if (!response.ok) return;
                
                const data = await response.json();
                if (!data.success) return;
                
                // Clear and redraw overlays
                const overlayCanvas = document.getElementById('overlayCanvas');
                const ctx = overlayCanvas.getContext('2d');
                
                // Clear previous frame
                ctx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
                
                // Draw enabled features
                if (currentVisualSettings.show_face_mesh && data.face_landmarks) {
                    drawFaceMesh(ctx, data.face_landmarks, overlayCanvas.width, overlayCanvas.height);
                }
                
                if (currentVisualSettings.show_body_pose && data.pose_landmarks) {
                    drawBodyPose(ctx, data.pose_landmarks, overlayCanvas.width, overlayCanvas.height);
                }
                
                if (currentVisualSettings.show_hand_tracking && data.hand_landmarks) {
                    drawHandTracking(ctx, data.hand_landmarks, overlayCanvas.width, overlayCanvas.height);
                }
                
                if (currentVisualSettings.show_gaze_tracking && data.gaze_landmarks) {
                    drawGazeTracking(ctx, data.gaze_landmarks, overlayCanvas.width, overlayCanvas.height);
                }
                
            } catch (error) {
                console.log('MediaPipe overlay update failed:', error);
            }
        }
        
        function drawFaceMesh(ctx, landmarks, canvasWidth, canvasHeight) {
            ctx.strokeStyle = '#00FF00';
            ctx.lineWidth = 1;
            ctx.fillStyle = '#00FF00';
            
            // Draw face contour landmarks
            landmarks.forEach((landmark, index) => {
                const x = landmark.x * canvasWidth;
                const y = landmark.y * canvasHeight;
                
                // Draw landmark points
                ctx.beginPath();
                ctx.arc(x, y, 1, 0, 2 * Math.PI);
                ctx.fill();
            });
            
            // Draw face mesh connections (simplified)
            ctx.beginPath();
            for (let i = 0; i < landmarks.length - 1; i++) {
                const current = landmarks[i];
                const next = landmarks[i + 1];
                
                ctx.moveTo(current.x * canvasWidth, current.y * canvasHeight);
                ctx.lineTo(next.x * canvasWidth, next.y * canvasHeight);
            }
            ctx.stroke();
        }
        
        function drawBodyPose(ctx, landmarks, canvasWidth, canvasHeight) {
            ctx.strokeStyle = '#FF0000';
            ctx.lineWidth = 2;
            ctx.fillStyle = '#FF0000';
            
            // Draw pose landmarks
            landmarks.forEach((landmark, index) => {
                const x = landmark.x * canvasWidth;
                const y = landmark.y * canvasHeight;
                
                if (landmark.visibility > 0.5) {
                    ctx.beginPath();
                    ctx.arc(x, y, 3, 0, 2 * Math.PI);
                    ctx.fill();
                }
            });
            
            // Draw pose connections
            const connections = [
                [11, 12], [11, 13], [13, 15], [12, 14], [14, 16], // Arms
                [11, 23], [12, 24], [23, 24], // Torso
                [23, 25], [24, 26], [25, 27], [26, 28], // Legs
                [0, 1], [1, 2], [2, 3], [3, 7], // Face outline
            ];
            
            ctx.beginPath();
            connections.forEach(([startIdx, endIdx]) => {
                if (landmarks[startIdx] && landmarks[endIdx] && 
                    landmarks[startIdx].visibility > 0.5 && landmarks[endIdx].visibility > 0.5) {
                    const start = landmarks[startIdx];
                    const end = landmarks[endIdx];
                    
                    ctx.moveTo(start.x * canvasWidth, start.y * canvasHeight);
                    ctx.lineTo(end.x * canvasWidth, end.y * canvasHeight);
                }
            });
            ctx.stroke();
        }
        
        function drawHandTracking(ctx, handLandmarks, canvasWidth, canvasHeight) {
            ctx.strokeStyle = '#0000FF';
            ctx.lineWidth = 2;
            ctx.fillStyle = '#0000FF';
            
            handLandmarks.forEach(hand => {
                // Draw hand landmarks
                hand.landmarks.forEach((landmark, index) => {
                    const x = landmark.x * canvasWidth;
                    const y = landmark.y * canvasHeight;
                    
                    ctx.beginPath();
                    ctx.arc(x, y, 2, 0, 2 * Math.PI);
                    ctx.fill();
                });
                
                // Draw hand connections
                const handConnections = [
                    [0, 1], [1, 2], [2, 3], [3, 4], // Thumb
                    [0, 5], [5, 6], [6, 7], [7, 8], // Index
                    [0, 9], [9, 10], [10, 11], [11, 12], // Middle
                    [0, 13], [13, 14], [14, 15], [15, 16], // Ring
                    [0, 17], [17, 18], [18, 19], [19, 20], // Pinky
                    [5, 9], [9, 13], [13, 17] // Palm
                ];
                
                ctx.beginPath();
                handConnections.forEach(([startIdx, endIdx]) => {
                    if (hand.landmarks[startIdx] && hand.landmarks[endIdx]) {
                        const start = hand.landmarks[startIdx];
                        const end = hand.landmarks[endIdx];
                        
                        ctx.moveTo(start.x * canvasWidth, start.y * canvasHeight);
                        ctx.lineTo(end.x * canvasWidth, end.y * canvasHeight);
                    }
                });
                ctx.stroke();
            });
        }
        
        function drawGazeTracking(ctx, gazeLandmarks, canvasWidth, canvasHeight) {
            ctx.strokeStyle = '#FFFF00';
            ctx.lineWidth = 2;
            ctx.fillStyle = '#FFFF00';
            
            if (gazeLandmarks.left_eye && gazeLandmarks.right_eye) {
                // Draw eye centers
                const leftEye = gazeLandmarks.left_eye;
                const rightEye = gazeLandmarks.right_eye;
                
                ctx.beginPath();
                ctx.arc(leftEye.x * canvasWidth, leftEye.y * canvasHeight, 3, 0, 2 * Math.PI);
                ctx.fill();
                
                ctx.beginPath();
                ctx.arc(rightEye.x * canvasWidth, rightEye.y * canvasHeight, 3, 0, 2 * Math.PI);
                ctx.fill();
                
                // Draw gaze direction
                if (gazeLandmarks.gaze_direction) {
                    const gazeDir = gazeLandmarks.gaze_direction;
                    const eyeCenter = {
                        x: (leftEye.x + rightEye.x) / 2 * canvasWidth,
                        y: (leftEye.y + rightEye.y) / 2 * canvasHeight
                    };
                    
                    ctx.beginPath();
                    ctx.moveTo(eyeCenter.x, eyeCenter.y);
                    ctx.lineTo(
                        eyeCenter.x + gazeDir.x * 50,
                        eyeCenter.y + gazeDir.y * 50
                    );
                    ctx.stroke();
                    
                    // Draw arrow head
                    const arrowLength = 10;
                    const arrowAngle = Math.PI / 6;
                    const angle = Math.atan2(gazeDir.y, gazeDir.x);
                    
                    ctx.beginPath();
                    ctx.moveTo(
                        eyeCenter.x + gazeDir.x * 50,
                        eyeCenter.y + gazeDir.y * 50
                    );
                    ctx.lineTo(
                        eyeCenter.x + gazeDir.x * 50 - arrowLength * Math.cos(angle - arrowAngle),
                        eyeCenter.y + gazeDir.y * 50 - arrowLength * Math.sin(angle - arrowAngle)
                    );
                    ctx.moveTo(
                        eyeCenter.x + gazeDir.x * 50,
                        eyeCenter.y + gazeDir.y * 50
                    );
                    ctx.lineTo(
                        eyeCenter.x + gazeDir.x * 50 - arrowLength * Math.cos(angle + arrowAngle),
                        eyeCenter.y + gazeDir.y * 50 - arrowLength * Math.sin(angle + arrowAngle)
                    );
                    ctx.stroke();
                }
            }
        }
        
        // Add window resize handler to update canvas size
        window.addEventListener('resize', updateCanvasSize);
        
        // =================== END MEDIAPIPE OVERLAYS ===================
        
        function updateEmotionDisplay(data) {
            if (data.error) {
                emotionStatus.textContent = 'Error: ' + data.error;
                return;
            }
            
            emotionLoading.style.display = 'none';
            
            
            // Display current emotions
            if (data.current_emotions && Object.keys(data.current_emotions).length > 0) {
                let html = '<h4>Current Emotions</h4>';
                
                // Sort emotions by confidence
                const sortedEmotions = Object.entries(data.current_emotions)
                    .sort(([,a], [,b]) => b - a);
                
                for (const [emotion, confidence] of sortedEmotions) {
                    const percentage = (confidence * 100).toFixed(1);
                    html += `
                        <div class="emotion-item">
                            <span class="emotion-label">${emotion}</span>
                            <span class="emotion-value">${percentage}%</span>
                        </div>
                    `;
                }
                
                emotionDisplay.innerHTML = html;
            } else {
                emotionDisplay.innerHTML = '<p style="text-align: center; color: #666;">No emotions detected</p>';
            }
            
            // Display stable emotion
            if (data.stable_emotion) {
                const stable = data.stable_emotion;
                const confidence = (stable.confidence * 100).toFixed(1);
                
                stableEmotion.innerHTML = `
                    <h4>Stable Emotion</h4>
                    <div class="emotion-item">
                        <span class="emotion-label">${stable.emotion}</span>
                        <span class="emotion-value">${confidence}%</span>
                    </div>
                    <small>Last updated: ${new Date(stable.timestamp).toLocaleTimeString()}</small>
                `;
                stableEmotion.style.display = 'block';
            } else {
                stableEmotion.style.display = 'none';
            }
        }
        
        // Status monitoring - Global function
        window.refreshStatus = async function() {
            try {
                console.log('ðŸ”„ Refreshing dashboard status...');
                
                // Show loading indicator (with fallback)
                if (typeof showAdvancedNotification === 'function') {
                    showAdvancedNotification('ðŸ”„ Refreshing dashboard...', 'info', 2000);
                } else {
                    console.log('ðŸ”„ Refreshing dashboard...');
                }
                
                // Refresh all microservice statuses
                const faceStatus = await apiCall('/api/face_status');
                const textStatus = await apiCall('/api/text_status');
                
                // Update service displays
                updateServiceStatus(faceStatus);
                if (typeof updateTextServiceStatus === 'function') {
                    updateTextServiceStatus(textStatus);
                }
                
                // Refresh emotion data if camera is running
                if (faceStatus.running && isRunning) {
                    await updateEmotionDisplay();
                }
                
                // Refresh music recommendations (with safety check)
                try {
                    if (window.musicRecommendations && window.musicRecommendations.length > 0) {
                        await updateMusicRecommendations();
                    } else {
                        console.log('ðŸŽµ No music recommendations to refresh');
                    }
                } catch (error) {
                    console.log('ðŸŽµ Music recommendations not available:', error.message);
                }
                
                if (typeof showAdvancedNotification === 'function') {
                    showAdvancedNotification('âœ… Dashboard refreshed successfully!', 'success', 3000);
                } else {
                    console.log('âœ… Dashboard refreshed successfully!');
                }
                
            } catch (error) {
                console.error('âŒ Refresh failed:', error);
                if (typeof showAdvancedNotification === 'function') {
                    showAdvancedNotification('âŒ Failed to refresh dashboard', 'error', 3000);
                } else {
                    console.log('âŒ Failed to refresh dashboard');
                }
            }
        }
        
        function updateServiceStatus(status) {
            if (status.error) {
                serviceStatus.innerHTML = `<span style="color: #ef4444;">Error: ${status.error}</span>`;
                return;
            }
            
            const running = status.running ? 'ðŸŸ¢' : 'ðŸ”´';
            const detector = status.detector_loaded ? 'ðŸŸ¢' : 'ðŸ”´';
            
            serviceStatus.innerHTML = `
                Camera: ${running} ${status.running ? 'Running' : 'Stopped'}<br>
                Detector: ${detector} ${status.detector_loaded ? 'Loaded' : 'Not loaded'}<br>
                Session: ${status.session_id}<br>
                Readings: ${status.analytics?.total_readings || 0}
            `;
        }
        
        // UI helpers
        function showLoading(show) {
            loadingIndicator.style.display = show ? 'inline-block' : 'none';
        }
        
        function showError(message) {
            errorDisplay.innerHTML = `<div class="error-message">${message}</div>`;
        }
        
        function clearError() {
            errorDisplay.innerHTML = '';
        }
        
        function showStatus(message, type) {
            console.log(`${type}: ${message}`);
        }
        
        // Text Emotion Analysis Functions
        const chatInput = document.getElementById('chatInput');
        const sendMessageBtn = document.getElementById('sendMessageBtn');
        const analyzeTextBtn = document.getElementById('analyzeTextBtn');
        const chatHistory = document.getElementById('chatHistory');
        const textEmotionContent = document.getElementById('textEmotionContent');
        const textServiceStatus = document.getElementById('textServiceStatus');
        
        async function analyzeText() {
            const text = chatInput.value.trim();
            if (!text) return;
            
            showLoading(true);
            
            try {
                const result = await apiCall('/api/text/analyze', 'POST', { text: text, is_user: true });
                
                if (result.success) {
                    displayTextEmotion(result.message);
                    addChatMessage(text, result.message.emotion_analysis, 'user');
                    chatInput.value = '';
                } else {
                    showError('Text analysis failed: ' + result.error);
                }
            } catch (error) {
                showError('Error analyzing text: ' + error.message);
            }
            
            showLoading(false);
        }
        
        async function sendChatMessage() {
            const message = chatInput.value.trim();
            if (!message) return;
            
            // âš¡ PREVENT SPAM: Disable button immediately
            sendMessageBtn.disabled = true;
            sendMessageBtn.textContent = 'Sending...';
            chatInput.disabled = true;
            
            showLoading(true);
            
            try {
                const sessionId = generateSessionId(); // Get current session ID
                const result = await apiCall('/api/text/chat', 'POST', { 
                    message: message,
                    session_id: sessionId 
                });
                
                if (result.success) {
                    // Add user message
                    if (result.user_message && result.user_message.emotion_analysis) {
                        displayTextEmotion(result.user_message);
                        addChatMessage(result.user_message.content, result.user_message.emotion_analysis, 'user');
                    }
                    
                    // Add bot response
                    if (result.assistant_message) {
                        setTimeout(() => {
                            addChatMessage(result.assistant_message.content, null, 'bot');
                        }, 500);
                    }
                    
                    chatInput.value = '';
                } else {
                    showError('Chat failed: ' + result.error);
                }
            } catch (error) {
                showError('Error sending message: ' + error.message);
            }
            
            // âš¡ RE-ENABLE: After 1 second to prevent spam
            setTimeout(() => {
                sendMessageBtn.disabled = false;
                sendMessageBtn.textContent = 'Send';
                chatInput.disabled = false;
                chatInput.focus();
                showLoading(false);
            }, 1000);
        }
        
        function displayTextEmotion(message) {
            if (!message.emotion_analysis) {
                textEmotionContent.innerHTML = '<p style="color: #666;">No emotion analysis available</p>';
                return;
            }
            
            const emotion = message.emotion_analysis;
            const emotionEmojis = {
                'happy': 'ðŸ˜Š', 'sad': 'ðŸ˜¢', 'angry': 'ðŸ˜¡', 'fear': 'ðŸ˜°',
                'surprise': 'ðŸ˜®', 'disgust': 'ðŸ¤¢', 'neutral': 'ðŸ˜'
            };
            
            const emoji = emotionEmojis[emotion.dominant_emotion] || 'ðŸ˜';
            
            textEmotionContent.innerHTML = `
                <div class="emotion-item">
                    <span>${emoji} <strong>${emotion.dominant_emotion.toUpperCase()}</strong></span>
                    <span>${(emotion.confidence * 100).toFixed(1)}%</span>
                </div>
                <div style="margin-top: 10px; font-size: 0.9rem; color: #888;">
                    Method: ${emotion.method || 'instant'} | Processing: âš¡ Instant
                </div>
                <div style="margin-top: 8px;">
                    ${emotion.all_emotions ? Object.entries(emotion.all_emotions)
                        .sort(([,a], [,b]) => b - a)
                        .slice(0, 3)
                        .map(([em, score]) => `<span style="font-size: 0.8rem; margin-right: 10px;">${em}: ${(score * 100).toFixed(1)}%</span>`)
                        .join('') : 'Processing...'}
                </div>
            `;
        }
        
        function addChatMessage(text, emotionAnalysis, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${type}`;
            
            let emotionInfo = '';
            if (emotionAnalysis) {
                const emotion = emotionAnalysis.dominant_emotion;
                const confidence = (emotionAnalysis.confidence * 100).toFixed(1);
                const emoji = {
                    'happy': 'ðŸ˜Š', 'sad': 'ðŸ˜¢', 'angry': 'ðŸ˜¡', 'fear': 'ðŸ˜°',
                    'surprise': 'ðŸ˜®', 'disgust': 'ðŸ¤¢', 'neutral': 'ðŸ˜'
                }[emotion] || 'ðŸ˜';
                
                emotionInfo = `<div class="chat-message-emotion">${emoji} ${emotion} (${confidence}%)</div>`;
            }
            
            messageDiv.innerHTML = `
                <div>${text}</div>
                ${emotionInfo}
            `;
            
            // Clear placeholder if it exists
            if (chatHistory.children.length === 1 && chatHistory.firstElementChild.tagName === 'P') {
                chatHistory.innerHTML = '';
            }
            
            chatHistory.appendChild(messageDiv);
            
            // Smooth auto-scroll to bottom with animation
            setTimeout(() => {
                chatHistory.scrollTo({
                    top: chatHistory.scrollHeight,
                    behavior: 'smooth'
                });
            }, 100);
        }
        
        async function refreshTextStatus() {
            try {
                const status = await apiCall('/api/text_status');
                
                if (status.error) {
                    textServiceStatus.innerHTML = `<span style="color: #ef4444;">Error: ${status.error}</span>`;
                } else {
                    textServiceStatus.innerHTML = `
                        Status: ${status.running ? 'ðŸŸ¢ Running' : 'ðŸ”´ Stopped'}<br>
                        Models: ${status.models_loaded} loaded<br>
                        Conversation: ${status.conversation_length} messages<br>
                        Methods: ${status.available_methods ? status.available_methods.join(', ') : 'None'}
                    `;
                }
            } catch (error) {
                textServiceStatus.innerHTML = `<span style="color: #ef4444;">Connection error</span>`;
            }
        }
        
        // Event listeners for text emotion
        sendMessageBtn.addEventListener('click', sendChatMessage);
        
        chatInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendChatMessage();
            }
        });
        
        // ðŸŽ›ï¸ Advanced Visual Settings Management
        let currentVisualSettings = {
            show_face_mesh: true,
            show_body_pose: true,
            show_hand_tracking: true,
            show_gaze_tracking: true,
            show_object_detection: true,
            show_emotion_context: true,
            confidence_threshold: 0.25,
            video_quality: '720p',
            analysis_interval: 30,
            show_quality_indicators: true,
            show_fps_display: false
        };

        // Visual Settings Modal Functions
        function openVisualSettingsModal() {
            const modal = document.getElementById('visualSettingsModal');
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        function closeVisualSettingsModal() {
            const modal = document.getElementById('visualSettingsModal');
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        function updateConfidenceValue() {
            const value = document.getElementById('confidence_threshold').value;
            document.getElementById('confidence_value').textContent = value;
        }

        // Close modal when clicking outside
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('visualSettingsModal');
            if (event.target === modal) {
                closeVisualSettingsModal();
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const modal = document.getElementById('visualSettingsModal');
                if (modal && modal.style.display === 'flex') {
                    closeVisualSettingsModal();
                }
            }
        });

        // Emotion Insights Panel Functions
        let sessionStartTime = null;
        let emotionDetectionCount = 0;
        let insightsUpdateInterval = null;

        function startInsightsTracking() {
            sessionStartTime = new Date();
            emotionDetectionCount = 0;
            
            // Update session time every second
            insightsUpdateInterval = setInterval(updateSessionTime, 1000);
        }

        function updateSessionTime() {
            if (!sessionStartTime) return;
            
            const now = new Date();
            const elapsed = Math.floor((now - sessionStartTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            
            const timeDisplay = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('sessionTime').textContent = timeDisplay;
        }

        function updateEmotionInsights(emotion, confidence) {
            try {
                // Update confidence level and bar with null checks
                const confidencePercent = Math.round(confidence * 100);
                
                const confidenceLevelEl = document.getElementById('confidenceLevel');
                if (confidenceLevelEl) {
                    confidenceLevelEl.textContent = `${confidencePercent}%`;
                    
                    // Color code confidence level
                    if (confidence >= 0.8) {
                        confidenceLevelEl.style.color = '#22c55e'; // Green
                    } else if (confidence >= 0.6) {
                        confidenceLevelEl.style.color = '#fbbf24'; // Yellow
                    } else {
                        confidenceLevelEl.style.color = '#ef4444'; // Red
                    }
                }
                
                const confidenceProgressEl = document.getElementById('confidenceProgress');
                if (confidenceProgressEl) {
                    confidenceProgressEl.style.width = `${confidencePercent}%`;
                }
                
                // Update emotion count
                emotionDetectionCount++;
                const emotionCountEl = document.getElementById('emotionCount');
                if (emotionCountEl) {
                    emotionCountEl.textContent = emotionDetectionCount;
                }
                
                // Also call the advanced analytics update if available
                if (typeof updateAdvancedInsights === 'function') {
                    updateAdvancedInsights(emotion, confidence);
                }
                
            } catch (error) {
                console.warn('âš ï¸ updateEmotionInsights error:', error.message);
                // Continue execution without breaking the app
            }
        }

        function exportEmotionData() {
            // Simple export function - you can enhance this
            const sessionData = {
                sessionStart: sessionStartTime,
                sessionDuration: sessionStartTime ? Math.floor((new Date() - sessionStartTime) / 1000) : 0,
                emotionCount: emotionDetectionCount,
                timestamp: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(sessionData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `emotion_session_${new Date().toISOString().slice(0,10)}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showNotification('Emotion data exported successfully!', 'success');
        }

        function takeEmotionSnapshot() {
            // Take a snapshot of current emotion state
            const currentEmotion = document.querySelector('#emotionContent')?.textContent || 'No emotion detected';
            const confidence = document.getElementById('confidenceLevel')?.textContent || '--';
            
            const snapshot = {
                timestamp: new Date().toISOString(),
                emotion: currentEmotion,
                confidence: confidence,
                sessionTime: document.getElementById('sessionTime')?.textContent || '00:00'
            };
            
            console.log('ðŸ“¸ Emotion Snapshot:', snapshot);
            showNotification(`Snapshot captured: ${currentEmotion} (${confidence})`, 'info');
        }

        function showNotification(message, type = 'info') {
            // Simple notification system
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? 'rgba(34, 197, 94, 0.9)' : type === 'error' ? 'rgba(239, 68, 68, 0.9)' : 'rgba(59, 130, 246, 0.9)'};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                z-index: 10000;
                font-weight: 500;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                backdrop-filter: blur(8px);
                transform: translateX(100%);
                transition: transform 0.3s ease;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Slide in
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 100);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        async function updateVisualSettings() {
            // Get all settings from UI
            currentVisualSettings = {
                show_face_mesh: document.getElementById('toggle_face_mesh').checked,
                show_body_pose: document.getElementById('toggle_body_pose').checked,
                show_hand_tracking: document.getElementById('toggle_hand_tracking').checked,
                show_gaze_tracking: document.getElementById('toggle_gaze_tracking').checked,
                show_object_detection: document.getElementById('toggle_object_detection').checked,
                show_emotion_context: document.getElementById('toggle_emotion_context').checked,
                confidence_threshold: parseFloat(document.getElementById('confidence_threshold').value),
                video_quality: document.getElementById('video_quality').value,
                analysis_interval: parseInt(document.getElementById('analysis_interval').value),
                show_quality_indicators: document.getElementById('toggle_quality_indicators').checked,
                show_fps_display: document.getElementById('toggle_fps_display').checked
            };

            // Update confidence display
            document.getElementById('confidence_value').textContent = currentVisualSettings.confidence_threshold;

            // Send settings to microservice
            try {
                const response = await fetch('/api/camera/settings', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(currentVisualSettings)
                });
                
                if (response.ok) {
                    console.log('âœ… Visual settings updated');
                } else {
                    console.warn('âš ï¸ Failed to update visual settings');
                }
            } catch (error) {
                console.error('âŒ Error updating visual settings:', error);
            }
        }

        // ðŸ“¹ HIGH PERFORMANCE Video Feed Management  
        let videoFeedInterval = null;
        let lastFrameTime = 0;
        const TARGET_FPS = 60; // Target 60 FPS
        const MIN_FRAME_INTERVAL = 1000 / TARGET_FPS; // ~16ms for 60 FPS

        function optimizeVideoFeed() {
            const video = document.getElementById('videoFeed');
            if (!video) return;

            // High performance frame timing
            const now = performance.now(); // More precise than Date.now()
            if (now - lastFrameTime < MIN_FRAME_INTERVAL) return; // Rate limiting for 60 FPS
            
            lastFrameTime = now;
            
            // Update video quality based on settings
            const quality = currentVisualSettings.video_quality;
            let qualityParam = '';
            switch(quality) {
                case '480p': qualityParam = '&quality=480'; break;
                case '720p': qualityParam = '&quality=720'; break;
                case '1080p': qualityParam = '&quality=1080'; break;
            }
            
            // Use timestamp for cache busting, but less frequent quality changes
            video.src = `/api/video_feed?t=${Math.floor(now)}${qualityParam}`;
        }

        // ðŸš€ 60 FPS Video Stream using requestAnimationFrame
        let animationFrameId = null;
        let isVideoRunning = false;

        function startHighPerformanceVideoLoop() {
            if (isVideoRunning) return;
            isVideoRunning = true;
            
            function videoLoop() {
                if (!isVideoRunning) return;
                
                optimizeVideoFeed();
                animationFrameId = requestAnimationFrame(videoLoop);
            }
            
            videoLoop();
        }

        function stopHighPerformanceVideoLoop() {
            isVideoRunning = false;
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            }
        }

        // Enhanced camera start with optimization
        async function startCameraOptimized() {
            showLoading(true);
            clearError();
            
            try {
                // Apply visual settings before starting
                await updateVisualSettings();
                
                // ðŸŽ¯ CRITICAL: Sync session ID with face microservice BEFORE starting camera
                const sessionId = generateSessionId();
                console.log(`ðŸ”— Syncing session ID with face microservice: ${sessionId}`);
                
                try {
                    const sessionSyncResult = await fetch('http://localhost:5002/api/session', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ session_id: sessionId })
                    });
                    
                    if (sessionSyncResult.ok) {
                        const syncData = await sessionSyncResult.json();
                        console.log('âœ… Face session ID synchronized:', syncData);
                    } else {
                        console.warn('âš ï¸ Failed to sync session ID, continuing anyway');
                    }
                } catch (syncError) {
                    console.warn('âš ï¸ Face session sync failed:', syncError.message);
                }
                
                // ðŸŽ¯ ALSO sync session ID with text microservice
                try {
                    const textSessionSyncResult = await fetch('http://localhost:5003/api/session', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ session_id: sessionId })
                    });
                    
                    if (textSessionSyncResult.ok) {
                        const textSyncData = await textSessionSyncResult.json();
                        console.log('âœ… Text session ID synchronized:', textSyncData);
                    } else {
                        console.warn('âš ï¸ Failed to sync text session ID, continuing anyway');
                    }
                } catch (textSyncError) {
                    console.warn('âš ï¸ Text session sync failed:', textSyncError.message);
                }
                
                // Start camera with optimizations
                const result = await apiCall('/api/camera/start', 'POST');
                
                if (result.success) {
                    showStatus('Camera started successfully', 'success');
                    document.getElementById('startBtn').disabled = true;
                    document.getElementById('stopBtn').disabled = false;
                    
                    // Start optimized video feed
                    setTimeout(() => {
                        const videoContainer = document.getElementById('videoContainer');
                        videoContainer.innerHTML = `
                            <img id="videoFeed" 
                                 src="/api/video_feed?${Date.now()}" 
                                 alt="Video Feed"
                                 style="width: 100%; height: auto; border-radius: 8px;"
                                 onload="this.style.opacity=1"
                                 onerror="handleVideoError(this)"
                                 onabort="handleVideoError(this)">
                        `;
                        
                        // Start 60 FPS high-performance video loop
                        startHighPerformanceVideoLoop();
                    }, 1000);
                    
                    startEmotionUpdates();
                } else {
                    showError(result.message || 'Failed to start camera');
                }
            } catch (error) {
                showError('Camera start error: ' + error.message);
            }
            
            showLoading(false);
        }

        function handleVideoError(img) {
            console.warn('ðŸ“¹ Video feed error, retrying...');
            setTimeout(() => {
                if (img && img.parentNode) {
                    img.src = `/api/video_feed?${Date.now()}`;
                }
            }, 1000);
        }

        // Replace original startCamera with optimized version
        window.startCamera = startCameraOptimized;

        // ðŸŽ¯ Processing Mode Toggle System
        let isEmotionMode = false; // false = IVP Mode, true = Emotion Mode
        
        function toggleProcessingMode() {
            const toggle = document.getElementById('processingModeToggle');
            const modeLabel = document.getElementById('modeLabel');
            const modeDescription = document.getElementById('modeDescription');
            const slider = document.querySelector('.toggle-slider span');
            
            isEmotionMode = toggle.checked;
            
            if (isEmotionMode) {
                // Emotion Mode
                modeLabel.textContent = 'ðŸŽ­ Emotion Mode';
                modeDescription.textContent = 'AI Emotion Detection';
                slider.style.transform = 'translateX(30px)';
                document.querySelector('.toggle-slider').style.background = 'linear-gradient(45deg, #f59e0b, #ef4444)';
            } else {
                // IVP Mode  
                modeLabel.textContent = 'ðŸ“Š IVP Mode';
                modeDescription.textContent = 'Image Processing Techniques';
                slider.style.transform = 'translateX(0)';
                document.querySelector('.toggle-slider').style.background = 'linear-gradient(45deg, #8b5cf6, #06b6d4)';
            }
            
            console.log(`ðŸ”„ Switched to: ${isEmotionMode ? 'Emotion' : 'IVP'} Mode`);
        }

        // ðŸ“¸ Image Processing Integration Functions
        async function captureAndProcess(analysisType) {
            try {
                // Check processing mode and route accordingly
                if (isEmotionMode) {
                    // Route to emotion detection
                    await processEmotionAnalysis(analysisType);
                } else {
                    // Route to IVP processing
                    await processIVPAnalysis(analysisType);
                }
            } catch (error) {
                console.error('Error in processing:', error);
                showError('Processing failed: ' + error.message);
            }
        }

        // ðŸ“Š IVP Analysis Function
        async function processIVPAnalysis(analysisType) {
            try {
                // Get current frame from video feed
                const videoFeed = document.getElementById('videoFeed');
                if (!videoFeed || !videoFeed.src) {
                    showError('Please start the camera first!');
                    return;
                }

                // Create canvas to capture current frame
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // Wait for image to load and capture it
                const img = new Image();
                img.crossOrigin = 'anonymous';
                img.onload = async function() {
                    // Limit canvas size to prevent huge uploads (max 640x480)
                    const maxWidth = 640;
                    const maxHeight = 480;
                    
                    let { width, height } = img;
                    if (width > maxWidth || height > maxHeight) {
                        const aspectRatio = width / height;
                        if (width > height) {
                            width = maxWidth;
                            height = width / aspectRatio;
                        } else {
                            height = maxHeight;
                            width = height * aspectRatio;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Convert to base64 with JPEG compression (much smaller than PNG)
                    const imageData = canvas.toDataURL('image/jpeg', 0.8); // 80% quality
                    
                    // Process the image
                    await processImageData(imageData, analysisType);
                };
                
                // Use current video feed URL
                img.src = videoFeed.src;
                
            } catch (error) {
                console.error('Error capturing frame:', error);
                showError('Error capturing image: ' + error.message);
            }
        }

        async function processImageData(imageData, analysisType) {
            try {
                showImageProcessingLoading(true);
                
                const formData = new FormData();
                formData.append('image', imageData);
                formData.append('edge_method', 'canny');
                formData.append('color_model', 'HSV');
                formData.append('analysis_type', analysisType);

                // Use microservice endpoint which handles camera frames directly
                const response = await fetch('http://localhost:5002/api/process_image', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                displayImageProcessingResults(result, analysisType);

            } catch (error) {
                console.error('Error processing image:', error);
                showError('Image processing failed: ' + error.message);
            } finally {
                showImageProcessingLoading(false);
            }
        }

        // ðŸŽ­ Emotion Analysis Function
        async function processEmotionAnalysis(analysisType) {
            try {
                showImageProcessingLoading(true);
                
                // Enable analysis mode on microservice
                const analysisResponse = await fetch('http://localhost:5002/api/enable_analysis', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enable: true, analysis_type: analysisType })
                });
                
                if (!analysisResponse.ok) {
                    throw new Error(`Failed to enable analysis: ${analysisResponse.status}`);
                }
                
                // Wait a moment for analysis to process
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Get current emotion data
                const emotionResponse = await fetch('http://localhost:5002/api/emotions');
                if (!emotionResponse.ok) {
                    throw new Error(`Failed to get emotions: ${emotionResponse.status}`);
                }
                
                const emotionData = await emotionResponse.json();
                console.log('ðŸŽ­ Emotion analysis result:', emotionData);
                
                // Display emotion results
                displayEmotionResults(emotionData, analysisType);
                
            } catch (error) {
                console.error('Error in emotion analysis:', error);
                showError('Emotion analysis failed: ' + error.message);
            } finally {
                showImageProcessingLoading(false);
            }
        }

        function displayEmotionResults(result, analysisType) {
            const resultsContainer = document.getElementById('imageProcessingResults');
            resultsContainer.style.display = 'block';
            
            let resultsHTML = `
                <h5 style="color: var(--color-accent); margin-bottom: 10px;">
                    ðŸŽ­ ${analysisType.charAt(0).toUpperCase() + analysisType.slice(1)} Emotion Analysis
                </h5>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
            `;

            if (result.emotions && Object.keys(result.emotions).length > 0) {
                for (const [faceId, emotion] of Object.entries(result.emotions)) {
                    const dominant = emotion.dominant || emotion.emotions;
                    const confidence = emotion.confidence || 0;
                    
                    resultsHTML += `
                        <div style="background: rgba(255, 255, 255, 0.1); border-radius: 8px; padding: 15px; backdrop-filter: blur(5px);">
                            <h6 style="color: var(--color-accent); margin-bottom: 10px;">ðŸ‘¤ Face ${faceId}</h6>
                            <div style="color: #fff; margin-bottom: 8px;">
                                <strong>Emotion:</strong> ${dominant}
                            </div>
                            <div style="color: #ccc; margin-bottom: 8px;">
                                <strong>Confidence:</strong> ${(confidence * 100).toFixed(1)}%
                            </div>
                            <div style="background: rgba(0, 0, 0, 0.3); border-radius: 4px; padding: 8px;">
                                <div style="font-size: 12px; color: #aaa;">Quality: ${emotion.quality || 'N/A'}</div>
                            </div>
                        </div>
                    `;
                }
            } else {
                resultsHTML += `
                    <div style="background: rgba(255, 255, 255, 0.1); border-radius: 8px; padding: 20px; text-align: center;">
                        <h6 style="color: #ff6b6b;">ðŸ˜” No emotions detected</h6>
                        <p style="color: #ccc; margin: 0;">Make sure your face is visible to the camera</p>
                    </div>
                `;
            }

            resultsHTML += '</div>';
            resultsContainer.innerHTML = resultsHTML;
        }

        function displayImageProcessingResults(result, analysisType) {
            const resultsContainer = document.getElementById('imageProcessingResults');
            resultsContainer.style.display = 'block';
            
            let resultsHTML = `
                <h5 style="color: var(--color-accent); margin-bottom: 10px;">
                    ðŸ“Š ${analysisType.charAt(0).toUpperCase() + analysisType.slice(1)} Analysis Results
                </h5>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
            `;

            // Display results based on analysis type
            if (result.enhanced && analysisType === 'full') {
                resultsHTML += createImageResult('Enhanced Image', result.enhanced, 'Enhanced facial features and contrast');
            }
            
            if (result.edges && (analysisType === 'edges' || analysisType === 'full')) {
                resultsHTML += createImageResult('Edge Detection', result.edges, 'Detected edges for emotion analysis');
            }
            
            if (result.hsv && (analysisType === 'color' || analysisType === 'full')) {
                resultsHTML += createImageResult('HSV Color Analysis', result.hsv, 'Hue, saturation, value representation');
            }
            
            if (result.face_detected && (analysisType === 'face' || analysisType === 'full')) {
                resultsHTML += createImageResult('Face Detection', result.face_detected, 'Viola-Jones face detection results');
            }

            resultsHTML += '</div>';
            
            // Add processing info
            if (result.processing_info) {
                const info = result.processing_info;
                resultsHTML += `
                    <div style="margin-top: 15px; padding: 10px; background: rgba(59, 130, 246, 0.1); border-radius: 8px;">
                        <strong>Analysis Summary:</strong><br>
                        Faces Detected: ${info.faces_detected} | 
                        Enhancement: ${info.enhancement_applied ? 'Yes' : 'No'} | 
                        Edge Detection: ${info.edge_detection}
                    </div>
                `;
            }

            resultsContainer.innerHTML = resultsHTML;
        }

        function createImageResult(title, imageData, description) {
            return `
                <div style="background: rgba(255, 255, 255, 0.05); border-radius: 8px; padding: 10px;">
                    <h6 style="color: #fff; margin-bottom: 8px;">${title}</h6>
                    <img src="${imageData}" style="width: 100%; height: 150px; object-fit: cover; border-radius: 6px; margin-bottom: 8px;">
                    <p style="color: #ccc; font-size: 12px; margin: 0;">${description}</p>
                </div>
            `;
        }

        function showImageProcessingLoading(show) {
            const buttons = document.querySelectorAll('.image-processing-controls button');
            buttons.forEach(button => {
                button.disabled = show;
                if (show) {
                    button.innerHTML = 'â³ Processing...';
                } else {
                    // Reset button text based on original content
                    if (button.onclick.toString().includes("'edges'")) button.innerHTML = 'ðŸ” Edge Detection';
                    else if (button.onclick.toString().includes("'color'")) button.innerHTML = 'ðŸŽ¨ Color Analysis';
                    else if (button.onclick.toString().includes("'face'")) button.innerHTML = 'ðŸ‘¤ Face Analysis';
                    else if (button.onclick.toString().includes("'full'")) button.innerHTML = 'ðŸ”¬ Complete Analysis';
                }
            });
        }

        // ðŸŽµ AI Music Carousel System - ONLY uses real therapeutic music data from CSV

        // ðŸŽ¯ Session Management for Personalized Music
        let globalSessionId = null; // Global session ID for consistency
        
        function generateSessionId() {
            // Always return the same session ID once generated
            if (globalSessionId) {
                console.log(`ðŸ”„ Using consistent session ID: ${globalSessionId}`);
                return globalSessionId;
            }
            
            // Try to get existing session from localStorage first
            let sessionId = localStorage.getItem('ymir_session_id');
            
            if (!sessionId) {
                // Generate new session ID with timestamp and random component
                const timestamp = Date.now();
                const random = Math.random().toString(36).substring(2, 15);
                sessionId = `ymir_${timestamp}_${random}`;
                
                // Store for future use
                localStorage.setItem('ymir_session_id', sessionId);
                console.log(`ðŸ†• Generated new session ID: ${sessionId}`);
            } else {
                console.log(`ðŸ”„ Using existing session ID: ${sessionId}`);
            }
            
            // Store globally for consistency
            globalSessionId = sessionId;
            return sessionId;
        }

        let currentlyPlaying = null;

        function createSongCard(song, index) {
            return `
                <div class="song-card" onclick="handleSongClick(${index})">
                    <div class="song-info">
                        <div class="song-title" title="${song.title}">${song.title}</div>
                        <div class="song-artist">${song.artist}</div>
                        <div class="song-duration">${song.duration}</div>
                    </div>
                    <div class="song-controls">
                        <button class="play-btn" onclick="playPauseSong(${index}, event)" data-playing="false">
                            <span class="play-icon">â–¶</span>
                        </button>
                        <div class="song-mood">${song.mood}</div>
                    </div>
                </div>
            `;
        }

        async function initializeMusicCarousel(forcedEmotion = null, forcedConfidence = null) {
            const musicTrack = document.getElementById('musicTrack');
            
            try {
                // ðŸŽ¯ VISUAL FEEDBACK: Show updating indicator
                showMusicUpdateIndicator('ðŸ”„ Analyzing your emotions...');
                console.log('ðŸŽµ Loading AI-powered therapeutic music recommendations...');
                
                // ðŸ§  STEP 1: Get real session ID and current emotion
                const sessionId = generateSessionId(); // Generate or get real session ID
                
                let currentEmotion = 'neutral';
                let emotionConfidence = 0.5;
                
                // ðŸŽ¯ FORCED EMOTION: Use provided emotion (from facial detection)
                if (forcedEmotion) {
                    currentEmotion = forcedEmotion;
                    emotionConfidence = forcedConfidence || 0.8; // Default confidence for facial
                    console.log(`ðŸŽ­ USING FORCED EMOTION: ${currentEmotion} (confidence: ${emotionConfidence.toFixed(2)}) - likely from facial detection`);
                } else {
                    console.log('ðŸ” Fetching current emotion from combiner...');
                }
                
                // ðŸŽ¯ ONLY fetch from combiner if we don't have forced emotion
                if (!forcedEmotion) {
                    try {
                        // ðŸŽ¯ Get the REAL emotion from the existing combiner API
                        const emotionResponse = await fetch('/api/combined_emotions');
                        const emotionData = await emotionResponse.json();
                        
                        if (emotionData.success && emotionData.combined_emotion) {
                            currentEmotion = emotionData.combined_emotion.dominant_emotion || 'neutral';
                            emotionConfidence = emotionData.combined_emotion.confidence || 0.5;
                            
                            console.log(`ðŸŽ­ REAL EMOTION: ${currentEmotion} (confidence: ${emotionConfidence.toFixed(2)})`);
                            console.log(`ðŸ”€ Combination method: ${emotionData.combined_emotion.combination_method}`);
                            console.log(`ðŸŽ­ Multi-emotion: ${emotionData.combined_emotion.is_multi_emotion}`);
                        } else {
                            console.log('âš ï¸ No current emotion data - using neutral fallback');
                        }
                    } catch (emotionError) {
                        console.log('âš ï¸ Emotion API error - using neutral fallback:', emotionError);
                    }
                }
                
                // Store current emotion for tracking changes
                window.lastEmotionState = {
                    emotion: currentEmotion,
                    confidence: emotionConfidence,
                    timestamp: Date.now()
                };
                
                // ðŸŽ¯ Update AI status with current emotion (forced or fetched)
                const aiStatus = document.getElementById('aiStatus');
                if (aiStatus) {
                    aiStatus.textContent = `Therapeutic music for ${currentEmotion} mood (${(emotionConfidence*100).toFixed(0)}% confidence)`;
                }
                
                // ðŸš€ STEP 2: Call music API with REAL emotion data
                console.log(`ðŸŽµ Requesting therapeutic music for emotion: ${currentEmotion}`);
                showMusicUpdateIndicator(`ðŸŽ­ Finding ${currentEmotion} music...`);
                const response = await fetch(`/api/music/recommendations?session_id=${sessionId}&emotion=${currentEmotion}&confidence=${emotionConfidence}&limit=100`);
                const data = await response.json();
                
                if (data.success && data.recommendations && data.recommendations.length > 0) {
                    console.log('âœ… AI Therapeutic Music API Success!');
                    console.log(`ðŸŽ­ Input Emotion: ${currentEmotion} (confidence: ${emotionConfidence.toFixed(2)})`);
                    
                    // ðŸŽ¯ VISUAL FEEDBACK: Show successful update
                    showMusicUpdateIndicator(`âœ… Updated for ${currentEmotion}!`, 'success');
                    console.log(`ðŸŽµ Therapeutic Songs: ${data.recommendations.length}`);
                    console.log(`ðŸ¤– Multi-emotion: ${data.emotion?.is_multi_emotion || false}`);
                    console.log(`ðŸ¥ Therapeutic Strategy: AI-powered healing music selection`);
                    
                    // Convert API data to display format
                    const aiSongs = data.recommendations.map(track => ({
                        title: track.track_name,
                        artist: track.artist_name,
                        popularity: track.track_popularity,
                        artist_popularity: track.artist_popularity
                    }));
                    
                    // Store globally for click handlers
                    currentAISongs = aiSongs;
                    
                    // Create continuous carousel with AI songs
                    const allSongs = [...aiSongs, ...aiSongs]; // Duplicate for scrolling
                    musicTrack.innerHTML = allSongs.map((song, index) => createAISongCard(song, index % aiSongs.length)).join('');
                    
                    console.log('ðŸŽµ AI Music carousel loaded with', allSongs.length, 'therapeutic recommendations');
                    
                    // ðŸŽ¯ VISUAL FEEDBACK: Keep static title, emotion shown in aiStatus
                    // updateMusicTitle() removed - title stays "Therapeutic Music Recommendations"
                    flashMusicContainer();
                    setTimeout(() => hideMusicUpdateIndicator(), 3000);
                    
                    // Update emotion display
                    updateEmotionDisplay(data.emotion);
                    
                    // Update emotion insights panel safely
                    if (data.emotion && data.emotion.dominant && data.emotion.confidence) {
                        try {
                            updateEmotionInsights(data.emotion.dominant, data.emotion.confidence);
                        } catch (error) {
                            console.warn('âš ï¸ updateEmotionInsights call failed:', error.message);
                        }
                    }
                    
                } else {
                    console.log(`âš ï¸ AI Music API failed for emotion '${currentEmotion}' - no recommendations available`);
                    showMusicUpdateIndicator(`âŒ No music found for ${currentEmotion}`, 'error');
                    musicTrack.innerHTML = `<div class="song-card" style="opacity: 0.6;"><div class="song-info"><div class="song-title">ðŸŽµ No therapeutic music found</div><div class="song-artist">for ${currentEmotion} mood - please check system</div></div></div>`;
                    setTimeout(() => hideMusicUpdateIndicator(), 5000);
                }
                
            } catch (error) {
                console.error('âŒ AI Therapeutic Music API error:', error);
                showMusicUpdateIndicator('âŒ Music system error', 'error');
                musicTrack.innerHTML = '<div class="song-card" style="opacity: 0.6;"><div class="song-info"><div class="song-title">âš ï¸ Therapeutic Music Error</div><div class="song-artist">Emotion detection may be offline</div></div></div>';
                setTimeout(() => hideMusicUpdateIndicator(), 5000);
            }
        }
        
        // Fallback functionality removed - ONLY AI data is used
        
        function formatDuration(ms) {
            const minutes = Math.floor(ms / 60000);
            const seconds = Math.floor((ms % 60000) / 1000);
            return `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }
        
        function createAISongCard(song, index) {
            // Original dark/blue theme gradients - keeping consistent with your design
            const darkGradients = [
                'linear-gradient(135deg, #1f2937, #374151)',
                'linear-gradient(135deg, #1e3a8a, #1f2937)', 
                'linear-gradient(135deg, #1f2937, #1e3a8a)',
                'linear-gradient(135deg, #374151, #1f2937)',
                'linear-gradient(135deg, #0f172a, #1e3a8a)',
                'linear-gradient(135deg, #1e3a8a, #0f172a)',
                'linear-gradient(135deg, #1f2937, #0f172a)',
                'linear-gradient(135deg, #374151, #1e3a8a)'
            ];
            
            const cardGradient = darkGradients[index % darkGradients.length];
            
            return `
                <div class="ai-song-card" onclick="handleAISongClick(${index})" style="background: ${cardGradient};">
                    <!-- Floating Music Icon -->
                    <div class="floating-music-icon">
                        <div class="music-note">â™ª</div>
                        <div class="music-wave"></div>
                    </div>
                    
                    <!-- Card Content -->
                    <div class="card-content">
                        <!-- Song Title with Glow Effect -->
                        <div class="enhanced-song-title" title="${song.title}">
                            <span class="title-text">${song.title}</span>
                            <div class="title-glow"></div>
                        </div>
                        
                        <!-- Artist Name with Icon -->
                        <div class="enhanced-artist">
                            <span class="artist-icon">ðŸŽ¤</span>
                            <span class="artist-text">${song.artist}</span>
                        </div>
                        
                        <!-- Popularity Stats with Animation -->
                        <div class="popularity-stats">
                            <div class="stat-bubble track-stat">
                                <div class="stat-icon" style="color: #4fd1c7;">ðŸ”¥</div>
                                <div class="stat-value">${song.popularity || 0}</div>
                                <div class="stat-label">Track</div>
                            </div>
                            <div class="stat-bubble artist-stat">
                                <div class="stat-icon" style="color: #06d6a0;">â­</div>
                                <div class="stat-value">${song.artist_popularity || 0}</div>
                                <div class="stat-label">Artist</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Enhanced Play Button -->
                    <div class="enhanced-play-btn" onclick="playAISong(${index}, event)">
                        <div class="play-btn-inner">
                            <div class="play-icon-enhanced">â–¶</div>
                            <div class="play-ripple"></div>
                        </div>
                        <div class="play-glow"></div>
                    </div>
                    
                    <!-- Card Shine Effect -->
                    <div class="card-shine"></div>
                </div>
            `;
        }
        
        function updateEmotionDisplay(emotion) {
            // Update any emotion indicators on the page
            const emotionDisplay = document.querySelector('.current-emotion');
            if (emotionDisplay) {
                emotionDisplay.textContent = `Current Emotion: ${emotion.dominant} (${Math.round(emotion.confidence * 100)}%)`;
            }
        }

        // ðŸŽ  CAROUSEL MANUAL CONTROLS
        function toggleCarouselAnimation() {
            const musicTrack = document.getElementById('musicTrack');
            const pauseBtn = document.getElementById('pauseBtn');
            
            if (isCarouselPaused) {
                // Resume animation - RESET everything
                currentTransform = 0;
                musicTrack.style.transform = 'translateX(0px)';
                musicTrack.style.animation = 'scroll-left 60s linear infinite';
                musicTrack.classList.remove('paused');
                pauseBtn.textContent = 'â¸';
                pauseBtn.classList.remove('active');
                isCarouselPaused = false;
                console.log('â–¶ï¸ Animation resumed, reset to start');
            } else {
                // Pause animation
                musicTrack.style.animationPlayState = 'paused';
                musicTrack.classList.add('paused');
                pauseBtn.textContent = 'â–¶';
                pauseBtn.classList.add('active');
                isCarouselPaused = true;
                console.log('â¸ Animation paused');
            }
        }

        function scrollCarouselLeft() {
            const musicTrack = document.getElementById('musicTrack');
            if (!musicTrack) return;
            
            const scrollAmount = 170; // Half card width for smoother scrolling
            
            // Only scroll left if we're not already at the start
            if (currentTransform < 0) {
                currentTransform += scrollAmount; // Move left (toward 0)
                
                // Don't scroll past start
                if (currentTransform > 0) currentTransform = 0;
                
                // DISABLE ANIMATION COMPLETELY for manual control
                musicTrack.style.animation = 'none';
                musicTrack.style.transform = `translateX(${currentTransform}px)`;
                musicTrack.classList.add('paused');
                
                // Update button states
                isCarouselPaused = true;
                const pauseBtn = document.getElementById('pauseBtn');
                if (pauseBtn) {
                    pauseBtn.textContent = 'â–¶';
                    pauseBtn.classList.add('active');
                }
                
                console.log('â¬…ï¸ Scrolled left, transform:', currentTransform);
            } else {
                console.log('â¬…ï¸ Already at start, cannot scroll left');
            }
        }

        function scrollCarouselRight() {
            const musicTrack = document.getElementById('musicTrack');
            if (!musicTrack) {
                console.log('âŒ musicTrack not found');
                return;
            }
            
            const scrollAmount = 170; // Half card width for smoother scrolling
            
            // Calculate max scroll based on content width vs viewport width
            const totalWidth = currentAISongs.length * 340;
            const viewportWidth = window.innerWidth;
            const maxScroll = -(totalWidth - viewportWidth + 200); // Add some padding
            
            // Only scroll right if we haven't reached the end
            if (currentTransform > maxScroll) {
                currentTransform -= scrollAmount; // Move right (negative direction)
                
                // Don't scroll past end
                if (currentTransform < maxScroll) currentTransform = maxScroll;
                
                // DISABLE ANIMATION COMPLETELY for manual control
                musicTrack.style.animation = 'none';
                musicTrack.style.transform = `translateX(${currentTransform}px)`;
                musicTrack.classList.add('paused');
                
                // Update button states
                isCarouselPaused = true;
                const pauseBtn = document.getElementById('pauseBtn');
                if (pauseBtn) {
                    pauseBtn.textContent = 'â–¶';
                    pauseBtn.classList.add('active');
                }
                
                console.log('âž¡ï¸ Scrolled right, transform:', currentTransform);
            } else {
                console.log('âž¡ï¸ Already at end, cannot scroll right');
            }
        }

        // ðŸ–±ï¸ DRAG AND SWIPE FUNCTIONALITY  
        let dragListenersAttached = false;
        function initializeCarouselDragControls() {
            const container = document.querySelector('.music-carousel');
            const musicTrack = document.getElementById('musicTrack');
            
            if (!container || !musicTrack) {
                console.log('âŒ Drag controls: Container or musicTrack not found');
                return;
            }

            // Remove existing listeners if any to prevent duplicates
            if (dragListenersAttached) {
                console.log('Removing old drag listeners');
                container.removeEventListener('mousedown', window.carouselMouseDown);
                document.removeEventListener('mousemove', window.carouselMouseMove);  
                document.removeEventListener('mouseup', window.carouselMouseUp);
            }

            console.log('âœ… Initializing drag controls');
            dragListenersAttached = true;
            
            // Move variables to global scope for reinitialization
            window.carouselStartDragX = 0;
            window.carouselIsDragging = false;
            window.carouselStartTransform = 0;

            // Mouse events - Add debugging to see if events are attached
            console.log('ðŸ”§ Adding mouse event listeners to:', container);
            
            // Create global function references for removal
            window.carouselMouseDown = function(e) {
                console.log('ðŸ”§ MOUSEDOWN DETECTED on container!', e.target);
                startDrag(e);
            };
            window.carouselMouseMove = drag;
            window.carouselMouseUp = endDrag;
            
            container.addEventListener('mousedown', window.carouselMouseDown, { passive: false });
            document.addEventListener('mousemove', window.carouselMouseMove, { passive: false });
            document.addEventListener('mouseup', window.carouselMouseUp);

            // Touch events for mobile  
            container.addEventListener('touchstart', startDrag, { passive: false });
            document.addEventListener('touchmove', drag, { passive: false });
            document.addEventListener('touchend', endDrag);
            
            // Debug: Check if container is properly setup
            console.log('ðŸ”§ Drag container setup:', {
                container: container.className,
                musicTrack: musicTrack.id,
                containerRect: container.getBoundingClientRect(),
                trackRect: musicTrack.getBoundingClientRect(),
                currentAISongsLength: currentAISongs.length
            });
            
            // Test immediate functionality
            setTimeout(() => {
                console.log('ðŸ”§ Delayed check - currentAISongs length:', currentAISongs.length);
            }, 1000);

            function startDrag(e) {
                console.log('ðŸ”§ Start drag event fired, target:', e.target.className, 'tagName:', e.target.tagName);
                
                // Only prevent drag on actual button elements - allow drag everywhere else
                if (e.target.tagName === 'BUTTON' || e.target.closest('button')) {
                    console.log('âŒ Drag blocked: clicked on button element');
                    return;
                }
                
                // Allow drag on all other elements including cards
                console.log('âœ… Drag allowed on target:', e.target.className);
                
                // Get current transform from the element itself for accuracy
                const musicTrack = document.getElementById('musicTrack');
                const currentMatrix = window.getComputedStyle(musicTrack).transform;
                if (currentMatrix !== 'none') {
                    const values = currentMatrix.split('(')[1].split(')')[0].split(',');
                    currentTransform = parseFloat(values[4]) || 0;
                }
                
                window.carouselIsDragging = true;
                window.carouselStartDragX = e.clientX || e.touches[0].clientX;
                window.carouselStartTransform = currentTransform;
                
                container.style.cursor = 'grabbing';
                // DISABLE ANIMATION COMPLETELY during drag
                musicTrack.style.animation = 'none';
                musicTrack.classList.add('dragging');
                musicTrack.classList.add('paused');
                
                e.preventDefault();
                e.stopPropagation();
                console.log('ðŸ–±ï¸ Drag started, startTransform:', window.carouselStartTransform, 'startDragX:', window.carouselStartDragX);
            }

            function drag(e) {
                if (!window.carouselIsDragging) {
                    // Don't log this constantly as it's normal during mouse movement
                    return;
                }
                e.preventDefault();
                
                const currentX = e.clientX || e.touches[0].clientX;
                const deltaX = currentX - window.carouselStartDragX;
                const newTransform = window.carouselStartTransform + deltaX;
                
                // Apply constraints (same logic as arrow buttons)
                const totalWidth = currentAISongs.length * 340;
                const viewportWidth = window.innerWidth;
                const maxScroll = -(totalWidth - viewportWidth + 200); // Add padding
                const constrainedTransform = Math.max(maxScroll, Math.min(0, newTransform));
                
                // DISABLE ANIMATION COMPLETELY during drag
                const musicTrack = document.getElementById('musicTrack');
                musicTrack.style.animation = 'none';
                musicTrack.style.transform = `translateX(${constrainedTransform}px)`;
                currentTransform = constrainedTransform;
                
                console.log('ðŸ–±ï¸ Dragging, deltaX:', deltaX, 'currentX:', currentX, 'startDragX:', window.carouselStartDragX, 'newTransform:', constrainedTransform);
            }

            function endDrag(e) {
                if (!window.carouselIsDragging) return;
                
                window.carouselIsDragging = false;
                const container = document.querySelector('.music-carousel');
                const musicTrack = document.getElementById('musicTrack');
                
                container.style.cursor = 'grab';
                musicTrack.classList.remove('dragging');
                musicTrack.classList.add('paused'); // Keep animation disabled
                
                // Update pause button state
                isCarouselPaused = true;
                const pauseBtn = document.getElementById('pauseBtn');
                if (pauseBtn) {
                    pauseBtn.textContent = 'â–¶';
                    pauseBtn.classList.add('active');
                }
                
                console.log('ðŸ–±ï¸ Drag ended, transform:', currentTransform);
            }
        }
        
        // Global variable to store current AI songs
        let currentAISongs = [];
        
        // ðŸŽ  Carousel Control Variables
        let isCarouselPaused = false;
        let isDragging = false;
        let startX = 0;
        let scrollOffset = 0;
        let currentTransform = 0;
        
        // ðŸ”§ Function to sync currentTransform with actual DOM transform
        function syncCurrentTransform() {
            const musicTrack = document.getElementById('musicTrack');
            if (musicTrack) {
                const currentMatrix = window.getComputedStyle(musicTrack).transform;
                if (currentMatrix !== 'none') {
                    const values = currentMatrix.split('(')[1].split(')')[0].split(',');
                    currentTransform = parseFloat(values[4]) || 0;
                    console.log('ðŸ”„ Synced currentTransform:', currentTransform);
                }
            }
        }

        // ðŸ”§ Debug function to test controls
        function testCarouselControls() {
            console.log('ðŸ”§ Testing carousel controls...');
            console.log('Elements found:');
            console.log('- musicTrack:', document.getElementById('musicTrack'));
            console.log('- music-carousel:', document.querySelector('.music-carousel'));
            console.log('- pauseBtn:', document.getElementById('pauseBtn'));
            console.log('- scrollLeftBtn:', document.getElementById('scrollLeftBtn'));
            console.log('- scrollRightBtn:', document.getElementById('scrollRightBtn'));
            console.log('- currentAISongs length:', currentAISongs.length);
            console.log('- currentTransform:', currentTransform);
        }

        // Expose to window for testing
        window.testCarouselControls = testCarouselControls;
        window.scrollCarouselLeft = scrollCarouselLeft;
        window.scrollCarouselRight = scrollCarouselRight;
        window.toggleCarouselAnimation = toggleCarouselAnimation;
        
        function handleAISongClick(index) {
            const song = currentAISongs[index % currentAISongs.length];
            console.log('ðŸŽµ AI Song clicked:', song.title, 'by', song.artist);
            console.log('ðŸŽ¯ GUARANTEE: This exact song will be played:', song.title);
            
            // Open the professional music player with THIS SPECIFIC AI song
            openMusicPlayer(song, index);
        }
        
        function playAISong(index, event) {
            event.stopPropagation();
            
            const song = currentAISongs[index % currentAISongs.length];
            console.log('â–¶ï¸ Playing AI song:', song.title, 'by', song.artist);
            
            // Open the full music player instead of just showing notification
            openMusicPlayer(song, index);
        }

        // Old fallback music player functions removed - only AI songs are supported

        // ===== PROFESSIONAL MUSIC PLAYER FUNCTIONALITY =====
        let currentSongIndex = 0;
        let currentPlaylist = [];
        let audioPlayer = null;
        let isPlayerPlaying = false;

        function openMusicPlayer(song, index) {
            currentSongIndex = index;
            currentPlaylist = currentAISongs || [];
            
            console.log('ðŸŽµ Opening music player for:', song.title, 'by', song.artist);
            console.log('ðŸŽ¯ CONFIRMED: Playing this specific song:', song.title, 'by', song.artist);
            console.log('ðŸŽµ Current playlist length:', currentPlaylist.length);
            
            // Start wind animation and setup player simultaneously
            startWindAnimation();
            
            // Show the popup
            const popup = document.getElementById('musicPlayerPopup');
            popup.classList.add('visible');
            
            // Start setup immediately (don't wait for animation) - EXACTLY THIS SONG
            setupPlayer(song);
        }

        function startWindAnimation() {
            const windAnimation = document.getElementById('windAnimation');
            const particles = windAnimation.querySelectorAll('.wind-particle');
            
            // Position particles randomly
            particles.forEach((particle, index) => {
                const size = Math.random() * 8 + 4;
                particle.style.width = size + 'px';
                particle.style.height = size + 'px';
                particle.style.top = Math.random() * 80 + 10 + '%';
                particle.style.left = '-20px';
                particle.style.animationDelay = (index * 0.2) + 's';
            });
            
            windAnimation.classList.add('active');
            
            // Hide wind animation after 1.5 seconds
            setTimeout(() => {
                windAnimation.classList.remove('active');
            }, 1500);
        }

        function setupPlayer(song) {
            const playerContent = document.getElementById('playerContent');
            const songTitle = document.getElementById('songTitle');
            const songArtist = document.getElementById('songArtist');
            const albumArt = document.getElementById('albumArt');
            
            // ðŸ”§ CLEAR PREVIOUS AUDIO: Prevent audio reuse between different songs
            if (audioPlayer) {
                audioPlayer.pause();
                audioPlayer.currentTime = 0;
                audioPlayer.src = '';
                audioPlayer.load();
                console.log(`ðŸ§¹ Cleared previous audio before loading: ${song.title}`);
            }
            
            // Show player content
            playerContent.classList.add('visible');
            
            // Update song info
            songTitle.textContent = song.title;
            songArtist.textContent = song.artist;
            
            // Update album art gradient based on mood
            const moodColors = {
                'Happy': 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                'Sad': 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                'Energetic': 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                'Calm': 'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)',
                'Romantic': 'linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)',
                'Motivational': 'linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)',
                'Chill': 'linear-gradient(135deg, #96deda 0%, #50c9c3 100%)'
            };
            
            albumArt.style.background = moodColors[song.mood] || moodColors['Happy'];
            
            // Initialize audio player
            initializeAudioPlayer(song);
        }

        async function initializeAudioPlayer(song) {
            const loadingMessage = document.getElementById('loadingMessage');
            const playerContent = document.getElementById('playerContent');
            
            // Show loading
            loadingMessage.style.display = 'block';
            playerContent.style.opacity = '0.5';
            
            try {
                console.log(`ðŸŽµ Initializing player for: ${song.title} by ${song.artist}`);
                
                const cacheResponse = await fetch(`/api/check_local_music?song=${encodeURIComponent(song.title)}&artist=${encodeURIComponent(song.artist)}`);
                const cacheData = await cacheResponse.json();
                
                if (cacheData.success && cacheData.cached) {
                    console.log(`âš¡ Using cached audio: ${cacheData.source}`);
                    await setupAudioElement(cacheData.audio_url, cacheData.source);
                    await updateAlbumArt(song);
                    return;
                }
                
                console.log(`ðŸ” Fetching new audio for: ${song.title} by ${song.artist}`);
                
                const response = await fetch(`/api/get_audio?song=${encodeURIComponent(song.title)}&artist=${encodeURIComponent(song.artist)}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log(`âœ… Audio fetch response:`, data);
                
                if (data.success && data.audio_url) {
                    await setupAudioElement(data.audio_url, data.source);
                    await updateAlbumArt(song);
                } else {
                    throw new Error(data.error || 'Failed to get audio URL');
                }
                
            } catch (error) {
                console.error('âŒ Error initializing audio:', error);
                handleAudioError(song);
            }
        }
        
        async function setupAudioElement(audioUrl, source) {
            const loadingMessage = document.getElementById('loadingMessage');
            const playerContent = document.getElementById('playerContent');
            
            return new Promise((resolve, reject) => {
                // Setup audio element with real audio
                audioPlayer = document.getElementById('audioPlayer');
                
                // ðŸ”§ PROPER CACHE CLEARING: Stop, clear, reset, then load new audio
                audioPlayer.pause();
                audioPlayer.currentTime = 0;
                audioPlayer.src = '';
                audioPlayer.load(); // Force browser to clear audio buffer completely
                
                // Add cache-busting parameter to ensure fresh audio load
                const cacheBustUrl = audioUrl + (audioUrl.includes('?') ? '&' : '?') + '_t=' + Date.now();
                audioPlayer.src = cacheBustUrl;
                
                console.log(`ðŸ”„ Loading fresh audio from ${source}: ${audioUrl}`);
                
                // Remove old event listeners
                audioPlayer.removeEventListener('loadedmetadata', () => {});
                audioPlayer.removeEventListener('timeupdate', updateProgress);
                audioPlayer.removeEventListener('ended', playNext);
                
                // Add new event listeners
                audioPlayer.addEventListener('loadedmetadata', () => {
                    loadingMessage.style.display = 'none';
                    playerContent.style.opacity = '1';
                    updateTotalTime();
                    console.log(`ðŸŽµ Audio loaded successfully from: ${source}`);
                    resolve();
                });
                
                audioPlayer.addEventListener('timeupdate', updateProgress);
                audioPlayer.addEventListener('ended', playNext);
                
                audioPlayer.addEventListener('error', (e) => {
                    console.error('âŒ Audio playback error:', e);
                    reject(e);
                });
                
                // Auto-play when ready and preload next song
                audioPlayer.addEventListener('canplaythrough', () => {
                    console.log('ðŸŽµ Audio ready to play - starting automatically');
                    autoPlayAudio();
                    preloadNextSong();
                });
                
                // Set volume from slider
                const volumeSlider = document.getElementById('volumeSlider');
                if (volumeSlider) {
                    audioPlayer.volume = volumeSlider.value / 100;
                }
                
                // Load the audio
                audioPlayer.load();
            });
        }
        
        async function updateAlbumArt(song) {
            try {
                const response = await fetch(`/api/get_album_art?song=${encodeURIComponent(song.title)}&artist=${encodeURIComponent(song.artist)}`);
                const data = await response.json();
                
                if (data.success && data.image_url) {
                    const albumArt = document.getElementById('albumArt');
                    
                    // Create image element and set as background
                    const img = new Image();
                    img.onload = () => {
                        albumArt.style.backgroundImage = `url(${data.image_url})`;
                        albumArt.style.backgroundSize = 'cover';
                        albumArt.style.backgroundPosition = 'center';
                        // Remove the music note if image loads
                        albumArt.innerHTML = '';
                    };
                    img.src = data.image_url;
                }
            } catch (error) {
                console.log('âš ï¸ Could not load album art:', error);
                // Keep the default gradient background
            }
        }
        
        function handleAudioError(song) {
            const loadingMessage = document.getElementById('loadingMessage');
            const playerContent = document.getElementById('playerContent');
            
            // Hide loading and show error state
            loadingMessage.style.display = 'none';
            playerContent.style.opacity = '1';
            
            // Use fallback audio
            audioPlayer = document.getElementById('audioPlayer');
            audioPlayer.src = 'https://www.soundjay.com/misc/sounds/bell-ringing-05.wav';
            
            // Audio event listeners
            audioPlayer.addEventListener('loadedmetadata', () => {
                updateTotalTime();
            });
            
            audioPlayer.addEventListener('timeupdate', updateProgress);
            audioPlayer.addEventListener('ended', playNext);
            
            // Load the fallback audio
            audioPlayer.load();
            
            console.log('ðŸ”„ Using fallback audio for:', song.title);
        }

        function autoPlayAudio() {
            // Automatically start playing when audio is ready
            if (audioPlayer && audioPlayer.readyState >= 3) {
                const playPauseBtn = document.getElementById('playPauseBtn');
                const albumArt = document.getElementById('albumArt');
                
                audioPlayer.play().then(() => {
                    playPauseBtn.textContent = 'â¸';
                    albumArt.classList.add('playing');
                    isPlayerPlaying = true;
                    console.log('ðŸŽµ Auto-play started successfully');
                }).catch(error => {
                    console.log('âš ï¸ Auto-play blocked by browser - user interaction required');
                    // Browser blocked auto-play, user will need to click play
                });
            }
        }
        
        function playPause() {
            const playPauseBtn = document.getElementById('playPauseBtn');
            const albumArt = document.getElementById('albumArt');
            
            if (isPlayerPlaying) {
                audioPlayer.pause();
                playPauseBtn.textContent = 'â–¶';
                albumArt.classList.remove('playing');
                isPlayerPlaying = false;
            } else {
                audioPlayer.play().then(() => {
                    playPauseBtn.textContent = 'â¸';
                    albumArt.classList.add('playing');
                    isPlayerPlaying = true;
                }).catch(error => {
                    console.error('âŒ Playback failed:', error);
                });
            }
        }

        function playNext() {
            currentSongIndex = (currentSongIndex + 1) % currentPlaylist.length;
            const nextSong = currentPlaylist[currentSongIndex];
            setupPlayer(nextSong);
            if (isPlayerPlaying) {
                setTimeout(() => audioPlayer.play(), 500);
            }
        }

        function playPrevious() {
            currentSongIndex = (currentSongIndex - 1 + currentPlaylist.length) % currentPlaylist.length;
            const prevSong = currentPlaylist[currentSongIndex];
            setupPlayer(prevSong);
            if (isPlayerPlaying) {
                setTimeout(() => audioPlayer.play(), 500);
            }
        }

        function updateProgress() {
            if (!audioPlayer) return;
            
            const progressFill = document.getElementById('progressFill');
            const currentTime = document.getElementById('currentTime');
            const miniProgress = document.getElementById('miniProgress');
            
            const progress = (audioPlayer.currentTime / audioPlayer.duration) * 100;
            progressFill.style.width = progress + '%';
            
            // Update mini player progress
            if (miniProgress) {
                miniProgress.style.width = progress + '%';
            }
            
            currentTime.textContent = formatTime(audioPlayer.currentTime);
        }

        function updateTotalTime() {
            const totalTime = document.getElementById('totalTime');
            totalTime.textContent = formatTime(audioPlayer.duration);
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function preloadNextSong() {
            // Preload the next song in background for instant switching
            const nextIndex = (currentSongIndex + 1) % currentPlaylist.length;
            const nextSong = currentPlaylist[nextIndex];
            
            // Check if next song is cached (don't download unnecessarily)
            fetch(`/api/check_local_music?song=${encodeURIComponent(nextSong.title)}&artist=${encodeURIComponent(nextSong.artist)}`)
                .then(response => response.json())
                .then(data => {
                    if (!data.cached) {
                        console.log(`ðŸ”„ Preloading next song: ${nextSong.title}`);
                        // Trigger background download (don't wait for response)
                        fetch(`/api/get_audio?song=${encodeURIComponent(nextSong.title)}&artist=${encodeURIComponent(nextSong.artist)}`);
                    } else {
                        console.log(`âš¡ Next song already cached: ${nextSong.title}`);
                    }
                })
                .catch(error => console.log('âš ï¸ Preload check failed:', error));
        }
        
        function closePlayer() {
            const popup = document.getElementById('musicPlayerPopup');
            const playerContent = document.getElementById('playerContent');
            
            // Hide main player
            playerContent.classList.remove('visible');
            popup.classList.remove('visible');
            
            // Show mini player if music is loaded
            if (audioPlayer && audioPlayer.src) {
                showMiniPlayer();
            }
        }
        
        function showMiniPlayer() {
            const miniPlayer = document.getElementById('miniPlayer');
            const miniSongTitle = document.getElementById('miniSongTitle');
            const miniSongArtist = document.getElementById('miniSongArtist');
            const miniAlbumArt = document.getElementById('miniAlbumArt');
            const miniPlayPauseBtn = document.getElementById('miniPlayPauseBtn');
            
            // Update mini player info
            const currentSong = currentPlaylist[currentSongIndex];
            if (currentSong) {
                miniSongTitle.textContent = currentSong.title;
                miniSongArtist.textContent = currentSong.artist;
                
                // Copy album art style from main player
                const mainAlbumArt = document.getElementById('albumArt');
                if (mainAlbumArt.style.backgroundImage) {
                    miniAlbumArt.style.backgroundImage = mainAlbumArt.style.backgroundImage;
                    miniAlbumArt.style.backgroundSize = 'cover';
                    miniAlbumArt.style.backgroundPosition = 'center';
                    miniAlbumArt.innerHTML = '';
                } else {
                    miniAlbumArt.style.background = mainAlbumArt.style.background;
                }
            }
            
            // Update play/pause button
            miniPlayPauseBtn.textContent = isPlayerPlaying ? 'â¸' : 'â–¶';
            
            // Sync album art rotation
            if (isPlayerPlaying) {
                miniAlbumArt.classList.add('playing');
            } else {
                miniAlbumArt.classList.remove('playing');
            }
            
            // Show mini player
            miniPlayer.classList.add('visible');
        }
        
        function hideMiniPlayer() {
            const miniPlayer = document.getElementById('miniPlayer');
            miniPlayer.classList.remove('visible');
        }
        
        function expandMiniPlayer() {
            // Hide mini player and show main player
            hideMiniPlayer();
            
            const popup = document.getElementById('musicPlayerPopup');
            const playerContent = document.getElementById('playerContent');
            
            popup.classList.add('visible');
            playerContent.classList.add('visible');
        }
        
        function stopMusic() {
            console.log('ðŸ”‡ Stopping music and cleaning up...');
            
            if (audioPlayer) {
                // Stop all playback
                audioPlayer.pause();
                audioPlayer.currentTime = 0;
                
                // Remove all event listeners to prevent any continued playback
                audioPlayer.removeEventListener('timeupdate', updateProgress);
                audioPlayer.removeEventListener('ended', playNext);
                audioPlayer.removeEventListener('loadedmetadata', () => {});
                audioPlayer.removeEventListener('error', () => {});
                audioPlayer.removeEventListener('canplaythrough', () => {});
                
                // Remove the audio source completely
                audioPlayer.src = '';
                audioPlayer.load(); // Force reload to clear buffer
                
                // Update player state
                isPlayerPlaying = false;
                
                // Update UI elements
                const playPauseBtn = document.getElementById('playPauseBtn');
                const miniPlayPauseBtn = document.getElementById('miniPlayPauseBtn');
                
                if (playPauseBtn) playPauseBtn.textContent = 'â–¶';
                if (miniPlayPauseBtn) miniPlayPauseBtn.textContent = 'â–¶';
                
                // Reset progress bars
                const progressFill = document.getElementById('progressFill');
                const miniProgress = document.getElementById('miniProgress');
                const currentTime = document.getElementById('currentTime');
                const totalTime = document.getElementById('totalTime');
                
                if (progressFill) progressFill.style.width = '0%';
                if (miniProgress) miniProgress.style.width = '0%';
                if (currentTime) currentTime.textContent = '0:00';
                if (totalTime) totalTime.textContent = '0:00';
                
                console.log('ðŸ”‡ Audio stopped and all listeners removed');
            }
            
            // Hide both players
            const popup = document.getElementById('musicPlayerPopup');
            const playerContent = document.getElementById('playerContent');
            popup.classList.remove('visible');
            playerContent.classList.remove('visible');
            hideMiniPlayer();
            
            // Clear session storage for player state
            sessionStorage.removeItem('musicPlayerVisible');
            sessionStorage.removeItem('miniPlayerVisible');
            
            console.log('ðŸ”‡ Music player completely stopped');
        }

        // Mini player functions
        function miniPlayPause() {
            playPause();
            
            // Update mini player button
            const miniPlayPauseBtn = document.getElementById('miniPlayPauseBtn');
            const miniAlbumArt = document.getElementById('miniAlbumArt');
            
            miniPlayPauseBtn.textContent = isPlayerPlaying ? 'â¸' : 'â–¶';
            
            if (isPlayerPlaying) {
                miniAlbumArt.classList.add('playing');
            } else {
                miniAlbumArt.classList.remove('playing');
            }
        }
        
        function miniPlayNext() {
            playNext();
            // Update mini player info after song change
            setTimeout(() => {
                if (document.getElementById('miniPlayer').classList.contains('visible')) {
                    showMiniPlayer();
                }
            }, 500);
        }
        
        function miniPlayPrevious() {
            playPrevious();
            // Update mini player info after song change
            setTimeout(() => {
                if (document.getElementById('miniPlayer').classList.contains('visible')) {
                    showMiniPlayer();
                }
            }, 500);
        }

        // Setup event listeners for music player
        document.addEventListener('DOMContentLoaded', () => {
            // Main player controls
            document.getElementById('closePlayerBtn').addEventListener('click', closePlayer);
            document.getElementById('playPauseBtn').addEventListener('click', playPause);
            document.getElementById('nextBtn').addEventListener('click', playNext);
            document.getElementById('prevBtn').addEventListener('click', playPrevious);
            
            // Mini player controls
            document.getElementById('miniPlayPauseBtn').addEventListener('click', miniPlayPause);
            document.getElementById('miniNextBtn').addEventListener('click', miniPlayNext);
            document.getElementById('miniPrevBtn').addEventListener('click', miniPlayPrevious);
            document.getElementById('miniExpandBtn').addEventListener('click', expandMiniPlayer);
            document.getElementById('miniCloseBtn').addEventListener('click', stopMusic);
            
            // Progress bar click
            document.getElementById('progressBar').addEventListener('click', (e) => {
                if (!audioPlayer) return;
                const rect = e.target.getBoundingClientRect();
                const percentage = (e.clientX - rect.left) / rect.width;
                audioPlayer.currentTime = percentage * audioPlayer.duration;
            });
            
            // Volume control
            document.getElementById('volumeSlider').addEventListener('input', (e) => {
                if (audioPlayer) {
                    audioPlayer.volume = e.target.value / 100;
                }
            });
        });

        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#4fd1c7'};
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                z-index: 1000;
                max-width: 300px;
                box-shadow: 0 5px 15px rgba(0,0,0,0.3);
                font-size: 0.9em;
                animation: slideIn 0.3s ease;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // Add animation styles
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);

        // ðŸŽ¯ VISUAL FEEDBACK FUNCTIONS
        function showMusicUpdateIndicator(message, type = 'loading') {
            const statusElement = document.getElementById('musicUpdateStatus');
            if (statusElement) {
                statusElement.textContent = message;
                statusElement.className = `music-update-status ${type}`;
                statusElement.style.display = 'block';
            }
        }

        function hideMusicUpdateIndicator() {
            const statusElement = document.getElementById('musicUpdateStatus');
            if (statusElement) {
                statusElement.style.display = 'none';
            }
        }

        function updateMusicTitle(newTitle) {
            const titleElement = document.getElementById('musicTitle');
            if (titleElement) {
                titleElement.textContent = newTitle;
                titleElement.classList.add('emotion-pulse');
                setTimeout(() => titleElement.classList.remove('emotion-pulse'), 2000);
            }
        }

        function flashMusicContainer() {
            const container = document.querySelector('.music-carousel-container');
            if (container) {
                container.style.boxShadow = '0 0 30px rgba(59, 130, 246, 0.6)';
                setTimeout(() => {
                    container.style.boxShadow = '';
                }, 1000);
            }
        }

        // Initialize music carousel immediately (before DOM fully loads)
        function initCarouselEarly() {
            const musicTrack = document.getElementById('musicTrack');
            if (musicTrack) {
                initializeMusicCarousel();
                initializeCarouselDragControls();
                initializeWheelScroll();
                
                // ðŸ”„ SMART AUTO-REFRESH: More frequent when emotions are detected
                const refreshInterval = currentEmotion && currentEmotion !== 'neutral' ? 20000 : 45000; // 20s for active emotions, 45s for neutral
                
                if (window.musicRecommendationInterval) {
                    clearInterval(window.musicRecommendationInterval);
                }
                
                window.musicRecommendationInterval = setInterval(() => {
                    if (!window.privacyModeActive) {
                        console.log(`ðŸ”„ Auto-refreshing therapeutic music (${refreshInterval/1000}s interval for ${currentEmotion})...`);
                        initializeMusicCarousel();
                    }
                }, refreshInterval); // 30 seconds
            } else {
                // Retry in 100ms if element not ready
                setTimeout(initCarouselEarly, 100);
            }
        }

        // ðŸŽ¡ WHEEL SCROLL SUPPORT
        function initializeWheelScroll() {
            const container = document.querySelector('.music-carousel');
            if (!container) return;

            container.addEventListener('wheel', function(e) {
                e.preventDefault();
                const musicTrack = document.getElementById('musicTrack');
                if (!musicTrack) return;
                
                const scrollSpeed = e.deltaY > 0 ? -40 : 40; // Gentler scroll, deltaY > 0 = scroll down = move right
                currentTransform += scrollSpeed;
                
                // Apply constraints
                const totalWidth = currentAISongs.length * 340;
                const viewportWidth = window.innerWidth;
                const maxScroll = -(totalWidth - viewportWidth);
                currentTransform = Math.max(maxScroll, Math.min(0, currentTransform));
                
                // DISABLE ANIMATION COMPLETELY for wheel scroll
                musicTrack.style.animation = 'none';
                musicTrack.style.transform = `translateX(${currentTransform}px)`;
                musicTrack.classList.add('paused');
                
                // Update pause button
                isCarouselPaused = true;
                const pauseBtn = document.getElementById('pauseBtn');
                if (pauseBtn) {
                    pauseBtn.textContent = 'â–¶';
                    pauseBtn.classList.add('active');
                }
                
                console.log('ðŸŽ¡ Wheel scroll, transform:', currentTransform);
            });
        }

        // Header initialization function
        function initializeHeader() {
            const mobileMenuButton = document.getElementById('mobile-menu-button');
            const mobileMenu = document.getElementById('mobile-menu');
            
            if (mobileMenuButton && mobileMenu) {
                mobileMenuButton.addEventListener('click', function() {
                    mobileMenu.classList.toggle('hidden');
                    this.classList.toggle('active');
                    
                    // Reset animations when toggling menu
                    const mobileLinks = document.querySelectorAll('.mobile-link');
                    mobileLinks.forEach(link => {
                        link.style.animation = 'none';
                        link.offsetHeight; // Trigger reflow
                        link.style.animation = null;
                    });
                });
            }
            
            // Add subtle hover animations to nav links
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => {
                link.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-2px)';
                });
                
                link.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0)';
                });
            });

            // ===== FIREBASE AUTHENTICATION INTEGRATION =====
            initializeHeaderAuth();
        }

        function initializeHeaderAuth() {
            // Get authentication elements
            const tempUserBanner = document.getElementById('tempUserBanner');
            const authUserArea = document.getElementById('authUserArea');
            const guestSignInBtn = document.getElementById('guestSignInBtn');
            const headerSignInBtn = document.getElementById('headerSignInBtn');
            const headerSignOutBtn = document.getElementById('headerSignOutBtn');
            const userName = document.getElementById('userName');
            const userMenuBtn = document.getElementById('userMenuBtn');
            const userDropdown = document.getElementById('userDropdown');
            
            // Mobile elements
            const mobileTempBanner = document.getElementById('mobileTempBanner');
            const mobileAuthUser = document.getElementById('mobileAuthUser');
            const mobileGuestSignIn = document.getElementById('mobileGuestSignIn');
            const mobileSignInBtn = document.getElementById('mobileSignInBtn');
            const mobileSignOutBtn = document.getElementById('mobileSignOutBtn');
            const mobileUserName = document.getElementById('mobileUserName');
            
            // Connect sign-in buttons to Firebase auth system
            if (guestSignInBtn) {
                guestSignInBtn.addEventListener('click', function() {
                    if (window.ymirAuth) {
                        window.ymirAuth.openAuthModal();
                    } else {
                        console.warn('Firebase auth system not loaded');
                    }
                });
            }
            
            if (headerSignInBtn) {
                headerSignInBtn.addEventListener('click', function() {
                    if (window.ymirAuth) {
                        window.ymirAuth.openAuthModal();
                    } else {
                        console.warn('Firebase auth system not loaded');
                    }
                });
            }
            
            if (mobileSignInBtn) {
                mobileSignInBtn.addEventListener('click', function() {
                    if (window.ymirAuth) {
                        window.ymirAuth.openAuthModal();
                    } else {
                        console.warn('Firebase auth system not loaded');
                    }
                });
            }
            
            if (mobileGuestSignIn) {
                mobileGuestSignIn.addEventListener('click', function() {
                    if (window.ymirAuth) {
                        window.ymirAuth.openAuthModal();
                    } else {
                        console.warn('Firebase auth system not loaded');
                    }
                });
            }
            
            // Connect sign-out buttons
            if (headerSignOutBtn) {
                headerSignOutBtn.addEventListener('click', function() {
                    if (window.ymirAuth) {
                        window.ymirAuth.signOut();
                    } else {
                        console.warn('Firebase auth system not loaded');
                    }
                });
            }
            
            if (mobileSignOutBtn) {
                mobileSignOutBtn.addEventListener('click', function() {
                    if (window.ymirAuth) {
                        window.ymirAuth.signOut();
                    } else {
                        console.warn('Firebase auth system not loaded');
                    }
                });
            }
            
            // User menu dropdown toggle
            if (userMenuBtn && userDropdown) {
                userMenuBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    userDropdown.classList.toggle('hidden');
                });
                
                // Close dropdown when clicking outside
                document.addEventListener('click', function() {
                    userDropdown.classList.add('hidden');
                });
            }
            
            // Listen for Firebase authentication state changes
            document.addEventListener('userStateChange', function(event) {
                const { state, user, isTemporary } = event.detail;
                updateHeaderAuthUI(state, user, isTemporary);
            });
            
            // Initial UI state check
            if (window.ymirAuth) {
                const status = window.ymirAuth.getUserStatus();
                updateHeaderAuthUI(
                    status.isAuthenticated ? 'authenticated' : (status.hasTemporaryData ? 'temporary' : 'guest'),
                    status.user,
                    !status.isAuthenticated
                );
            }
        }
        
        function updateHeaderAuthUI(state, user, isTemporary) {
            console.log('ðŸ”„ Updating header auth UI:', { state, user: user?.email, isTemporary });
            
            // Get elements
            const tempUserBanner = document.getElementById('tempUserBanner');
            const authUserArea = document.getElementById('authUserArea');
            const guestSignInBtn = document.getElementById('guestSignInBtn');
            const userName = document.getElementById('userName');
            
            // Mobile elements
            const mobileTempBanner = document.getElementById('mobileTempBanner');
            const mobileAuthUser = document.getElementById('mobileAuthUser');
            const mobileGuestSignIn = document.getElementById('mobileGuestSignIn');
            const mobileUserName = document.getElementById('mobileUserName');
            
            // Hide all sections first
            if (tempUserBanner) tempUserBanner.classList.add('hidden');
            if (authUserArea) authUserArea.classList.add('hidden');
            if (guestSignInBtn) guestSignInBtn.classList.add('hidden');
            if (mobileTempBanner) mobileTempBanner.classList.add('hidden');
            if (mobileAuthUser) mobileAuthUser.classList.add('hidden');
            if (mobileGuestSignIn) mobileGuestSignIn.classList.add('hidden');
            
            if (state === 'authenticated' && user) {
                // Show authenticated user UI
                if (authUserArea) authUserArea.classList.remove('hidden');
                if (mobileAuthUser) mobileAuthUser.classList.remove('hidden');
                
                // Update user names
                const displayName = user.displayName || user.email?.split('@')[0] || 'User';
                if (userName) userName.textContent = displayName;
                if (mobileUserName) mobileUserName.textContent = displayName;
                
                console.log('âœ… Header: Showing authenticated user UI for', displayName);
            } else if (state === 'temporary' || isTemporary) {
                // Show temporary user banner
                if (tempUserBanner) tempUserBanner.classList.remove('hidden');
                if (mobileTempBanner) mobileTempBanner.classList.remove('hidden');
                
                console.log('â±ï¸ Header: Showing temporary user UI');
            } else {
                // Show guest sign-in button
                if (guestSignInBtn) guestSignInBtn.classList.remove('hidden');
                if (mobileGuestSignIn) mobileGuestSignIn.classList.remove('hidden');
                
                console.log('ðŸ‘¤ Header: Showing guest sign-in UI');
            }
        }


        // ðŸŽµ Draggable Music Player - Snap to 4 Corners
        function makeMusicPlayerDraggable() {
            const player = document.getElementById('musicPlayerPopup');
            if (!player) return;

            let isDragging = false;
            let currentX;
            let currentY;
            let initialX;
            let initialY;
            let xOffset = 0;
            let yOffset = 0;

            function dragStart(e) {
                // ðŸŽ¯ RESTRICT DRAG: Only allow dragging from album art area
                const albumArtSection = e.target.closest('.album-art-section');
                const albumArt = e.target.closest('#albumArt');
                
                if (!albumArtSection && !albumArt) {
                    // Not dragging from album art area, ignore
                    return;
                }

                if (e.type === "touchstart") {
                    initialX = e.touches[0].clientX - xOffset;
                    initialY = e.touches[0].clientY - yOffset;
                } else {
                    initialX = e.clientX - xOffset;
                    initialY = e.clientY - yOffset;
                }

                isDragging = true;
                player.style.transition = 'none';
                player.style.cursor = 'grabbing';
                console.log('ðŸŽ¯ Drag started from album art area');
            }

            function dragEnd(e) {
                if (!isDragging) return;
                
                isDragging = false;
                player.style.transition = 'all 0.3s ease';
                player.style.cursor = 'auto'; /* Reset cursor */
                
                // Snap to nearest corner
                snapToCorner();
                
                console.log('ðŸŽ¯ Drag ended - snapped to corner');
            }

            function drag(e) {
                if (!isDragging) return;

                e.preventDefault();

                if (e.type === "touchmove") {
                    currentX = e.touches[0].clientX - initialX;
                    currentY = e.touches[0].clientY - initialY;
                } else {
                    currentX = e.clientX - initialX;
                    currentY = e.clientY - initialY;
                }

                xOffset = currentX;
                yOffset = currentY;

                player.style.transform = `translate(${currentX}px, ${currentY}px)`;
            }

            function snapToCorner() {
                const rect = player.getBoundingClientRect();
                const windowWidth = window.innerWidth;
                const windowHeight = window.innerHeight;
                const playerWidth = rect.width;
                const playerHeight = rect.height;

                const centerX = rect.left + playerWidth / 2;
                const centerY = rect.top + playerHeight / 2;

                let targetX, targetY;

                // Determine which corner is closest
                if (centerX < windowWidth / 2 && centerY < windowHeight / 2) {
                    // Top-left corner
                    targetX = 20;
                    targetY = 20;
                    player.style.left = targetX + 'px';
                    player.style.top = targetY + 'px';
                    player.style.right = 'auto';
                    player.style.bottom = 'auto';
                } else if (centerX >= windowWidth / 2 && centerY < windowHeight / 2) {
                    // Top-right corner
                    targetX = 20;
                    targetY = 20;
                    player.style.right = targetX + 'px';
                    player.style.top = targetY + 'px';
                    player.style.left = 'auto';
                    player.style.bottom = 'auto';
                } else if (centerX < windowWidth / 2 && centerY >= windowHeight / 2) {
                    // Bottom-left corner
                    targetX = 20;
                    targetY = 20;
                    player.style.left = targetX + 'px';
                    player.style.bottom = targetY + 'px';
                    player.style.right = 'auto';
                    player.style.top = 'auto';
                } else {
                    // Bottom-right corner (default)
                    targetX = 20;
                    targetY = 20;
                    player.style.right = targetX + 'px';
                    player.style.bottom = targetY + 'px';
                    player.style.left = 'auto';
                    player.style.top = 'auto';
                }

                // Reset transform
                player.style.transform = 'translate(0, 0)';
                xOffset = 0;
                yOffset = 0;

                // Add subtle animation feedback
                player.style.boxShadow = '0 25px 80px rgba(0, 0, 0, 0.9), 0 0 50px rgba(59, 130, 246, 0.3)';
                setTimeout(() => {
                    player.style.boxShadow = '0 20px 60px rgba(0, 0, 0, 0.8), 0 0 40px rgba(59, 130, 246, 0.15)';
                }, 300);
            }

            // Add event listeners
            player.addEventListener('mousedown', dragStart);
            player.addEventListener('touchstart', dragStart);
            
            document.addEventListener('mousemove', drag);
            document.addEventListener('touchmove', drag);
            
            document.addEventListener('mouseup', dragEnd);
            document.addEventListener('touchend', dragEnd);
            
            // ðŸ”§ ADD RESIZE FUNCTIONALITY
            addResizeFunctionality();
        }

        function addResizeFunctionality() {
            const player = document.getElementById('musicPlayerPopup');
            const resizeHandles = player.querySelectorAll('.resize-handle');
            
            let isResizing = false;
            let resizeType = '';
            let startX, startY;
            let startWidth, startHeight;
            let startLeft, startTop;

            resizeHandles.forEach(handle => {
                handle.addEventListener('mousedown', startResize);
                handle.addEventListener('touchstart', startResize);
            });

            function startResize(e) {
                // Only start resize if user actually clicked on a resize handle
                if (!e.target.classList.contains('resize-handle')) {
                    return;
                }
                
                e.preventDefault();
                e.stopPropagation(); // Prevent drag from triggering
                
                isResizing = true;
                resizeType = e.target.dataset.resize;
                
                const rect = player.getBoundingClientRect();
                startX = e.clientX || e.touches[0].clientX;
                startY = e.clientY || e.touches[0].clientY;
                startWidth = parseInt(getComputedStyle(player).width, 10);
                startHeight = parseInt(getComputedStyle(player).height, 10);
                startLeft = rect.left;
                startTop = rect.top;
                
                player.style.transition = 'none';
                document.body.style.userSelect = 'none';
                
                console.log(`ðŸ”§ Resize started: ${resizeType}`);
                
                document.addEventListener('mousemove', doResize);
                document.addEventListener('touchmove', doResize);
                document.addEventListener('mouseup', stopResize);
                document.addEventListener('touchend', stopResize);
            }

            function doResize(e) {
                if (!isResizing) return;
                
                const currentX = e.clientX || e.touches[0].clientX;
                const currentY = e.clientY || e.touches[0].clientY;
                
                const deltaX = currentX - startX;
                const deltaY = currentY - startY;
                
                let newWidth = startWidth;
                let newHeight = startHeight;
                let newLeft = startLeft;
                let newTop = startTop;
                
                // Calculate new dimensions based on resize direction
                switch(resizeType) {
                    case 'se': // Bottom-right corner
                        newWidth = startWidth + deltaX;
                        newHeight = startHeight + deltaY;
                        break;
                    case 'sw': // Bottom-left corner
                        newWidth = startWidth - deltaX;
                        newHeight = startHeight + deltaY;
                        newLeft = startLeft + deltaX;
                        break;
                    case 'ne': // Top-right corner
                        newWidth = startWidth + deltaX;
                        newHeight = startHeight - deltaY;
                        newTop = startTop + deltaY;
                        break;
                    case 'nw': // Top-left corner
                        newWidth = startWidth - deltaX;
                        newHeight = startHeight - deltaY;
                        newLeft = startLeft + deltaX;
                        newTop = startTop + deltaY;
                        break;
                    case 'e': // Right border
                        newWidth = startWidth + deltaX;
                        break;
                    case 'w': // Left border
                        newWidth = startWidth - deltaX;
                        newLeft = startLeft + deltaX;
                        break;
                    case 's': // Bottom border
                        newHeight = startHeight + deltaY;
                        break;
                    case 'n': // Top border
                        newHeight = startHeight - deltaY;
                        newTop = startTop + deltaY;
                        break;
                }
                
                // Apply size constraints
                const minWidth = 300;
                const minHeight = 400;
                const maxWidth = 800;
                const maxHeight = 1000;
                
                newWidth = Math.max(minWidth, Math.min(maxWidth, newWidth));
                newHeight = Math.max(minHeight, Math.min(maxHeight, newHeight));
                
                // Apply new dimensions
                player.style.width = newWidth + 'px';
                player.style.height = newHeight + 'px';
                player.style.left = newLeft + 'px';
                player.style.top = newTop + 'px';
                
                // Adjust content scaling for larger sizes
                adjustContentScaling(newWidth, newHeight);
            }

            function stopResize() {
                if (!isResizing) return;
                
                isResizing = false;
                resizeType = '';
                player.style.transition = 'all 0.3s ease';
                document.body.style.userSelect = '';
                
                console.log('ðŸ”§ Resize ended');
                
                document.removeEventListener('mousemove', doResize);
                document.removeEventListener('touchmove', doResize);
                document.removeEventListener('mouseup', stopResize);
                document.removeEventListener('touchend', stopResize);
            }
            
            function adjustContentScaling(width, height) {
                // Scale content based on player size
                const baseWidth = 380;
                const baseHeight = 480;
                const scaleX = width / baseWidth;
                const scaleY = height / baseHeight;
                const scale = Math.min(scaleX, scaleY, 1.5); // Max 150% scale
                
                const albumArt = player.querySelector('.album-art');
                const songInfo = player.querySelector('.song-info');
                const controls = player.querySelector('.music-controls');
                
                if (albumArt) {
                    const baseArtSize = 180;
                    const newArtSize = Math.max(120, Math.min(250, baseArtSize * scale));
                    albumArt.style.width = newArtSize + 'px';
                    albumArt.style.height = newArtSize + 'px';
                }
                
                if (songInfo) {
                    songInfo.style.fontSize = Math.max(0.8, Math.min(1.2, scale)) + 'em';
                }
                
                if (controls) {
                    controls.style.fontSize = Math.max(0.9, Math.min(1.1, scale)) + 'em';
                }
            }
        }

        // Fix music player disappearing when switching tabs
        document.addEventListener('visibilitychange', () => {
            const popup = document.getElementById('musicPlayerPopup');
            const miniPlayer = document.getElementById('miniPlayer');
            
            if (document.hidden) {
                // Tab is hidden - store current state
                if (popup && popup.classList.contains('visible')) {
                    sessionStorage.setItem('musicPlayerVisible', 'true');
                }
                if (miniPlayer && miniPlayer.classList.contains('visible')) {
                    sessionStorage.setItem('miniPlayerVisible', 'true');
                }
            } else {
                // Tab is visible again - restore state
                setTimeout(() => {
                    if (sessionStorage.getItem('musicPlayerVisible') === 'true' && popup) {
                        popup.classList.add('visible');
                        const playerContent = document.getElementById('playerContent');
                        if (playerContent) playerContent.classList.add('visible');
                    }
                    if (sessionStorage.getItem('miniPlayerVisible') === 'true' && miniPlayer) {
                        miniPlayer.classList.add('visible');
                    }
                }, 100);
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize header functionality
            initializeHeader();
            
            // Initialize draggable music player
            makeMusicPlayerDraggable();
            
            // Initialize music carousel first for immediate display
            initCarouselEarly();
            
            refreshStatus();
            refreshTextStatus();
            
            // Initialize visual settings
            updateVisualSettings();
            
            // Start periodic status updates (reduced frequency to save API calls)
            statusUpdateInterval = setInterval(refreshStatus, 30000);  // 30 seconds instead of 5
            textStatusUpdateInterval = setInterval(refreshTextStatus, 60000);  // 60 seconds instead of 10
        });
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (statusUpdateInterval) {
                clearInterval(statusUpdateInterval);
            }
            if (emotionUpdateInterval) {
                clearInterval(emotionUpdateInterval);
            }
        });
        
        // =================== BREATHING & MEDITATION EXERCISES ===================
        // Global variables for exercises
        
        let currentExerciseType = null;
        let exerciseTimer = null;
        let exerciseStartTime = null;
        let exerciseDuration = 0;
        let isPaused = false;
        let breathingCycle = 0;
        
        // CSS animations for exercises
        const exerciseAnimations = `
            <style>
                @keyframes breatheIn {
                    0% { transform: scale(1); box-shadow: 0 0 40px rgba(79, 209, 199, 0.6); }
                    100% { transform: scale(1.3); box-shadow: 0 0 80px rgba(79, 209, 199, 0.9); }
                }
                @keyframes breatheOut {
                    0% { transform: scale(1.3); box-shadow: 0 0 80px rgba(79, 209, 199, 0.9); }
                    100% { transform: scale(1); box-shadow: 0 0 40px rgba(79, 209, 199, 0.6); }
                }
                @keyframes hold {
                    0%, 100% { transform: scale(1.3); box-shadow: 0 0 80px rgba(79, 209, 199, 0.9); }
                }
                @keyframes meditationPulse {
                    0%, 100% { transform: scale(1) rotate(0deg); opacity: 1; }
                    50% { transform: scale(1.1) rotate(180deg); opacity: 0.8; }
                }
                @keyframes meditationRipple1 {
                    0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 0.4; }
                    50% { transform: translate(-50%, -50%) scale(1.2); opacity: 0.2; }
                }
                @keyframes meditationRipple2 {
                    0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 0.2; }
                    50% { transform: translate(-50%, -50%) scale(1.3); opacity: 0.1; }
                }
                @keyframes gratitudeFloat {
                    0%, 100% { transform: translate(-50%, -50%) scale(1) rotate(0deg); }
                    25% { transform: translate(-50%, -50%) scale(1.1) rotate(5deg); }
                    50% { transform: translate(-50%, -50%) scale(1.2) rotate(0deg); }
                    75% { transform: translate(-50%, -50%) scale(1.1) rotate(-5deg); }
                }
                .meditation-center { animation: meditationPulse 3s ease-in-out infinite; }
                .meditation-ring1 { animation: meditationRipple1 4s ease-in-out infinite; }
                .meditation-ring2 { animation: meditationRipple2 5s ease-in-out infinite; }
                .gratitude-hearts { animation: gratitudeFloat 4s ease-in-out infinite; }
            </style>
        `;
        
        // Add animations to head
        if (!document.getElementById('exerciseAnimations')) {
            const styleSheet = document.createElement('div');
            styleSheet.innerHTML = exerciseAnimations;
            styleSheet.id = 'exerciseAnimations';
            document.head.appendChild(styleSheet);
        }
        
        function startBreathingExercise() {
            currentExerciseType = 'breathing';
            exerciseDuration = 4 * 60 * 1000; // 4 minutes
            
            openExerciseModal();
            document.getElementById('exerciseTitle').textContent = '4-7-8 Breathing Exercise';
            document.getElementById('breathingCircle').style.display = 'block';
            document.getElementById('meditationVisual').style.display = 'none';
            document.getElementById('gratitudeVisual').style.display = 'none';
            
            document.getElementById('instructionText').textContent = 'Get comfortable and prepare to breathe. This exercise uses the 4-7-8 technique: Inhale for 4 counts, hold for 7 counts, exhale for 8 counts.';
        }
        
        function startMeditationExercise() {
            currentExerciseType = 'meditation';
            exerciseDuration = 5 * 60 * 1000; // 5 minutes
            
            openExerciseModal();
            document.getElementById('exerciseTitle').textContent = '5-Minute Mindfulness Meditation';
            document.getElementById('breathingCircle').style.display = 'none';
            document.getElementById('meditationVisual').style.display = 'block';
            document.getElementById('gratitudeVisual').style.display = 'none';
            
            document.getElementById('instructionText').textContent = 'Find a comfortable position. Close your eyes and focus on your breath. Let thoughts come and go without judgment.';
        }
        
        function startGratitudeExercise() {
            currentExerciseType = 'gratitude';
            exerciseDuration = 3 * 60 * 1000; // 3 minutes
            
            openExerciseModal();
            document.getElementById('exerciseTitle').textContent = 'Gratitude Practice';
            document.getElementById('breathingCircle').style.display = 'none';
            document.getElementById('meditationVisual').style.display = 'none';
            document.getElementById('gratitudeVisual').style.display = 'block';
            
            document.getElementById('instructionText').textContent = 'Take a moment to reflect on three things you are grateful for today. Focus on the feelings of appreciation and joy.';
        }
        
        function openExerciseModal() {
            document.getElementById('exerciseModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
            
            // Reset controls
            document.getElementById('startExerciseBtn').style.display = 'inline-block';
            document.getElementById('pauseExerciseBtn').style.display = 'none';
            document.getElementById('stopExerciseBtn').style.display = 'none';
            document.getElementById('exerciseProgress').style.width = '0%';
            document.getElementById('timerDisplay').textContent = '00:00';
        }
        
        function closeExerciseModal() {
            document.getElementById('exerciseModal').style.display = 'none';
            document.body.style.overflow = 'auto';
            
            if (exerciseTimer) {
                clearInterval(exerciseTimer);
                exerciseTimer = null;
            }
            
            // Stop breathing animations
            const breathingCircle = document.querySelector('.breathing-circle');
            if (breathingCircle) {
                breathingCircle.style.animation = 'none';
            }
            
            currentExerciseType = null;
            isPaused = false;
            breathingCycle = 0;
        }
        
        function startCurrentExercise() {
            if (!currentExerciseType) return;
            
            document.getElementById('startExerciseBtn').style.display = 'none';
            document.getElementById('pauseExerciseBtn').style.display = 'inline-block';
            document.getElementById('stopExerciseBtn').style.display = 'inline-block';
            
            exerciseStartTime = Date.now();
            isPaused = false;
            
            if (currentExerciseType === 'breathing') {
                startBreathingCycle();
            } else if (currentExerciseType === 'meditation') {
                document.getElementById('instructionText').textContent = 'Focus on your breath... inhale... exhale... let your mind be present in this moment.';
            } else if (currentExerciseType === 'gratitude') {
                showGratitudePrompts();
            }
            
            // Start timer
            exerciseTimer = setInterval(updateExerciseTimer, 100);
            
            // Save to Firebase if user is authenticated
            if (window.ymirAuth && !window.ymirAuth.isTemporaryUser) {
                window.ymirAuth.saveData('exercises', {
                    type: currentExerciseType,
                    startTime: new Date(),
                    duration: exerciseDuration
                });
            }
        }
        
        function pauseCurrentExercise() {
            isPaused = !isPaused;
            
            if (isPaused) {
                document.getElementById('pauseExerciseBtn').textContent = 'Resume';
                if (exerciseTimer) {
                    clearInterval(exerciseTimer);
                    exerciseTimer = null;
                }
                
                // Pause breathing animation
                const breathingCircle = document.querySelector('.breathing-circle');
                if (breathingCircle) {
                    breathingCircle.style.animationPlayState = 'paused';
                }
            } else {
                document.getElementById('pauseExerciseBtn').textContent = 'Pause';
                exerciseTimer = setInterval(updateExerciseTimer, 100);
                
                // Resume breathing animation
                const breathingCircle = document.querySelector('.breathing-circle');
                if (breathingCircle) {
                    breathingCircle.style.animationPlayState = 'running';
                }
            }
        }
        
        function stopCurrentExercise() {
            if (exerciseTimer) {
                clearInterval(exerciseTimer);
                exerciseTimer = null;
            }
            
            // Show completion message
            const elapsedTime = Math.floor((Date.now() - exerciseStartTime) / 1000);
            const minutes = Math.floor(elapsedTime / 60);
            const seconds = elapsedTime % 60;
            
            document.getElementById('instructionText').innerHTML = `
                <strong style="color: #10b981;">Exercise Complete!</strong><br>
                You practiced for ${minutes}:${seconds.toString().padStart(2, '0')}. 
                Great job taking time for your mental health! ðŸŒŸ
            `;
            
            // Reset UI
            document.getElementById('startExerciseBtn').style.display = 'inline-block';
            document.getElementById('pauseExerciseBtn').style.display = 'none';
            document.getElementById('stopExerciseBtn').style.display = 'none';
            document.getElementById('startExerciseBtn').textContent = 'Start New Session';
            
            // Stop breathing animations
            const breathingCircle = document.querySelector('.breathing-circle');
            if (breathingCircle) {
                breathingCircle.style.animation = 'none';
            }
            
            // Save completion to Firebase
            if (window.ymirAuth && !window.ymirAuth.isTemporaryUser) {
                window.ymirAuth.saveData('exercises', {
                    type: currentExerciseType,
                    completed: true,
                    duration: elapsedTime,
                    completedAt: new Date()
                });
            }
        }
        
        function updateExerciseTimer() {
            if (!exerciseStartTime || isPaused) return;
            
            const elapsed = Date.now() - exerciseStartTime;
            const remaining = exerciseDuration - elapsed;
            
            if (remaining <= 0) {
                stopCurrentExercise();
                return;
            }
            
            // Update timer display
            const totalSeconds = Math.floor(remaining / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            document.getElementById('timerDisplay').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // Update progress bar
            const progress = (elapsed / exerciseDuration) * 100;
            document.getElementById('exerciseProgress').style.width = progress + '%';
        }
        
        function startBreathingCycle() {
            const breathingCircle = document.querySelector('.breathing-circle');
            const breathingText = document.getElementById('breathingText');
            
            function runCycle() {
                if (isPaused || !currentExerciseType) return;
                
                // Inhale (4 seconds)
                breathingText.textContent = 'Inhale... 4';
                breathingCircle.style.animation = 'breatheIn 4s ease-in-out forwards';
                
                setTimeout(() => {
                    if (isPaused || !currentExerciseType) return;
                    breathingText.textContent = 'Inhale... 3';
                }, 1000);
                
                setTimeout(() => {
                    if (isPaused || !currentExerciseType) return;
                    breathingText.textContent = 'Inhale... 2';
                }, 2000);
                
                setTimeout(() => {
                    if (isPaused || !currentExerciseType) return;
                    breathingText.textContent = 'Inhale... 1';
                }, 3000);
                
                // Hold (7 seconds)
                setTimeout(() => {
                    if (isPaused || !currentExerciseType) return;
                    breathingText.textContent = 'Hold... 7';
                    breathingCircle.style.animation = 'hold 7s ease-in-out forwards';
                }, 4000);
                
                setTimeout(() => { if (!isPaused && currentExerciseType) breathingText.textContent = 'Hold... 6'; }, 5000);
                setTimeout(() => { if (!isPaused && currentExerciseType) breathingText.textContent = 'Hold... 5'; }, 6000);
                setTimeout(() => { if (!isPaused && currentExerciseType) breathingText.textContent = 'Hold... 4'; }, 7000);
                setTimeout(() => { if (!isPaused && currentExerciseType) breathingText.textContent = 'Hold... 3'; }, 8000);
                setTimeout(() => { if (!isPaused && currentExerciseType) breathingText.textContent = 'Hold... 2'; }, 9000);
                setTimeout(() => { if (!isPaused && currentExerciseType) breathingText.textContent = 'Hold... 1'; }, 10000);
                
                // Exhale (8 seconds)
                setTimeout(() => {
                    if (isPaused || !currentExerciseType) return;
                    breathingText.textContent = 'Exhale... 8';
                    breathingCircle.style.animation = 'breatheOut 8s ease-in-out forwards';
                }, 11000);
                
                setTimeout(() => { if (!isPaused && currentExerciseType) breathingText.textContent = 'Exhale... 7'; }, 12000);
                setTimeout(() => { if (!isPaused && currentExerciseType) breathingText.textContent = 'Exhale... 6'; }, 13000);
                setTimeout(() => { if (!isPaused && currentExerciseType) breathingText.textContent = 'Exhale... 5'; }, 14000);
                setTimeout(() => { if (!isPaused && currentExerciseType) breathingText.textContent = 'Exhale... 4'; }, 15000);
                setTimeout(() => { if (!isPaused && currentExerciseType) breathingText.textContent = 'Exhale... 3'; }, 16000);
                setTimeout(() => { if (!isPaused && currentExerciseType) breathingText.textContent = 'Exhale... 2'; }, 17000);
                setTimeout(() => { if (!isPaused && currentExerciseType) breathingText.textContent = 'Exhale... 1'; }, 18000);
                
                // Complete cycle and repeat
                setTimeout(() => {
                    if (!isPaused && currentExerciseType === 'breathing') {
                        breathingCycle++;
                        document.getElementById('instructionText').textContent = 
                            `Cycle ${breathingCycle} complete. Continue breathing steadily... Inhale for 4, hold for 7, exhale for 8.`;
                        runCycle();
                    }
                }, 19000);
            }
            
            runCycle();
        }
        
        function showGratitudePrompts() {
            const prompts = [
                "What made you smile today?",
                "Who are you grateful to have in your life?",
                "What achievement are you proud of?",
                "What simple pleasure brought you joy recently?",
                "What opportunity are you thankful for?",
                "What about your health are you grateful for?",
                "What place makes you feel peaceful?",
                "What skill or talent are you thankful to have?",
                "What memory brings you warmth?",
                "What about today went better than expected?"
            ];
            
            let currentPrompt = 0;
            
            function showNextPrompt() {
                if (currentPrompt < prompts.length && currentExerciseType === 'gratitude' && !isPaused) {
                    document.getElementById('instructionText').textContent = prompts[currentPrompt];
                    currentPrompt++;
                    setTimeout(showNextPrompt, 18000); // 18 seconds per prompt
                }
            }
            
            showNextPrompt();
        }
        
        // =================== END BREATHING & MEDITATION EXERCISES ===================
    </script>

    <!-- CSS Animations for Exercises -->
    <style>
        @keyframes breatheIn {
            0% { transform: scale(1); box-shadow: 0 0 20px rgba(79, 209, 199, 0.6); }
            100% { transform: scale(1.3); box-shadow: 0 0 40px rgba(79, 209, 199, 0.9); }
        }
        @keyframes breatheOut {
            0% { transform: scale(1.3); box-shadow: 0 0 40px rgba(79, 209, 199, 0.9); }
            100% { transform: scale(1); box-shadow: 0 0 20px rgba(79, 209, 199, 0.6); }
        }
        @keyframes meditationPulse {
            0%, 100% { transform: scale(1) rotate(0deg); opacity: 1; }
            50% { transform: scale(1.1) rotate(180deg); opacity: 0.8; }
        }
        @keyframes meditationRipple1 {
            0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 0.4; }
            50% { transform: translate(-50%, -50%) scale(1.2); opacity: 0.2; }
        }
        @keyframes meditationRipple2 {
            0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 0.2; }
            50% { transform: translate(-50%, -50%) scale(1.3); opacity: 0.1; }
        }
        @keyframes gratitudeFloat {
            0%, 100% { transform: scale(1) rotate(0deg); }
            25% { transform: scale(1.1) rotate(5deg); }
            50% { transform: scale(1.2) rotate(0deg); }
            75% { transform: scale(1.1) rotate(-5deg); }
        }
        .meditation-center { animation: meditationPulse 3s ease-in-out infinite; }
        .meditation-ring1 { animation: meditationRipple1 4s ease-in-out infinite; }
        .meditation-ring2 { animation: meditationRipple2 5s ease-in-out infinite; }
        .gratitude-hearts { animation: gratitudeFloat 4s ease-in-out infinite; }
        
        /* Advanced Session Analytics Panel Animations */
        @keyframes notificationSlide {
            0% { transform: translateX(100%) scale(0.9); opacity: 0; }
            100% { transform: translateX(0) scale(1); opacity: 1; }
        }
        
        .emotion-badge {
            animation: emotionPulse 1.5s ease-in-out infinite;
            text-shadow: 0 0 8px rgba(255, 255, 255, 0.3);
        }
        
        @keyframes emotionPulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.2); }
            50% { transform: scale(1.05); box-shadow: 0 0 0 4px rgba(255, 255, 255, 0.1); }
        }
        
        .confidence-meter {
            font-weight: 700;
            text-shadow: 0 0 6px currentColor;
        }
        
        .fps-indicator {
            font-family: 'Courier New', monospace;
            font-weight: 600;
        }
        
        .model-count {
            font-weight: 700;
            text-shadow: 0 0 8px #4fd1c7;
        }
        
        .storage-status {
            font-weight: 600;
            text-shadow: 0 0 6px currentColor;
        }
        
        /* Privacy Mode Transition Effects */
        #video {
            transition: filter 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        
        .privacy-btn {
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .privacy-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.6s;
        }
        
        .privacy-btn:hover::before {
            left: 100%;
        }
        
        /* Enhanced Insight Panel Styles */
        .insight-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(59, 130, 246, 0.1);
            transition: all 0.3s ease;
        }
        
        .insight-item:hover {
            background: rgba(59, 130, 246, 0.05);
            padding-left: 8px;
            border-radius: 6px;
        }
        
        .insight-label {
            color: #93c5fd;
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .insight-value {
            color: #dbeafe;
            font-weight: 600;
            text-align: right;
        }
    </style>

    <!-- Breathing Exercise Functions - Global Scope -->
    <script>
        // Global variables
        var breathingTimer = null;
        var meditationTimer = null;
        var gratitudeTimer = null;
        var breathingStartTime = null;
        var meditationStartTime = null;
        var gratitudeStartTime = null;
        var breathingPaused = false;
        var meditationPaused = false;
        var gratitudePaused = false;
        
        // BREATHING EXERCISE FUNCTIONS
        function startBreathingInCard() {
            console.log('ðŸ§˜â€â™€ï¸ Starting breathing exercise in card...');
            document.getElementById('breathingDefault').style.display = 'none';
            document.getElementById('breathingActive').style.display = 'block';
            document.getElementById('breathingInstructions').textContent = 'Get comfortable. Inhale for 4, hold for 7, exhale for 8.';
        }
        
        function startBreathingSession() {
            console.log('â–¶ï¸ Starting breathing session...');
            document.getElementById('startBreathingBtn').style.display = 'none';
            document.getElementById('pauseBreathingBtn').style.display = 'inline-block';
            
            breathingStartTime = Date.now();
            breathingPaused = false;
            
            // Start breathing cycle
            startBreathingCycle();
            
            // Start timer (4 minutes)
            breathingTimer = setInterval(function() {
                if (breathingPaused) return;
                
                const elapsed = Date.now() - breathingStartTime;
                const totalDuration = 4 * 60 * 1000; // 4 minutes
                const remaining = totalDuration - elapsed;
                
                if (remaining <= 0) {
                    stopBreathingSession();
                    return;
                }
                
                const minutes = Math.floor(remaining / 60000);
                const seconds = Math.floor((remaining % 60000) / 1000);
                document.getElementById('breathingTimer').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                const progress = (elapsed / totalDuration) * 100;
                document.getElementById('breathingProgress').style.width = progress + '%';
            }, 100);
        }
        
        function startBreathingCycle() {
            const circle = document.getElementById('breathingCircle');
            const text = document.getElementById('breathingText');
            
            function runCycle() {
                if (breathingPaused || !breathingTimer) return;
                
                // Inhale (4 seconds)
                text.textContent = 'Inhale';
                circle.style.animation = 'breatheIn 4s ease-in-out forwards';
                
                setTimeout(() => {
                    if (breathingPaused || !breathingTimer) return;
                    // Hold (7 seconds)
                    text.textContent = 'Hold';
                }, 4000);
                
                setTimeout(() => {
                    if (breathingPaused || !breathingTimer) return;
                    // Exhale (8 seconds)
                    text.textContent = 'Exhale';
                    circle.style.animation = 'breatheOut 8s ease-in-out forwards';
                }, 11000);
                
                setTimeout(() => {
                    if (breathingPaused || !breathingTimer) return;
                    runCycle(); // Repeat cycle
                }, 19000);
            }
            
            runCycle();
        }
        
        function pauseBreathingSession() {
            breathingPaused = !breathingPaused;
            
            if (breathingPaused) {
                document.getElementById('pauseBreathingBtn').textContent = 'Resume';
                document.getElementById('breathingCircle').style.animationPlayState = 'paused';
            } else {
                document.getElementById('pauseBreathingBtn').textContent = 'Pause';
                document.getElementById('breathingCircle').style.animationPlayState = 'running';
            }
        }
        
        function stopBreathingSession() {
            console.log('â¹ï¸ Stopping breathing session...');
            if (breathingTimer) {
                clearInterval(breathingTimer);
                breathingTimer = null;
            }
            
            document.getElementById('breathingInstructions').innerHTML = 
                '<strong style="color: #10b981;">Great job! ðŸŒŸ</strong><br>You completed your breathing exercise!';
            document.getElementById('startBreathingBtn').style.display = 'inline-block';
            document.getElementById('pauseBreathingBtn').style.display = 'none';
            document.getElementById('startBreathingBtn').textContent = 'Start Again';
            
            // Reset breathing circle
            document.getElementById('breathingCircle').style.animation = 'none';
            document.getElementById('breathingText').textContent = 'Complete';
            
            // Return to default view after 3 seconds
            setTimeout(() => {
                document.getElementById('breathingDefault').style.display = 'block';
                document.getElementById('breathingActive').style.display = 'none';
                document.getElementById('startBreathingBtn').textContent = 'Start';
                document.getElementById('breathingTimer').textContent = '04:00';
                document.getElementById('breathingProgress').style.width = '0%';
                document.getElementById('breathingText').textContent = 'Ready';
            }, 3000);
        }
        
        // MEDITATION EXERCISE FUNCTIONS
        function startMeditationInCard() {
            console.log('ðŸ§˜â€â™‚ï¸ Starting meditation exercise in card...');
            document.getElementById('meditationDefault').style.display = 'none';
            document.getElementById('meditationActive').style.display = 'block';
            document.getElementById('meditationInstructions').textContent = 'Find a comfortable position and focus on your breath.';
        }
        
        function startMeditationSession() {
            console.log('â–¶ï¸ Starting meditation session...');
            document.getElementById('startMeditationBtn').style.display = 'none';
            document.getElementById('pauseMeditationBtn').style.display = 'inline-block';
            
            meditationStartTime = Date.now();
            meditationPaused = false;
            
            document.getElementById('meditationInstructions').textContent = 'Breathe naturally... let thoughts come and go...';
            
            // Start timer (5 minutes)
            meditationTimer = setInterval(function() {
                if (meditationPaused) return;
                
                const elapsed = Date.now() - meditationStartTime;
                const totalDuration = 5 * 60 * 1000; // 5 minutes
                const remaining = totalDuration - elapsed;
                
                if (remaining <= 0) {
                    stopMeditationSession();
                    return;
                }
                
                const minutes = Math.floor(remaining / 60000);
                const seconds = Math.floor((remaining % 60000) / 1000);
                document.getElementById('meditationTimer').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                const progress = (elapsed / totalDuration) * 100;
                document.getElementById('meditationProgress').style.width = progress + '%';
            }, 100);
        }
        
        function pauseMeditationSession() {
            meditationPaused = !meditationPaused;
            document.getElementById('pauseMeditationBtn').textContent = meditationPaused ? 'Resume' : 'Pause';
        }
        
        function stopMeditationSession() {
            console.log('â¹ï¸ Stopping meditation session...');
            if (meditationTimer) {
                clearInterval(meditationTimer);
                meditationTimer = null;
            }
            
            document.getElementById('meditationInstructions').innerHTML = 
                '<strong style="color: #10b981;">Well done! ðŸŒŸ</strong><br>You completed your meditation!';
            document.getElementById('startMeditationBtn').style.display = 'inline-block';
            document.getElementById('pauseMeditationBtn').style.display = 'none';
            document.getElementById('startMeditationBtn').textContent = 'Start Again';
            
            // Return to default view after 3 seconds
            setTimeout(() => {
                document.getElementById('meditationDefault').style.display = 'block';
                document.getElementById('meditationActive').style.display = 'none';
                document.getElementById('startMeditationBtn').textContent = 'Start';
                document.getElementById('meditationTimer').textContent = '05:00';
                document.getElementById('meditationProgress').style.width = '0%';
            }, 3000);
        }
        
        // GRATITUDE EXERCISE FUNCTIONS  
        function startGratitudeInCard() {
            console.log('â¤ï¸ Starting gratitude exercise in card...');
            document.getElementById('gratitudeDefault').style.display = 'none';
            document.getElementById('gratitudeActive').style.display = 'block';
            document.getElementById('gratitudeInstructions').textContent = 'Think of three things you are grateful for today.';
        }
        
        function startGratitudeSession() {
            console.log('â–¶ï¸ Starting gratitude session...');
            document.getElementById('startGratitudeBtn').style.display = 'none';
            document.getElementById('pauseGratitudeBtn').style.display = 'inline-block';
            
            gratitudeStartTime = Date.now();
            gratitudePaused = false;
            
            // Start gratitude prompts
            showGratitudePrompts();
            
            // Start timer (3 minutes)
            gratitudeTimer = setInterval(function() {
                if (gratitudePaused) return;
                
                const elapsed = Date.now() - gratitudeStartTime;
                const totalDuration = 3 * 60 * 1000; // 3 minutes
                const remaining = totalDuration - elapsed;
                
                if (remaining <= 0) {
                    stopGratitudeSession();
                    return;
                }
                
                const minutes = Math.floor(remaining / 60000);
                const seconds = Math.floor((remaining % 60000) / 1000);
                document.getElementById('gratitudeTimer').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                const progress = (elapsed / totalDuration) * 100;
                document.getElementById('gratitudeProgress').style.width = progress + '%';
            }, 100);
        }
        
        function showGratitudePrompts() {
            const prompts = [
                "What made you smile today?",
                "Who are you grateful to have in your life?",
                "What achievement are you proud of?",
                "What simple pleasure brought you joy?",
                "What opportunity are you thankful for?"
            ];
            
            let currentPrompt = 0;
            
            function showNextPrompt() {
                if (currentPrompt < prompts.length && gratitudeTimer && !gratitudePaused) {
                    document.getElementById('gratitudeInstructions').textContent = prompts[currentPrompt];
                    currentPrompt++;
                    setTimeout(showNextPrompt, 30000); // 30 seconds per prompt
                }
            }
            
            showNextPrompt();
        }
        
        function pauseGratitudeSession() {
            gratitudePaused = !gratitudePaused;
            document.getElementById('pauseGratitudeBtn').textContent = gratitudePaused ? 'Resume' : 'Pause';
        }
        
        function stopGratitudeSession() {
            console.log('â¹ï¸ Stopping gratitude session...');
            if (gratitudeTimer) {
                clearInterval(gratitudeTimer);
                gratitudeTimer = null;
            }
            
            document.getElementById('gratitudeInstructions').innerHTML = 
                '<strong style="color: #10b981;">Beautiful! ðŸŒŸ</strong><br>Thank you for practicing gratitude!';
            document.getElementById('startGratitudeBtn').style.display = 'inline-block';
            document.getElementById('pauseGratitudeBtn').style.display = 'none';
            document.getElementById('startGratitudeBtn').textContent = 'Start Again';
            
            // Return to default view after 3 seconds
            setTimeout(() => {
                document.getElementById('gratitudeDefault').style.display = 'block';
                document.getElementById('gratitudeActive').style.display = 'none';
                document.getElementById('startGratitudeBtn').textContent = 'Start';
                document.getElementById('gratitudeTimer').textContent = '03:00';
                document.getElementById('gratitudeProgress').style.width = '0%';
            }, 3000);
        }
        
        // =================== REAL-TIME THERAPIST FINDER ===================
        
        // Global variables for therapist search
        let userLocation = null;
        let therapistSearchResults = [];
        
        // Initialize therapist finder - removed modal, now using direct page navigation
        function initializeTherapistFinder() {
            // Direct navigation handled by onclick attribute
            console.log('âœ… Therapist finder initialized - using direct page navigation');
        }
        
        // Get user's location
        async function getUserLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('Geolocation not supported'));
                    return;
                }
                
                navigator.geolocation.getCurrentPosition(
                    position => {
                        userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        resolve(userLocation);
                    },
                    error => reject(error),
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 600000 }
                );
            });
        }
        
        // Search therapists using multiple data sources
        async function searchTherapists(location, searchParams = {}) {
            const {
                specialty = '',
                insurance = '',
                language = '',
                gender = '',
                radius = 25
            } = searchParams;
            
            showTherapistLoading(true);
            
            try {
                // Primary search using Psychology Today-style directory
                const therapists = await Promise.all([
                    searchPsychologyTodayTherapists(location, searchParams),
                    searchOpenPathTherapists(location, searchParams),
                    searchTherapyDenTherapists(location, searchParams)
                ]);
                
                // Combine and deduplicate results
                const allTherapists = [].concat(...therapists);
                const uniqueTherapists = deduplicateTherapists(allTherapists);
                
                // Sort by distance and rating
                const sortedTherapists = uniqueTherapists.sort((a, b) => {
                    if (a.distance !== b.distance) return a.distance - b.distance;
                    return (b.rating || 0) - (a.rating || 0);
                });
                
                return sortedTherapists.slice(0, 20); // Limit to top 20 results
                
            } catch (error) {
                console.error('Error searching therapists:', error);
                throw error;
            } finally {
                showTherapistLoading(false);
            }
        }
        
        // Search Psychology Today directory (web scraping simulation)
        async function searchPsychologyTodayTherapists(location, params) {
            // In a real implementation, this would use their API or web scraping
            // For demo, we'll use a mock dataset with real-looking therapist data
            const mockTherapists = [
                {
                    id: 'pt_001',
                    name: 'Dr. Sarah Martinez, LCSW',
                    credentials: 'Licensed Clinical Social Worker',
                    specialties: ['Anxiety', 'Depression', 'LGBTQ+', 'Trauma'],
                    photo: 'https://images.unsplash.com/photo-1559839734-2b71ea197ec2?w=150&h=150&fit=crop&crop=faces',
                    phone: '(555) 123-4567',
                    email: 'sarah.martinez@therapy.com',
                    address: '123 Main St, Suite 200',
                    city: 'Local City',
                    state: 'State',
                    zipcode: '12345',
                    distance: 2.3,
                    rating: 4.8,
                    reviewCount: 42,
                    insurance: ['Aetna', 'Blue Cross Blue Shield', 'Cigna'],
                    languages: ['English', 'Spanish'],
                    gender: 'Female',
                    telehealth: true,
                    inPerson: true,
                    acceptingNew: true,
                    sessionFee: '$120-150',
                    website: 'https://sarahmartineztherapy.com',
                    bio: 'I specialize in helping individuals navigate anxiety, depression, and life transitions. My approach combines cognitive-behavioral therapy with mindfulness techniques.',
                    source: 'Psychology Today'
                },
                {
                    id: 'pt_002',
                    name: 'Michael Chen, PhD',
                    credentials: 'Licensed Psychologist',
                    specialties: ['Cognitive Behavioral Therapy', 'Addiction', 'Men\'s Issues'],
                    photo: 'https://images.unsplash.com/photo-1612349317150-e413f6a5b16d?w=150&h=150&fit=crop&crop=faces',
                    phone: '(555) 234-5678',
                    email: 'mchen@psychologypartners.com',
                    address: '456 Oak Avenue, Building B',
                    city: 'Local City',
                    state: 'State',
                    zipcode: '12346',
                    distance: 3.7,
                    rating: 4.9,
                    reviewCount: 38,
                    insurance: ['United Healthcare', 'Humana', 'Medicare'],
                    languages: ['English', 'Mandarin'],
                    gender: 'Male',
                    telehealth: true,
                    inPerson: true,
                    acceptingNew: true,
                    sessionFee: '$130-160',
                    website: 'https://drmichaelchen.com',
                    bio: 'I work with individuals struggling with addiction, anxiety, and relationship issues using evidence-based approaches.',
                    source: 'Psychology Today'
                },
                {
                    id: 'pt_003',
                    name: 'Dr. Emily Rodriguez, LMFT',
                    credentials: 'Licensed Marriage & Family Therapist',
                    specialties: ['Couples Therapy', 'Family Therapy', 'Communication Issues'],
                    photo: 'https://images.unsplash.com/photo-1594824263073-5634dae22d7f?w=150&h=150&fit=crop&crop=faces',
                    phone: '(555) 345-6789',
                    email: 'emily@familytherapycenter.com',
                    address: '789 Pine Street, Floor 3',
                    city: 'Local City',
                    state: 'State',
                    zipcode: '12347',
                    distance: 5.1,
                    rating: 4.7,
                    reviewCount: 56,
                    insurance: ['Kaiser Permanente', 'Blue Cross', 'Self-Pay'],
                    languages: ['English', 'Spanish'],
                    gender: 'Female',
                    telehealth: true,
                    inPerson: false,
                    acceptingNew: true,
                    sessionFee: '$110-140',
                    website: 'https://familytherapycenter.com/emily',
                    bio: 'I help couples and families improve communication and resolve conflicts through systemic therapy approaches.',
                    source: 'Psychology Today'
                }
            ];
            
            // Simulate API delay
            await new Promise(resolve => setTimeout(resolve, 800));
            
            return mockTherapists.filter(therapist => {
                if (params.specialty && !therapist.specialties.some(s => 
                    s.toLowerCase().includes(params.specialty.toLowerCase()))) return false;
                if (params.gender && therapist.gender.toLowerCase() !== params.gender.toLowerCase()) return false;
                if (params.insurance && !therapist.insurance.some(i => 
                    i.toLowerCase().includes(params.insurance.toLowerCase()))) return false;
                return true;
            });
        }
        
        // Search OpenPath directory (affordable therapy)
        async function searchOpenPathTherapists(location, params) {
            const mockOpenPathTherapists = [
                {
                    id: 'op_001',
                    name: 'Jessica Thompson, LPCC',
                    credentials: 'Licensed Professional Clinical Counselor',
                    specialties: ['Anxiety', 'Depression', 'Self-Esteem'],
                    photo: 'https://images.unsplash.com/photo-1582750433449-648ed127bb54?w=150&h=150&fit=crop&crop=faces',
                    phone: '(555) 456-7890',
                    email: 'jessica@openpatcounseling.com',
                    address: '321 Elm Street, Suite 45',
                    city: 'Local City',
                    state: 'State',
                    zipcode: '12348',
                    distance: 4.2,
                    rating: 4.6,
                    reviewCount: 28,
                    insurance: ['Sliding Scale', 'OpenPath'],
                    languages: ['English'],
                    gender: 'Female',
                    telehealth: true,
                    inPerson: true,
                    acceptingNew: true,
                    sessionFee: '$60-80',
                    website: 'https://openpath.com/jessica-thompson',
                    bio: 'I provide affordable therapy with a focus on anxiety and depression using person-centered approaches.',
                    source: 'OpenPath'
                }
            ];
            
            await new Promise(resolve => setTimeout(resolve, 600));
            return mockOpenPathTherapists;
        }
        
        // Search TherapyDen directory
        async function searchTherapyDenTherapists(location, params) {
            const mockTherapyDenTherapists = [
                {
                    id: 'td_001',
                    name: 'Robert Kim, LCSW',
                    credentials: 'Licensed Clinical Social Worker',
                    specialties: ['Trauma', 'EMDR', 'PTSD', 'Veterans'],
                    photo: 'https://images.unsplash.com/photo-1607990281513-2c110a25bd8c?w=150&h=150&fit=crop&crop=faces',
                    phone: '(555) 567-8901',
                    email: 'robert@traumacenter.org',
                    address: '654 Veterans Blvd, Suite 12',
                    city: 'Local City',
                    state: 'State',
                    zipcode: '12349',
                    distance: 6.8,
                    rating: 4.9,
                    reviewCount: 34,
                    insurance: ['Tricare', 'VA Benefits', 'Aetna'],
                    languages: ['English', 'Korean'],
                    gender: 'Male',
                    telehealth: true,
                    inPerson: true,
                    acceptingNew: true,
                    sessionFee: '$140-170',
                    website: 'https://therapyden.com/robert-kim',
                    bio: 'I specialize in trauma therapy for veterans and first responders using EMDR and somatic approaches.',
                    source: 'TherapyDen'
                }
            ];
            
            await new Promise(resolve => setTimeout(resolve, 700));
            return mockTherapyDenTherapists;
        }
        
        // Remove duplicate therapists
        function deduplicateTherapists(therapists) {
            const seen = new Set();
            return therapists.filter(therapist => {
                const key = `${therapist.name.toLowerCase()}_${therapist.phone}`;
                if (seen.has(key)) return false;
                seen.add(key);
                return true;
            });
        }
        
        // REMOVED: Modal functionality - now using direct page navigation
        // Old openTherapistModal function removed - therapist finder uses separate page
        async function openTherapistModal_DISABLED() {
            console.log('ðŸ” Opening therapist finder...');
            
            // Create modal if it doesn't exist
            if (!document.getElementById('therapistModal')) {
                createTherapistModal();
            }
            
            const modal = document.getElementById('therapistModal');
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            
            // Get user location
            try {
                showLocationStatus('Getting your location...');
                await getUserLocation();
                showLocationStatus('Location found! Ready to search.');
                document.getElementById('searchTherapistsBtn').disabled = false;
            } catch (error) {
                console.error('Location error:', error);
                showLocationStatus('Location access denied. You can still search by entering a city/zip.');
                document.getElementById('manualLocationInput').style.display = 'block';
            }
        }
        
        // Create therapist search modal
        function createTherapistModal() {
            const modalHTML = `
                <div id="therapistModal" class="therapist-modal" style="display: none;">
                    <div class="therapist-modal-content">
                        <div class="therapist-modal-header">
                            <h2 style="color: #60a5fa; margin: 0; display: flex; align-items: center; gap: 10px;">
                                <svg width="24" height="24" fill="currentColor" viewBox="0 0 448 512">
                                    <path d="M224 256c70.7 0 128-57.3 128-128S294.7 0 224 0 96 57.3 96 128s57.3 128 128 128zM104 424c0 13.3 10.7 24 24 24s24-10.7 24-24-10.7-24-24-24-24 10.7-24 24zm216-135.4v49c36.5 7.4 64 39.8 64 78.4v41.7c0 7.6-5.4 14.2-12.9 15.7l-32.2 6.4c-4.3.9-8.5-1.9-9.4-6.3l-3.1-15.7c-.9-4.3 1.9-8.6 6.3-9.4l19.3-3.9V416c0-62.8-96-65.1-96 1.9v26.7l19.3 3.9c4.3.9 7.1 5.1 6.3 9.4l-3.1 15.7c-.9 4.3-5.1 7.1-9.4 6.3l-31.2-4.2c-7.9-1.1-13.8-7.8-13.8-15.9V416c0-38.6 27.5-70.9 64-78.4v-45.2c-2.2.7-4.4 1.1-6.6 1.9-18 6.3-37.3 9.8-57.4 9.8s-39.4-3.5-57.4-9.8c-7.4-2.6-14.9-4.2-22.6-5.2v81.6c23.1 6.9 40 28.1 40 53.4 0 30.9-25.1 56-56 56s-56-25.1-56-56c0-25.3 16.9-46.5 40-53.4v-80.4C48.5 301 0 355.8 0 422.4v44.8C0 491.9 20.1 512 44.8 512h358.4c24.7 0 44.8-20.1 44.8-44.8v-44.8c0-72-56.8-130.3-128-133.8z"/>
                                </svg>
                                Find Mental Health Professionals
                            </h2>
                            <button id="closeTherapistModal" class="close-button">&times;</button>
                        </div>
                        
                        <div class="therapist-search-section">
                            <div id="locationStatus" class="location-status">
                                <div class="location-loading">ðŸ“ Click "Search" to find therapists near you</div>
                            </div>
                            
                            <div id="manualLocationInput" style="display: none; margin: 15px 0;">
                                <input type="text" id="manualLocation" placeholder="Enter city, state or zip code" 
                                       style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid rgba(100, 100, 255, 0.3); background: rgba(30, 30, 30, 0.8); color: white;">
                            </div>
                            
                            <div class="search-filters">
                                <div class="filter-row">
                                    <select id="specialtyFilter" class="filter-select">
                                        <option value="">All Specialties</option>
                                        <option value="anxiety">Anxiety</option>
                                        <option value="depression">Depression</option>
                                        <option value="trauma">Trauma & PTSD</option>
                                        <option value="couples">Couples Therapy</option>
                                        <option value="family">Family Therapy</option>
                                        <option value="addiction">Addiction</option>
                                        <option value="lgbtq">LGBTQ+</option>
                                        <option value="grief">Grief & Loss</option>
                                    </select>
                                    
                                    <select id="insuranceFilter" class="filter-select">
                                        <option value="">All Insurance</option>
                                        <option value="aetna">Aetna</option>
                                        <option value="blue cross">Blue Cross Blue Shield</option>
                                        <option value="cigna">Cigna</option>
                                        <option value="united">United Healthcare</option>
                                        <option value="kaiser">Kaiser Permanente</option>
                                        <option value="medicaid">Medicaid</option>
                                        <option value="self-pay">Self-Pay/Sliding Scale</option>
                                    </select>
                                </div>
                                
                                <div class="filter-row">
                                    <select id="genderFilter" class="filter-select">
                                        <option value="">Any Gender</option>
                                        <option value="female">Female</option>
                                        <option value="male">Male</option>
                                        <option value="non-binary">Non-Binary</option>
                                    </select>
                                    
                                    <select id="sessionTypeFilter" class="filter-select">
                                        <option value="">Any Session Type</option>
                                        <option value="telehealth">Telehealth Only</option>
                                        <option value="in-person">In-Person Only</option>
                                        <option value="both">Both Options</option>
                                    </select>
                                </div>
                            </div>
                            
                            <button id="searchTherapistsBtn" class="search-therapists-btn" disabled>
                                ðŸ” Search Therapists Near Me
                            </button>
                        </div>
                        
                        <div id="therapistLoading" class="therapist-loading" style="display: none;">
                            <div class="loading-spinner"></div>
                            <p>Searching mental health professionals...</p>
                        </div>
                        
                        <div id="therapistResults" class="therapist-results"></div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            setupTherapistModalEvents();
        }
        
        // Setup modal event listeners
        function setupTherapistModalEvents() {
            document.getElementById('closeTherapistModal').addEventListener('click', closeTherapistModal);
            document.getElementById('therapistModal').addEventListener('click', (e) => {
                if (e.target.id === 'therapistModal') closeTherapistModal();
            });
            document.getElementById('searchTherapistsBtn').addEventListener('click', performTherapistSearch);
        }
        
        // Close therapist modal
        function closeTherapistModal() {
            document.getElementById('therapistModal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }
        
        // Show location status
        function showLocationStatus(message) {
            const statusEl = document.getElementById('locationStatus');
            statusEl.innerHTML = `<div class="location-loading">ðŸ“ ${message}</div>`;
        }
        
        // Show/hide loading state
        function showTherapistLoading(show) {
            const loading = document.getElementById('therapistLoading');
            const results = document.getElementById('therapistResults');
            
            if (show) {
                loading.style.display = 'block';
                results.style.display = 'none';
            } else {
                loading.style.display = 'none';
                results.style.display = 'block';
            }
        }
        
        // Perform therapist search
        async function performTherapistSearch() {
            const specialty = document.getElementById('specialtyFilter').value;
            const insurance = document.getElementById('insuranceFilter').value;
            const gender = document.getElementById('genderFilter').value;
            const sessionType = document.getElementById('sessionTypeFilter').value;
            
            const searchParams = {
                specialty,
                insurance,
                gender,
                sessionType
            };
            
            try {
                let searchLocation = userLocation;
                
                // If no GPS location, try manual input
                if (!searchLocation) {
                    const manualInput = document.getElementById('manualLocation')?.value;
                    if (manualInput) {
                        // In a real app, you'd geocode this address
                        searchLocation = { lat: 40.7128, lng: -74.0060 }; // NYC default
                    } else {
                        throw new Error('Please enable location or enter a city/zip code');
                    }
                }
                
                const therapists = await searchTherapists(searchLocation, searchParams);
                therapistSearchResults = therapists;
                displayTherapistResults(therapists);
                
            } catch (error) {
                console.error('Search error:', error);
                displayTherapistError(error.message);
            }
        }
        
        // Display therapist search results
        function displayTherapistResults(therapists) {
            const resultsContainer = document.getElementById('therapistResults');
            
            if (!therapists || therapists.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="no-results">
                        <h3>No therapists found</h3>
                        <p>Try adjusting your search filters or expanding your search area.</p>
                    </div>
                `;
                return;
            }
            
            resultsContainer.innerHTML = `
                <div class="results-header">
                    <h3>Found ${therapists.length} Mental Health Professionals</h3>
                    <p style="color: #b0b0b0; margin-top: 5px;">Sorted by distance and rating</p>
                </div>
                
                <div class="therapist-list">
                    ${therapists.map(therapist => createTherapistCard(therapist)).join('')}
                </div>
            `;
        }
        
        // Create individual therapist card
        function createTherapistCard(therapist) {
            return `
                <div class="therapist-card" data-therapist-id="${therapist.id}">
                    <div class="therapist-photo">
                        <img src="${therapist.photo}" alt="${therapist.name}" onerror="this.src='data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"80\" height=\"80\" viewBox=\"0 0 80 80\"><rect width=\"80\" height=\"80\" fill=\"%23444\"/><text x=\"40\" y=\"45\" text-anchor=\"middle\" fill=\"white\" font-size=\"14\">${therapist.name.split(' ')[0][0]}${therapist.name.split(' ')[1] ? therapist.name.split(' ')[1][0] : ''}</text></svg>'">
                    </div>
                    
                    <div class="therapist-info">
                        <div class="therapist-header">
                            <h4>${therapist.name}</h4>
                            <div class="therapist-rating">
                                ${'â˜…'.repeat(Math.floor(therapist.rating))}${'â˜†'.repeat(5-Math.floor(therapist.rating))}
                                <span>(${therapist.reviewCount} reviews)</span>
                            </div>
                        </div>
                        
                        <div class="therapist-credentials">
                            <span class="credential-badge">${therapist.credentials}</span>
                            <span class="distance-badge">${therapist.distance} miles</span>
                            ${therapist.acceptingNew ? '<span class="accepting-badge">Accepting New Clients</span>' : '<span class="not-accepting-badge">Not Accepting</span>'}
                        </div>
                        
                        <div class="therapist-specialties">
                            <strong>Specializes in:</strong> ${therapist.specialties.slice(0, 3).join(', ')}
                            ${therapist.specialties.length > 3 ? ` +${therapist.specialties.length - 3} more` : ''}
                        </div>
                        
                        <div class="therapist-details">
                            <div class="detail-row">
                                <span><strong>Session Fee:</strong> ${therapist.sessionFee}</span>
                                <span><strong>Languages:</strong> ${therapist.languages.join(', ')}</span>
                            </div>
                            <div class="detail-row">
                                <span><strong>Insurance:</strong> ${therapist.insurance.slice(0, 2).join(', ')}${therapist.insurance.length > 2 ? ' +more' : ''}</span>
                                <span><strong>Options:</strong> ${therapist.telehealth && therapist.inPerson ? 'Telehealth & In-Person' : therapist.telehealth ? 'Telehealth Only' : 'In-Person Only'}</span>
                            </div>
                        </div>
                        
                        <div class="therapist-bio">
                            <p>${therapist.bio}</p>
                        </div>
                        
                        <div class="therapist-actions">
                            <button class="contact-btn primary" onclick="contactTherapist('${therapist.id}', 'phone')">
                                ðŸ“ž Call ${therapist.phone}
                            </button>
                            <button class="contact-btn secondary" onclick="contactTherapist('${therapist.id}', 'email')">
                                âœ‰ï¸ Email
                            </button>
                            <button class="contact-btn secondary" onclick="viewTherapistProfile('${therapist.id}')">
                                ðŸ”— View Profile
                            </button>
                        </div>
                        
                        <div class="therapist-source">
                            <small>Source: ${therapist.source}</small>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Display error message
        function displayTherapistError(message) {
            const resultsContainer = document.getElementById('therapistResults');
            resultsContainer.innerHTML = `
                <div class="error-message">
                    <h3>Search Error</h3>
                    <p>${message}</p>
                    <button onclick="performTherapistSearch()" class="retry-btn">Try Again</button>
                </div>
            `;
        }
        
        // Contact therapist functions
        function contactTherapist(therapistId, method) {
            const therapist = therapistSearchResults.find(t => t.id === therapistId);
            if (!therapist) return;
            
            if (method === 'phone') {
                window.open(`tel:${therapist.phone}`, '_self');
            } else if (method === 'email') {
                window.open(`mailto:${therapist.email}?subject=Therapy Inquiry&body=Hello ${therapist.name},%0D%0A%0D%0AI found your profile through Y.M.I.R AI and would like to inquire about your services.%0D%0A%0D%0AThank you!`, '_self');
            }
            
            // Track contact attempt
            if (window.ymirAuth) {
                window.ymirAuth.saveData('therapistContacts', {
                    therapistId: therapist.id,
                    therapistName: therapist.name,
                    contactMethod: method,
                    timestamp: new Date()
                });
            }
        }
        
        function viewTherapistProfile(therapistId) {
            const therapist = therapistSearchResults.find(t => t.id === therapistId);
            if (!therapist) return;
            
            if (therapist.website) {
                window.open(therapist.website, '_blank');
            } else {
                alert('Profile website not available for this therapist.');
            }
        }
        
        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            initializeTherapistFinder();
        });
        
        // =================== END THERAPIST FINDER ===================
    </script>

    <!-- Professional Music Player Popup -->
    <div id="musicPlayerPopup" class="music-player-popup">
        <!-- ðŸ”§ RESIZE HANDLES -->
        <!-- Corner Handles -->
        <div class="resize-handle resize-corner resize-nw" data-resize="nw"></div>
        <div class="resize-handle resize-corner resize-ne" data-resize="ne"></div>
        <div class="resize-handle resize-corner resize-sw" data-resize="sw"></div>
        <div class="resize-handle resize-corner resize-se" data-resize="se"></div>
        
        <!-- Border Handles -->
        <div class="resize-handle resize-border resize-n" data-resize="n"></div>
        <div class="resize-handle resize-border resize-s" data-resize="s"></div>
        <div class="resize-handle resize-border resize-w" data-resize="w"></div>
        <div class="resize-handle resize-border resize-e" data-resize="e"></div>

        <!-- Wind Leaves Animation -->
        <div class="wind-animation" id="windAnimation">
            <div class="wind-particle"></div>
            <div class="wind-particle"></div>
            <div class="wind-particle"></div>
            <div class="wind-particle"></div>
            <div class="wind-particle"></div>
        </div>

        <!-- Loading Message -->
        <div class="loading-message" id="loadingMessage" style="display: none;">
            <div class="music-loading-icon">ðŸŽµ</div>
            <div class="loading-dots">
                <div class="loading-dot"></div>
                <div class="loading-dot"></div>
                <div class="loading-dot"></div>
            </div>
        </div>

        <!-- Player Content -->
        <div class="player-content" id="playerContent">
            <!-- Close Button -->
            <button class="close-player-btn" id="closePlayerBtn">âœ•</button>

            <!-- Album Art Section -->
            <div class="album-art-section">
                <div class="album-art" id="albumArt"></div>
            </div>

            <!-- Song Info -->
            <div class="song-info">
                <div class="song-title" id="songTitle">Select a song</div>
                <div class="song-artist" id="songArtist">Artist name</div>
            </div>

            <!-- Progress Section -->
            <div class="progress-section">
                <div class="progress-bar" id="progressBar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="time-display">
                    <span id="currentTime">0:00</span>
                    <span id="totalTime">0:00</span>
                </div>
            </div>

            <!-- Player Controls -->
            <div class="player-controls">
                <button class="control-btn" id="prevBtn">â®</button>
                <button class="control-btn play-pause-btn" id="playPauseBtn">â–¶</button>
                <button class="control-btn" id="nextBtn">â­</button>
            </div>

            <!-- Volume Control -->
            <div class="volume-section">
                <span class="volume-icon">ðŸ”Š</span>
                <input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" value="70">
            </div>

            <!-- Hidden Audio Element -->
            <audio id="audioPlayer" preload="none"></audio>
        </div>
    </div>

    <!-- Minimized Music Player -->
    <div id="miniPlayer" class="mini-player">
        <div class="mini-album-art" id="miniAlbumArt"></div>
        <div class="mini-song-info">
            <div class="mini-song-title" id="miniSongTitle">Select a song</div>
            <div class="mini-song-artist" id="miniSongArtist">Artist name</div>
        </div>
        <div class="mini-controls">
            <button class="mini-control-btn" id="miniPrevBtn">â®</button>
            <button class="mini-control-btn mini-play-pause-btn" id="miniPlayPauseBtn">â–¶</button>
            <button class="mini-control-btn" id="miniNextBtn">â­</button>
            <button class="mini-control-btn mini-expand-btn" id="miniExpandBtn">â¬†</button>
            <button class="mini-control-btn mini-close-btn" id="miniCloseBtn">âœ•</button>
        </div>
        <div class="mini-progress" id="miniProgress"></div>
    </div>

{% include 'footer.html' %}

<!-- Font Awesome for icons -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/js/all.min.js"></script>

<!-- Firebase Authentication System -->
<script src="{{ url_for('static', filename='js/firebase-auth.js') }}"></script>

<script>
// Integration with existing Y.M.I.R functionality
document.addEventListener('DOMContentLoaded', function() {
    console.log('ðŸš€ Y.M.I.R Dashboard with Authentication Ready');
    
    // Listen for user state changes
    document.addEventListener('userStateChange', function(event) {
        const { state, user, isTemporary, data } = event.detail;
        
        console.log(`ðŸ‘¤ User state changed to: ${state}`);
        
        if (state === 'authenticated') {
            console.log(`âœ… User ${user.email} signed in successfully`);
            // Trigger data sync or UI updates for authenticated users
            onUserAuthenticated(user, data);
        } else {
            console.log('â±ï¸ Operating in temporary mode');
            // Handle temporary user mode
            onTemporaryMode(data);
        }
    });
    
    // Override existing data saving functions to use Firebase Auth
    if (window.ymirAuth) {
        // Replace emotion saving with authenticated saving
        window.saveEmotionData = function(emotionData) {
            return window.ymirAuth.saveData('emotions', emotionData);
        };
        
        // Replace conversation saving
        window.saveChatMessage = function(messageData) {
            return window.ymirAuth.saveData('conversations', messageData);
        };
        
        // Replace music history saving
        window.saveMusicHistory = function(musicData) {
            return window.ymirAuth.saveData('musicHistory', musicData);
        };
        
        console.log('ðŸ”— Integrated authentication with existing Y.M.I.R functions');
    }
});

function onUserAuthenticated(user, temporaryData) {
    // Show welcome message if there was temporary data migrated
    if (temporaryData.emotions.length > 0 || temporaryData.conversations.length > 0) {
        showNotification('âœ… Welcome back! Your temporary session data has been saved to your account.', 'success');
    }
    
    // Update UI to show authenticated features
    updateDashboardForAuthenticatedUser(user);
    
    // Load user's historical data
    loadUserHistory(user);
}

function onTemporaryMode(data) {
    // Show temporary mode indicators
    updateDashboardForTemporaryUser();
    
    // Periodically remind users to sign in if they have significant data
    if (data.emotions.length > 5 || data.conversations.length > 3) {
        setTimeout(() => {
            showNotification('ðŸ’¾ You have unsaved emotion data. Sign in to preserve your progress!', 'info');
        }, 30000); // Show after 30 seconds
    }
}

function updateDashboardForAuthenticatedUser(user) {
    // Add any user-specific UI elements
    console.log('ðŸŽ¨ Updating dashboard for authenticated user');
    
    // Enable advanced features for authenticated users
    enableAdvancedFeatures();
}

function updateDashboardForTemporaryUser() {
    // Show temporary user limitations
    console.log('â±ï¸ Dashboard in temporary mode');
    
    // Limit certain features or show prompts
    showTemporaryUserPrompts();
}

// ====================================================
// ðŸš€ ADVANCED SESSION ANALYTICS & PRIVACY FEATURES
// ====================================================

// Session Analytics Variables
let sessionAnalytics = {
    totalReadings: 0,
    emotionCounts: {},
    confidenceSum: 0,
    sessionStart: new Date(),
    processingFPS: 0,
    activeModels: 3, // MediaPipe, DeepFace, YOLO
    totalFrames: 0,
    lastFrameTime: 0,
    emotionHistory: []
};

// Privacy Mode State
window.privacyModeActive = false;

// Current emotion tracking for analytics
let currentEmotion = 'neutral';
let currentConfidence = 0.0;

// Track last facial emotion for music updates
window.lastFacialEmotion = null;

// Enhanced insights tracking with advanced session analytics
function updateAdvancedInsights(emotion, confidence) {
    currentEmotion = emotion || 'neutral';
    currentConfidence = confidence || 0.0;
    
    const insights = document.getElementById('emotionInsights');
    if (insights) {
        const now = new Date();
        
        // Update session analytics
        sessionAnalytics.totalReadings++;
        sessionAnalytics.emotionCounts[currentEmotion] = (sessionAnalytics.emotionCounts[currentEmotion] || 0) + 1;
        sessionAnalytics.confidenceSum += currentConfidence;
        sessionAnalytics.totalFrames++;
        
        // Store emotion history
        sessionAnalytics.emotionHistory.push({
            emotion: currentEmotion,
            confidence: currentConfidence,
            timestamp: now.toISOString()
        });
        
        // Calculate processing FPS
        const currentTime = performance.now();
        if (sessionAnalytics.lastFrameTime > 0) {
            const frameDelta = currentTime - sessionAnalytics.lastFrameTime;
            sessionAnalytics.processingFPS = Math.round(1000 / frameDelta);
        }
        sessionAnalytics.lastFrameTime = currentTime;
        
        const avgConfidence = sessionAnalytics.totalReadings > 0 ? 
            (sessionAnalytics.confidenceSum / sessionAnalytics.totalReadings * 100).toFixed(1) : 0;
        
        const sessionDuration = Math.floor((now - sessionAnalytics.sessionStart) / 1000);
        const minutes = Math.floor(sessionDuration / 60);
        const seconds = sessionDuration % 60;
        
        // Get storage status
        const storageStatus = window.ymirAuth ? 
            (window.ymirAuth.getUserStatus().isAuthenticated ? 'Cloud Synced' : 'Local Storage') : 
            'Session Only';
        
        insights.innerHTML = `
            <div class="insight-item">
                <span class="insight-label">Current Emotion:</span>
                <span class="insight-value emotion-badge" style="background: ${getEmotionColor(currentEmotion)}; padding: 2px 8px; border-radius: 12px; color: white; font-weight: 600;">${currentEmotion.toUpperCase()}</span>
            </div>
            <div class="insight-item">
                <span class="insight-label">Live Confidence:</span>
                <span class="insight-value confidence-meter" style="color: ${confidence > 0.7 ? '#22c55e' : confidence > 0.5 ? '#f59e0b' : '#ef4444'};">${currentConfidence ? (currentConfidence * 100).toFixed(1) + '%' : 'N/A'}</span>
            </div>
            <div class="insight-item">
                <span class="insight-label">Total Readings:</span>
                <span class="insight-value">${sessionAnalytics.totalReadings}</span>
            </div>
            <div class="insight-item">
                <span class="insight-label">Average Confidence:</span>
                <span class="insight-value">${avgConfidence}%</span>
            </div>
            <div class="insight-item">
                <span class="insight-label">Processing FPS:</span>
                <span class="insight-value fps-indicator" style="color: ${sessionAnalytics.processingFPS > 15 ? '#22c55e' : sessionAnalytics.processingFPS > 10 ? '#f59e0b' : '#ef4444'};">${sessionAnalytics.processingFPS} FPS</span>
            </div>
            <div class="insight-item">
                <span class="insight-label">Active Models:</span>
                <span class="insight-value model-count" style="color: #4fd1c7;">${sessionAnalytics.activeModels}/3</span>
            </div>
            <div class="insight-item">
                <span class="insight-label">Total Frames:</span>
                <span class="insight-value">${sessionAnalytics.totalFrames.toLocaleString()}</span>
            </div>
            <div class="insight-item">
                <span class="insight-label">Session Duration:</span>
                <span class="insight-value">${minutes}:${seconds.toString().padStart(2, '0')}</span>
            </div>
            <div class="insight-item">
                <span class="insight-label">Storage Status:</span>
                <span class="insight-value storage-status" style="color: ${storageStatus === 'Cloud Synced' ? '#22c55e' : storageStatus === 'Local Storage' ? '#f59e0b' : '#6b7280'};">${storageStatus}</span>
            </div>
        `;
    }
}

// Get emotion color for visual indicators
function getEmotionColor(emotion) {
    const emotionColors = {
        'happy': '#22c55e',
        'sad': '#3b82f6',
        'angry': '#ef4444',
        'fear': '#8b5cf6',
        'surprise': '#f59e0b',
        'disgust': '#84cc16',
        'neutral': '#6b7280',
        'calm': '#06d6a0',
        'energetic': '#f97316'
    };
    return emotionColors[emotion.toLowerCase()] || '#6b7280';
}

// ðŸ”§ Initialize Y.M.I.R Dashboard Functions
document.addEventListener('DOMContentLoaded', function() {
    console.log('ðŸ”§ Initializing Y.M.I.R dashboard functions...');
    
    // Ensure functions are globally accessible for onclick handlers
    window.togglePrivacyMode = window.togglePrivacyMode || function() {
        console.log('ðŸ”’ Privacy mode fallback - reloading to fix');
        alert('ðŸ”’ Privacy mode is initializing. Refreshing page...');
        setTimeout(() => window.location.reload(), 1000);
    };
    
    window.exportSessionData = window.exportSessionData || function() {
        console.log('ðŸ’¾ Export fallback - basic export');
        const data = {
            timestamp: new Date().toISOString(),
            session: window.sessionAnalytics || {},
            message: 'Basic export - full features loading'
        };
        const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `YMIR_BasicExport_${Date.now()}.json`;
        link.click();
    };
    
    window.refreshStatus = window.refreshStatus || function() {
        console.log('ðŸ”„ Refresh fallback - refreshing data only');
        if (typeof showAdvancedNotification === 'function') {
            showAdvancedNotification('ðŸ”„ Refreshing dashboard data...', 'info', 2000);
        } else {
            alert('ðŸ”„ Refreshing dashboard data...');
        }
        // Refresh data without page reload
        location.hash = location.hash; // Trigger any hash-based refreshes without full reload
    };
    
    // Ensure notification function exists
    window.showAdvancedNotification = window.showAdvancedNotification || function(message, type = 'info', duration = 3000) {
        console.log(`ðŸ“¢ ${type.toUpperCase()}: ${message}`);
        // Simple fallback notification
        const toast = document.createElement('div');
        toast.style.cssText = `
            position: fixed; top: 20px; right: 20px; z-index: 10000;
            background: ${type === 'error' ? '#ef4444' : type === 'success' ? '#22c55e' : '#3b82f6'};
            color: white; padding: 12px 20px; border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            transform: translateX(100%); transition: transform 0.3s ease;
        `;
        toast.textContent = message;
        document.body.appendChild(toast);
        
        setTimeout(() => toast.style.transform = 'translateX(0)', 100);
        setTimeout(() => {
            toast.style.transform = 'translateX(100%)';
            setTimeout(() => document.body.removeChild(toast), 300);
        }, duration);
    };
    
    console.log('âœ… Y.M.I.R dashboard functions initialized');
});

// Privacy Mode Implementation - Global function
window.togglePrivacyMode = function() {
    console.log('ðŸ”’ Toggling privacy mode...');
    
    const videoElement = document.getElementById('video');
    const privacyBtn = document.querySelector('[onclick="togglePrivacyMode()"]');
    const privacyToggle = document.getElementById('privacyToggle');
    const existingOverlay = document.getElementById('privacyOverlay');
    
    if (!existingOverlay) {
        // Enable privacy mode - blur all video elements and add overlay
        console.log('ðŸ”’ Enabling privacy mode - blurring video');
        
        // Create privacy overlay
        const privacyOverlay = document.createElement('div');
        privacyOverlay.id = 'privacyOverlay';
        privacyOverlay.style.cssText = `
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(25px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            border-radius: 12px;
            transition: all 0.3s ease;
        `;
        privacyOverlay.innerHTML = `
            <div style="text-align: center; color: white;">
                <div style="font-size: 48px; margin-bottom: 16px;">ðŸ”’</div>
                <h3 style="margin-bottom: 8px; font-size: 18px;">Privacy Mode Active</h3>
                <p style="color: rgba(255,255,255,0.8); font-size: 14px;">Video feed is protected</p>
                <button onclick="togglePrivacyMode()" style="
                    background: rgba(59, 130, 246, 0.2);
                    border: 1px solid #3b82f6;
                    color: #60a5fa;
                    padding: 8px 16px;
                    border-radius: 8px;
                    cursor: pointer;
                    margin-top: 12px;
                ">ðŸ”“ Disable Privacy</button>
            </div>
        `;
        
        // Apply blur to video elements
        if (videoElement) {
            videoElement.style.filter = 'blur(30px)';
            videoElement.style.transition = 'filter 0.3s ease';
        }
        
        // Find video containers and add overlay
        const videoContainer = document.getElementById('videoContainer');
        const cameraContainer = document.querySelector('.camera-container');
        const videoFeed = document.querySelector('.video-feed');
        
        [videoContainer, cameraContainer, videoFeed].forEach(container => {
            if (container) {
                container.style.position = 'relative';
                container.style.filter = 'blur(30px)';
                container.style.transition = 'filter 0.3s ease';
                container.appendChild(privacyOverlay.cloneNode(true));
            }
        });
        
        // Apply blur to any iframe or img in video areas
        document.querySelectorAll('#videoContainer iframe, #videoContainer img, .camera-container iframe, .camera-container img').forEach(element => {
            element.style.filter = 'blur(30px)';
            element.style.transition = 'filter 0.3s ease';
        });
        
        // Update button states
        if (privacyBtn) privacyBtn.innerHTML = '<span>ðŸ”“</span> Show Camera';
        if (privacyToggle) {
            privacyToggle.innerHTML = 'ðŸ”“ Show Camera';
            privacyToggle.style.background = 'rgba(34, 197, 94, 0.2)';
            privacyToggle.style.color = '#22c55e';
            privacyToggle.style.borderColor = '#22c55e';
        }
        
        console.log('âœ… Privacy mode enabled');
        
    } else {
        // Disable privacy mode - remove ALL overlays and blur effects
        console.log('ðŸ”“ Disabling privacy mode - removing all overlays and blur');
        
        // Remove all privacy overlays (not just the one with ID)
        document.querySelectorAll('[id^="privacyOverlay"], .privacy-overlay').forEach(overlay => {
            overlay.remove();
        });
        
        // Remove blur from video element
        if (videoElement) {
            videoElement.style.filter = 'none';
        }
        
        // Remove blur from all video containers
        const videoContainer = document.getElementById('videoContainer');
        const cameraContainer = document.querySelector('.camera-container');
        const videoFeed = document.querySelector('.video-feed');
        
        [videoContainer, cameraContainer, videoFeed].forEach(container => {
            if (container) {
                container.style.filter = 'none';
            }
        });
        
        // Remove blur from all iframe and img elements
        document.querySelectorAll('#videoContainer iframe, #videoContainer img, .camera-container iframe, .camera-container img').forEach(element => {
            element.style.filter = 'none';
        });
        
        // Update button states
        if (privacyBtn) privacyBtn.innerHTML = '<span>ðŸ”’</span> Privacy';
        if (privacyToggle) {
            privacyToggle.innerHTML = 'ðŸ”’ Privacy';
            privacyToggle.style.background = 'rgba(239, 68, 68, 0.2)';
            privacyToggle.style.color = '#ef4444';
            privacyToggle.style.borderColor = '#ef4444';
        }
        
        if (typeof showAdvancedNotification === 'function') {
            showAdvancedNotification('ðŸ‘ï¸ Privacy Mode Disabled', 'success');
        }
        
        console.log('âœ… Privacy mode disabled - all overlays and blur removed');
    }
}

// Export Session Data Implementation - Global function
window.exportSessionData = function() {
    try {
        console.log('ðŸ’¾ Exporting session data...');
        if (typeof showAdvancedNotification === 'function') {
            showAdvancedNotification('ðŸ’¾ Preparing session export...', 'info', 2000);
        } else {
            console.log('ðŸ’¾ Preparing session export...');
        }
        
        // Get current session data
        const sessionId = window.ymirAuth?.getUserStatus()?.sessionId || `guest_${Date.now()}`;
        const now = new Date();
        const sessionDuration = Math.floor((now - sessionAnalytics.sessionStart) / 1000);
        
        // Get dominant emotion from session
        const dominantEmotion = Object.entries(sessionAnalytics.emotionCounts)
            .sort(([,a], [,b]) => b - a)[0]?.[0] || 'neutral';
        
        // Prepare CSV data for emotion logs
        const csvData = [];
        csvData.push(['Timestamp', 'Emotion', 'Confidence', 'Model', 'Session_ID', 'Duration_Seconds']);
        
        // Add emotion timeline to CSV
        sessionAnalytics.emotionHistory.forEach((entry, index) => {
            csvData.push([
                entry.timestamp || new Date(sessionAnalytics.sessionStart.getTime() + (index * 1000)).toISOString(),
                entry.emotion || 'unknown',
                entry.confidence || 0,
                entry.model || 'combined',
                sessionId,
                index + 1
            ]);
        });
        
        // Add current emotions if available
        if (window.lastEmotionData) {
            csvData.push([
                now.toISOString(),
                window.lastEmotionData.emotion || 'unknown',
                window.lastEmotionData.confidence || 0,
                'current_reading',
                sessionId,
                sessionDuration
            ]);
        }
        
        // Create CSV content
        const csvContent = csvData.map(row => 
            row.map(field => `"${field}"`).join(',')
        ).join('\n');
        
        // Prepare JSON export data
        const jsonExportData = {
            metadata: {
                exportedAt: now.toISOString(),
                sessionId: sessionId,
                startTime: sessionAnalytics.sessionStart.toISOString(),
                endTime: now.toISOString(),
                duration: sessionDuration,
                totalReadings: sessionAnalytics.totalReadings,
                dominantEmotion: dominantEmotion
            },
            analytics: {
                emotionCounts: sessionAnalytics.emotionCounts,
                averageConfidence: sessionAnalytics.totalReadings > 0 ? 
                    (sessionAnalytics.confidenceSum / sessionAnalytics.totalReadings).toFixed(2) : 0,
                emotionDistribution: Object.entries(sessionAnalytics.emotionCounts).map(([emotion, count]) => ({
                    emotion,
                    count,
                    percentage: sessionAnalytics.totalReadings > 0 ? 
                        ((count / sessionAnalytics.totalReadings) * 100).toFixed(1) : '0.0'
                }))
            },
            emotionTimeline: sessionAnalytics.emotionHistory,
            systemInfo: {
                userAgent: navigator.userAgent,
                platform: navigator.platform,
                language: navigator.language,
                screenResolution: `${screen.width}x${screen.height}`,
                privacyModeUsed: !!window.privacyModeActive,
                activeModels: ['MediaPipe Face Mesh', 'DeepFace', 'YOLO Detection'],
                features: ['Facial Expression Analysis', 'Body Pose Detection', 'Hand Tracking', 'Gaze Tracking']
            },
            privacyInfo: {
                dataRetentionPeriod: '24 hours',
                encryptionUsed: true,
                anonymized: !window.ymirAuth?.getUserStatus()?.isAuthenticated
            }
        };
        
        // Create and download CSV file
        const csvBlob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const csvFilename = `YMIR_EmotionLogs_${sessionId}_${now.toISOString().split('T')[0]}.csv`;
        
        // Create and download JSON file
        const jsonBlob = new Blob([JSON.stringify(jsonExportData, null, 2)], { type: 'application/json' });
        const jsonFilename = `YMIR_SessionData_${sessionId}_${now.toISOString().split('T')[0]}.json`;
        
        // Download CSV
        const csvLink = document.createElement('a');
        csvLink.href = URL.createObjectURL(csvBlob);
        csvLink.download = csvFilename;
        csvLink.click();
        
        // Download JSON after small delay
        setTimeout(() => {
            const jsonLink = document.createElement('a');
            jsonLink.href = URL.createObjectURL(jsonBlob);
            jsonLink.download = jsonFilename;
            jsonLink.click();
            
            // Cleanup
            URL.revokeObjectURL(csvLink.href);
            URL.revokeObjectURL(jsonLink.href);
        }, 500);
        
        if (typeof showAdvancedNotification === 'function') {
            showAdvancedNotification(`âœ… Session data exported! Files: ${csvFilename} & ${jsonFilename}`, 'success', 5000);
        } else {
            console.log(`âœ… Session data exported! Files: ${csvFilename} & ${jsonFilename}`);
            alert(`âœ… Session data exported!\nFiles: ${csvFilename} & ${jsonFilename}`);
        }
        
        // Log export event
        console.log('ðŸ’¾ Export completed:', {
            csvFile: csvFilename,
            jsonFile: jsonFilename,
            totalReadings: sessionAnalytics.totalReadings,
            duration: sessionDuration,
            dominantEmotion
        });
        
    } catch (error) {
        console.error('âŒ Export failed:', error);
        if (typeof showAdvancedNotification === 'function') {
            showAdvancedNotification('âŒ Failed to export session data', 'error', 3000);
        } else {
            console.log('âŒ Failed to export session data');
            alert('âŒ Failed to export session data');
        }
    }
}

// Enhanced notification system with better animations
function showAdvancedNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `ymir-notification notification-${type}`;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 16px 24px;
        border-radius: 12px;
        color: white;
        font-weight: 500;
        font-size: 14px;
        z-index: 10000;
        transform: translateX(100%);
        transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        max-width: 400px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        animation: notificationSlide 0.4s ease-out;
    `;
    
    // Set background based on type
    switch(type) {
        case 'success':
            notification.style.background = 'linear-gradient(45deg, rgba(34, 197, 94, 0.9), rgba(22, 163, 74, 0.9))';
            notification.style.borderColor = 'rgba(34, 197, 94, 0.3)';
            break;
        case 'error':
            notification.style.background = 'linear-gradient(45deg, rgba(239, 68, 68, 0.9), rgba(220, 38, 38, 0.9))';
            notification.style.borderColor = 'rgba(239, 68, 68, 0.3)';
            break;
        case 'warning':
            notification.style.background = 'linear-gradient(45deg, rgba(245, 158, 11, 0.9), rgba(217, 119, 6, 0.9))';
            notification.style.borderColor = 'rgba(245, 158, 11, 0.3)';
            break;
        default:
            notification.style.background = 'linear-gradient(45deg, rgba(59, 130, 246, 0.9), rgba(37, 99, 235, 0.9))';
            notification.style.borderColor = 'rgba(59, 130, 246, 0.3)';
    }
    
    notification.innerHTML = message;
    document.body.appendChild(notification);
    
    // Animate in
    setTimeout(() => {
        notification.style.transform = 'translateX(0)';
    }, 100);
    
    // Animate out and remove
    setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
            if (document.body.contains(notification)) {
                document.body.removeChild(notification);
            }
        }, 400);
    }, 4000);
}

// Initialize advanced features when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    console.log('ðŸš€ Advanced Y.M.I.R Features Initialized');
    
    // Set initial button states
    const privacyToggle = document.getElementById('privacyToggle');
    if (privacyToggle) {
        privacyToggle.innerHTML = '<i class="fas fa-eye-slash"></i> Privacy';
    }
    
    // Start session analytics
    sessionAnalytics.sessionStart = new Date();
    console.log('ðŸ“Š Session Analytics Started:', sessionAnalytics.sessionStart);
    
    // Add keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Ctrl+Shift+P for Privacy Mode
        if (e.ctrlKey && e.shiftKey && e.key === 'P') {
            e.preventDefault();
            togglePrivacyMode();
        }
        
        // Ctrl+Shift+E for Export
        if (e.ctrlKey && e.shiftKey && e.key === 'E') {
            e.preventDefault();
            exportSessionData();
        }
    });
    
    console.log('âŒ¨ï¸ Keyboard shortcuts enabled: Ctrl+Shift+P (Privacy), Ctrl+Shift+E (Export)');
});

// ðŸ“Š LIVE ANALYTICS: Fetch real-time data from face microservice
function fetchLiveAnalytics() {
    fetch('http://localhost:5002/api/status')
        .then(response => response.json())
        .then(data => {
            if (data.analytics) {
                const analytics = data.analytics;
                
                // Update the advanced insights panel with live data
                updateLiveAnalyticsDisplay(analytics, data);
            }
        })
        .catch(error => {
            console.warn('âš ï¸ Could not fetch live analytics:', error.message);
        });
}

function updateLiveAnalyticsDisplay(analytics, systemData) {
    const insights = document.getElementById('emotionInsights');
    if (!insights) return;
    
    const totalReadings = analytics.total_readings || 0;
    const avgConfidence = analytics.avg_confidence || 0;
    const avgQuality = analytics.avg_quality || 0;
    const sessionDuration = systemData.session_duration || 0;
    
    // Calculate FPS if available
    const processingFPS = sessionAnalytics.processingFPS || 'N/A';
    
    // Format session time
    const minutes = Math.floor(sessionDuration / 60);
    const seconds = Math.floor(sessionDuration % 60);
    const timeDisplay = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    
    // Get current dominant emotion from analytics
    const dominantEmotion = analytics.dominant_emotion || 'neutral';
    const emotionConfidence = avgConfidence;
    
    // ðŸŽµ MUSIC UPDATE: Check if emotion changed and trigger music update
    if (window.lastFacialEmotion !== dominantEmotion && totalReadings > 0) {
        console.log(`ðŸŽ­ Facial emotion changed: ${window.lastFacialEmotion} â†’ ${dominantEmotion} (readings: ${totalReadings})`);
        window.lastFacialEmotion = dominantEmotion;
        
        // Trigger music recommendation update for facial emotion change
        console.log(`ðŸŽµ Triggering music update for facial emotion: ${dominantEmotion}`);
        showMusicUpdateIndicator(`ðŸŽ­ ${dominantEmotion.charAt(0).toUpperCase() + dominantEmotion.slice(1)} detected via camera!`);
        setTimeout(() => {
            initializeMusicCarousel(dominantEmotion, emotionConfidence);  // ðŸŽ¯ PASS FACIAL EMOTION DIRECTLY
        }, 500);
    }
    
    // Update the analytics panel
    insights.innerHTML = `
        <div class="insight-item">
            <span class="insight-label">Current Emotion:</span>
            <span class="insight-value emotion-badge" style="background: ${getEmotionColor(dominantEmotion)}; padding: 2px 8px; border-radius: 12px; color: white; font-weight: 600;">${dominantEmotion.toUpperCase()}</span>
        </div>
        <div class="insight-item">
            <span class="insight-label">Live Confidence:</span>
            <span class="insight-value confidence-meter" style="color: ${emotionConfidence > 0.7 ? '#22c55e' : emotionConfidence > 0.5 ? '#f59e0b' : '#ef4444'};">${emotionConfidence ? (emotionConfidence * 100).toFixed(1) + '%' : 'N/A'}</span>
        </div>
        <div class="insight-item">
            <span class="insight-label">Total Readings:</span>
            <span class="insight-value total-counter" style="color: #3b82f6; font-weight: 600;">${totalReadings}</span>
        </div>
        <div class="insight-item">
            <span class="insight-label">Avg Confidence:</span>
            <span class="insight-value" style="color: #10b981;">${avgConfidence ? (avgConfidence * 100).toFixed(1) + '%' : '--'}</span>
        </div>
        <div class="insight-item">
            <span class="insight-label">Session Time:</span>
            <span class="insight-value session-timer" style="color: #8b5cf6; font-family: 'Monaco', monospace;">${timeDisplay}</span>
        </div>
        <div class="insight-item">
            <span class="insight-label">Processing FPS:</span>
            <span class="insight-value fps-counter" style="color: #f59e0b; font-weight: 600;">${processingFPS !== 'N/A' ? Math.round(processingFPS) : '--'}</span>
        </div>
        <div class="insight-item">
            <span class="insight-label">Active Models:</span>
            <span class="insight-value" style="color: #06b6d4;">${systemData.detector_available ? '3' : '0'}</span>
        </div>
        <div class="insight-item">
            <span class="insight-label">Total Frames:</span>
            <span class="insight-value" style="color: #84cc16;">${sessionAnalytics.totalFrames || 0}</span>
        </div>
        <div class="insight-item">
            <span class="insight-label">Storage Status:</span>
            <span class="insight-value storage-indicator" style="color: ${systemData.storage_status?.enabled ? '#22c55e' : '#ef4444'};">
                ${systemData.storage_status?.buffer_size || 0} buffered
            </span>
        </div>
    `;
}

// ðŸ›¡ï¸ FUNCTIONAL PRIVACY CONTROLS
function stopDataCollection() {
    console.log('ðŸ”’ Privacy Mode: Stopping all data collection');
    
    // Stop camera via microservice API
    fetch('http://localhost:5002/api/stop_camera', {
        method: 'POST'
    }).then(response => {
        if (response.ok) {
            console.log('âœ… Camera stopped for privacy');
        }
    }).catch(error => {
        console.warn('âš ï¸ Could not stop camera:', error.message);
    });
    
    // Stop music recommendations polling
    if (window.musicRecommendationInterval) {
        clearInterval(window.musicRecommendationInterval);
        window.musicRecommendationInterval = null;
        console.log('ðŸŽµ Music recommendations paused');
    }
    
    // Stop analytics polling
    if (window.analyticsInterval) {
        clearInterval(window.analyticsInterval);
        window.analyticsInterval = null;
        console.log('ðŸ“Š Analytics polling paused');
    }
    
    // Clear current data displays
    const emotionDisplay = document.querySelector('.current-emotion');
    if (emotionDisplay) {
        emotionDisplay.textContent = 'ðŸ”’ Privacy Mode Active';
    }
    
    // Update insights panel
    const insights = document.getElementById('emotionInsights');
    if (insights) {
        insights.innerHTML = `
            <div style="text-align: center; padding: 20px; color: #ef4444;">
                <i class="fas fa-shield-alt" style="font-size: 2rem; margin-bottom: 10px;"></i>
                <div style="font-weight: 600;">Privacy Mode Active</div>
                <div style="font-size: 0.9rem; margin-top: 5px;">All data collection stopped</div>
            </div>
        `;
    }
}

function resumeDataCollection() {
    console.log('ðŸ‘ï¸ Privacy Mode: Resuming data collection');
    
    // Restart camera via microservice API
    fetch('http://localhost:5002/api/start_camera', {
        method: 'POST'
    }).then(response => {
        if (response.ok) {
            console.log('âœ… Camera restarted');
        }
    }).catch(error => {
        console.warn('âš ï¸ Could not restart camera:', error.message);
    });
    
    // Restart smart music recommendations polling
    if (!window.musicRecommendationInterval) {
        console.log('ðŸ”„ Restarting smart music recommendations...');
        initializeMusicCarousel(); // Use the smart initialization instead
        
        // Old function kept for compatibility but will be replaced by smart system
        // window.musicRecommendationInterval = setInterval(() => {
        //     if (!window.privacyModeActive) {
        //         fetchAIMusicRecommendations();
        //     }
        } 30000; // Every 30 seconds
        console.log('ðŸŽµ Music recommendations resumed');
    }
    
    // Restart analytics polling
    if (!window.analyticsInterval) {
        window.analyticsInterval = setInterval(() => {
            if (!window.privacyModeActive) {
                fetchLiveAnalytics();
            }
        }, 2000); // Every 2 seconds
        console.log('ðŸ“Š Analytics polling resumed');
    }
    
    // Clear privacy display
    const currentEmotionDisplay = document.querySelector('.current-emotion');
    if (currentEmotionDisplay) {
        currentEmotionDisplay.textContent = 'Waiting for emotions...';
    }
    
    // Resume normal insights panel
    setTimeout(fetchLiveAnalytics, 1000);


// Store interval references for privacy control
window.musicRecommendationInterval = null;
window.analyticsInterval = null;

// Start polling for live analytics every 2 seconds (with privacy mode check)
window.analyticsInterval = setInterval(() => {
    if (!window.privacyModeActive) {
        fetchLiveAnalytics();
    }
}, 2000);

// Initial fetch
setTimeout(fetchLiveAnalytics, 1000);

// Hook into existing emotion detection updates safely
if (typeof window.updateInsights === 'function') {
    const originalUpdateInsights = window.updateInsights;
    window.updateInsights = function(emotion, confidence) {
        try {
            originalUpdateInsights(emotion, confidence);
            updateAdvancedInsights(emotion, confidence);
        } catch (error) {
            console.warn('âš ï¸ updateInsights error:', error.message);
        }
    };
} else {
    window.updateInsights = function(emotion, confidence) {
        try {
            updateAdvancedInsights(emotion, confidence);
        } catch (error) {
            console.warn('âš ï¸ updateInsights error:', error.message);
        }
    };
}

// Performance monitoring
setInterval(() => {
    if (sessionAnalytics.totalReadings > 0) {
        const avgFPS = sessionAnalytics.processingFPS;
        if (avgFPS < 10) {
            console.warn('âš ï¸ Low processing FPS detected:', avgFPS);
        }
    }
}, 10000); // Check every 10 seconds

function enableAdvancedFeatures() {
    // Enable features only available to authenticated users
    const advancedControls = document.querySelectorAll('.auth-required');
    advancedControls.forEach(control => {
        control.style.display = 'block';
        control.classList.remove('disabled');
    });
}

function showTemporaryUserPrompts() {
    // Add subtle prompts for sign-in throughout the interface
    const emotionSection = document.querySelector('.emotion-section');
    if (emotionSection && !document.querySelector('.temp-prompt')) {
        const promptDiv = document.createElement('div');
        promptDiv.className = 'temp-prompt';
        promptDiv.innerHTML = `
            <div style="background: rgba(255, 193, 7, 0.1); border: 1px solid rgba(255, 193, 7, 0.3); 
                        border-radius: 8px; padding: 10px; margin: 10px 0; text-align: center;">
                <small style="color: #ffc107;">
                    ðŸ’¡ <a href="#" onclick="window.ymirAuth?.openAuthModal()" style="color: #3b82f6; text-decoration: none;">
                        Sign in
                    </a> to save your emotional journey and get personalized insights
                </small>
            </div>
        `;
        emotionSection.appendChild(promptDiv);
    }
}

function loadUserHistory(user) {
    // Load user's historical emotion data, conversations, etc.
    console.log('ðŸ“Š Loading user history...');
    
    // This would integrate with your existing data loading functions
    // For now, just log that we would load user-specific data
    console.log(`ðŸ“ˆ Loading data for user: ${user.email}`);
}

function showNotification(message, type = 'info') {
    // Use the notification system from firebase-auth.js
    if (window.ymirAuth) {
        window.ymirAuth.showNotification(message, type);
    }
}

// ===============================================
// ðŸ§  ULTIMATE DAILY CHECK-IN SYSTEM 
// ===============================================

// Daily Check-in Data Management
class DailyCheckInManager {
    constructor() {
        this.currentMood = null;
        this.currentContext = {
            energy: 5,
            stress: 5,
            social: 5,
            thoughts: ''
        };
        this.streakData = {
            current: 0,
            longest: 0,
            lastCheckIn: null
        };
        this.contextualPrompts = [
            "Track your emotional journey with us âœ¨",
            "How has your day been treating you? ðŸŒŸ",
            "Take a moment to check in with yourself ðŸ’­",
            "Your feelings matter - let's capture this moment ðŸŽ¯",
            "What's your emotional weather today? ðŸŒˆ",
            "Every feeling is valid - how are you right now? ðŸ’«"
        ];
        this.init();
    }

    init() {
        this.setupMoodButtons();
        this.setupContextSliders();
        this.setupSubmitButton();
        this.loadUserStreak();
        this.updateContextualPrompt();
        this.setupPeriodicPrompts();
        this.initializeMoodHistory();
        this.setupLazyUserFeatures();
    }

    // Setup mood button interactions
    setupMoodButtons() {
        const moodButtons = document.querySelectorAll('.mood-btn');
        
        moodButtons.forEach(button => {
            // Add hover effects
            button.addEventListener('mouseenter', (e) => {
                const overlay = e.target.querySelector('div');
                if (overlay) overlay.style.opacity = '1';
                const icon = e.target.querySelector('div[style*="font-size: 32px"]');
                if (icon) icon.style.transform = 'scale(1.1)';
                
                // Add gentle glow effect
                e.target.style.boxShadow = `0 8px 25px ${this.getMoodColor(button.dataset.mood, 0.4)}, 0 0 20px ${this.getMoodColor(button.dataset.mood, 0.2)}`;
            });

            button.addEventListener('mouseleave', (e) => {
                const overlay = e.target.querySelector('div');
                if (overlay) overlay.style.opacity = '0';
                const icon = e.target.querySelector('div[style*="font-size: 32px"]');
                if (icon) icon.style.transform = 'scale(1)';
                
                // Reset glow
                e.target.style.boxShadow = 'none';
            });

            // Handle mood selection
            button.addEventListener('click', (e) => {
                this.handleMoodSelection(button);
            });
        });
    }

    // Handle mood button selection
    handleMoodSelection(selectedButton) {
        // Remove previous selections
        document.querySelectorAll('.mood-btn').forEach(btn => {
            btn.style.transform = 'scale(1)';
            btn.style.borderWidth = '2px';
            btn.classList.remove('selected');
        });

        // Mark as selected with animation
        selectedButton.style.transform = 'scale(1.05)';
        selectedButton.style.borderWidth = '3px';
        selectedButton.classList.add('selected');
        
        // Add celebration animation
        this.celebrateMoodSelection(selectedButton);

        // Store mood data
        this.currentMood = {
            type: selectedButton.dataset.mood,
            value: parseInt(selectedButton.dataset.value),
            timestamp: new Date(),
            emoji: selectedButton.querySelector('div[style*="font-size: 32px"]').textContent
        };

        // Show context sliders with animation
        this.showContextSliders();
        
        // Update contextual prompt based on mood
        this.updatePromptForMood(this.currentMood.type);

        console.log('ðŸŽ¯ Mood selected:', this.currentMood);
    }

    // Celebrate mood selection with particles
    celebrateMoodSelection(button) {
        // Create floating celebration effect
        for (let i = 0; i < 6; i++) {
            setTimeout(() => {
                const particle = document.createElement('div');
                particle.style.cssText = `
                    position: absolute;
                    width: 8px;
                    height: 8px;
                    background: ${this.getMoodColor(button.dataset.mood, 0.8)};
                    border-radius: 50%;
                    pointer-events: none;
                    z-index: 1000;
                    animation: floatAway 1.5s ease-out forwards;
                `;
                
                const rect = button.getBoundingClientRect();
                particle.style.left = (rect.left + Math.random() * rect.width) + 'px';
                particle.style.top = (rect.top + Math.random() * rect.height) + 'px';
                
                document.body.appendChild(particle);
                
                setTimeout(() => {
                    if (particle.parentNode) {
                        particle.parentNode.removeChild(particle);
                    }
                }, 1500);
            }, i * 100);
        }

        // Add CSS for particle animation if not exists
        if (!document.querySelector('#particleAnimation')) {
            const style = document.createElement('style');
            style.id = 'particleAnimation';
            style.textContent = `
                @keyframes floatAway {
                    0% { transform: translateY(0) scale(1); opacity: 1; }
                    100% { transform: translateY(-50px) scale(0.5); opacity: 0; }
                }
            `;
            document.head.appendChild(style);
        }
    }

    // Get mood-specific colors
    getMoodColor(mood, opacity = 1) {
        const colors = {
            amazing: `rgba(34, 197, 94, ${opacity})`,
            great: `rgba(59, 130, 246, ${opacity})`,
            good: `rgba(156, 163, 175, ${opacity})`,
            okay: `rgba(251, 146, 60, ${opacity})`,
            rough: `rgba(239, 68, 68, ${opacity})`
        };
        return colors[mood] || `rgba(100, 100, 100, ${opacity})`;
    }

    // Show context sliders with smooth animation
    showContextSliders() {
        const contextSliders = document.getElementById('contextSliders');
        if (contextSliders) {
            contextSliders.style.display = 'block';
            contextSliders.style.opacity = '0';
            contextSliders.style.transform = 'translateY(20px)';
            
            setTimeout(() => {
                contextSliders.style.transition = 'all 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
                contextSliders.style.opacity = '1';
                contextSliders.style.transform = 'translateY(0)';
            }, 100);
        }
    }

    // Setup context sliders
    setupContextSliders() {
        // Energy slider
        const energySlider = document.getElementById('energySlider');
        const energyValue = document.getElementById('energyValue');
        if (energySlider && energyValue) {
            energySlider.addEventListener('input', (e) => {
                this.currentContext.energy = parseInt(e.target.value);
                energyValue.textContent = e.target.value;
                this.updateSliderStyle(energySlider, e.target.value);
            });
        }

        // Stress slider
        const stressSlider = document.getElementById('stressSlider');
        const stressValue = document.getElementById('stressValue');
        if (stressSlider && stressValue) {
            stressSlider.addEventListener('input', (e) => {
                this.currentContext.stress = parseInt(e.target.value);
                stressValue.textContent = e.target.value;
                this.updateSliderStyle(stressSlider, e.target.value);
            });
        }

        // Social slider
        const socialSlider = document.getElementById('socialSlider');
        const socialValue = document.getElementById('socialValue');
        if (socialSlider && socialValue) {
            socialSlider.addEventListener('input', (e) => {
                this.currentContext.social = parseInt(e.target.value);
                socialValue.textContent = e.target.value;
                this.updateSliderStyle(socialSlider, e.target.value);
            });
        }

        // Thoughts input
        const thoughtsInput = document.getElementById('thoughtsInput');
        if (thoughtsInput) {
            thoughtsInput.addEventListener('input', (e) => {
                this.currentContext.thoughts = e.target.value;
            });
        }
    }

    // Update slider visual style based on value
    updateSliderStyle(slider, value) {
        const percentage = ((value - slider.min) / (slider.max - slider.min)) * 100;
        slider.style.background = `linear-gradient(90deg, rgba(64, 112, 255, 0.6) 0%, rgba(64, 112, 255, 0.6) ${percentage}%, rgba(64, 112, 255, 0.2) ${percentage}%, rgba(64, 112, 255, 0.2) 100%)`;
    }

    // Setup submit button
    setupSubmitButton() {
        const submitBtn = document.getElementById('submitMoodBtn');
        if (submitBtn) {
            submitBtn.addEventListener('click', () => {
                this.submitDailyCheckIn();
            });
        }
    }

    // Submit daily check-in to Firebase
    async submitDailyCheckIn() {
        if (!this.currentMood) {
            this.showNotification('Please select your mood first! ðŸ˜Š', 'warning');
            return;
        }

        const submitBtn = document.getElementById('submitMoodBtn');
        const originalText = submitBtn.textContent;
        
        try {
            // Show loading state
            submitBtn.textContent = 'Saving your journey... ðŸ’«';
            submitBtn.disabled = true;

            // Prepare check-in data
            const checkInData = {
                mood: this.currentMood,
                context: this.currentContext,
                timestamp: new Date(),
                date: new Date().toDateString(),
                deviceInfo: {
                    userAgent: navigator.userAgent,
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
                }
            };

            // Save to Firebase
            if (window.ymirAuth) {
                await window.ymirAuth.saveData('dailyCheckIns', checkInData);
                
                // Update streak
                await this.updateStreak();
                
                // Show success with personalized message
                const insights = this.generateAIInsights(checkInData);
                this.showNotification(`âœ¨ Check-in saved! ${insights}`, 'success');
                
                // Reset the form
                this.resetCheckInForm();
                
                // Show achievement if applicable
                this.checkForAchievements();
                
            } else {
                throw new Error('Authentication system not available');
            }

        } catch (error) {
            console.error('âŒ Error saving check-in:', error);
            this.showNotification('Unable to save check-in. Please try again! ðŸ”„', 'error');
        } finally {
            // Reset button
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
        }
    }

    // Generate AI-powered insights
    generateAIInsights(checkInData) {
        const mood = checkInData.mood.type;
        const energy = checkInData.context.energy;
        const stress = checkInData.context.stress;
        
        const insights = {
            amazing: [
                "Your energy is contagious! âœ¨",
                "You're radiating positivity today! ðŸŒŸ",
                "What a fantastic emotional state! ðŸš€"
            ],
            great: [
                "You're doing wonderfully! Keep it up! ðŸ’ª",
                "Your positive energy is inspiring! ðŸŒˆ",
                "Great vibes detected! ðŸŽ‰"
            ],
            good: [
                "Steady progress is still progress! ðŸ“ˆ",
                "You're maintaining balance well! âš–ï¸",
                "Good energy attracts good things! ðŸŒ¸"
            ],
            okay: [
                "Every day has its moments. You're doing fine! ðŸ¤—",
                "Tomorrow is a new opportunity! ðŸŒ…",
                "Your resilience is your strength! ðŸ’Ž"
            ],
            rough: [
                "Your courage to check in shows strength! ðŸ’ª",
                "Difficult moments don't last, strong people do! ðŸ›¡ï¸",
                "You're not alone in this journey! ðŸ¤"
            ]
        };

        // Add context-based insights
        let contextInsight = "";
        if (energy <= 3) {
            contextInsight = " Consider some rest or gentle movement. ";
        } else if (energy >= 8) {
            contextInsight = " Channel that energy into something meaningful! ";
        }

        if (stress >= 7) {
            contextInsight += " Try some breathing exercises to find calm. ";
        }

        const moodInsights = insights[mood] || insights.okay;
        const randomInsight = moodInsights[Math.floor(Math.random() * moodInsights.length)];
        
        return randomInsight + contextInsight;
    }

    // Update streak data
    async updateStreak() {
        const today = new Date().toDateString();
        const lastCheckIn = this.streakData.lastCheckIn;
        
        if (lastCheckIn !== today) {
            // Check if yesterday was the last check-in
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            
            if (lastCheckIn === yesterday.toDateString()) {
                // Continue streak
                this.streakData.current += 1;
            } else if (lastCheckIn === null || lastCheckIn < yesterday.toDateString()) {
                // Start new streak
                this.streakData.current = 1;
            }
            
            // Update longest streak
            if (this.streakData.current > this.streakData.longest) {
                this.streakData.longest = this.streakData.current;
            }
            
            this.streakData.lastCheckIn = today;
            
            // Save streak data
            if (window.ymirAuth) {
                await window.ymirAuth.saveData('streakData', this.streakData);
            }
            
            // Update UI
            this.updateStreakDisplay();
        }
    }

    // Load user streak from Firebase
    async loadUserStreak() {
        try {
            if (window.ymirAuth) {
                const userData = window.ymirAuth.getUserData('streakData');
                if (userData && userData.length > 0) {
                    this.streakData = { ...this.streakData, ...userData[userData.length - 1] };
                }
                this.updateStreakDisplay();
            }
        } catch (error) {
            console.error('Error loading streak:', error);
        }
    }

    // Update streak display
    updateStreakDisplay() {
        const streakCount = document.getElementById('streakCount');
        if (streakCount) {
            streakCount.textContent = this.streakData.current;
            
            // Add celebration for milestones
            if (this.streakData.current > 0 && this.streakData.current % 7 === 0) {
                streakCount.style.animation = 'enhancedStatusPulse 2s ease infinite';
            }
        }
    }

    // Reset check-in form
    resetCheckInForm() {
        // Reset mood buttons
        document.querySelectorAll('.mood-btn').forEach(btn => {
            btn.style.transform = 'scale(1)';
            btn.style.borderWidth = '2px';
            btn.classList.remove('selected');
        });

        // Hide context sliders
        const contextSliders = document.getElementById('contextSliders');
        if (contextSliders) {
            contextSliders.style.opacity = '0';
            contextSliders.style.transform = 'translateY(20px)';
            setTimeout(() => {
                contextSliders.style.display = 'none';
            }, 500);
        }

        // Reset data
        this.currentMood = null;
        this.currentContext = {
            energy: 5,
            stress: 5,
            social: 5,
            thoughts: ''
        };

        // Reset form values
        const sliders = ['energySlider', 'stressSlider', 'socialSlider'];
        sliders.forEach(sliderId => {
            const slider = document.getElementById(sliderId);
            if (slider) {
                slider.value = 5;
                const valueDisplay = document.getElementById(sliderId.replace('Slider', 'Value'));
                if (valueDisplay) valueDisplay.textContent = '5';
            }
        });

        const thoughtsInput = document.getElementById('thoughtsInput');
        if (thoughtsInput) thoughtsInput.value = '';

        // Update prompt
        setTimeout(() => {
            this.updateContextualPrompt();
        }, 1000);
    }

    // Update contextual prompt
    updateContextualPrompt() {
        const promptElement = document.getElementById('contextualPrompt');
        if (promptElement) {
            const randomPrompt = this.contextualPrompts[Math.floor(Math.random() * this.contextualPrompts.length)];
            promptElement.textContent = randomPrompt;
        }
    }

    // Update prompt based on selected mood
    updatePromptForMood(mood) {
        const promptElement = document.getElementById('contextualPrompt');
        if (promptElement) {
            const moodPrompts = {
                amazing: "You're glowing! Tell us more about this amazing feeling âœ¨",
                great: "Wonderful energy! What's contributing to this great day? ðŸŒŸ",
                good: "Solid vibes! Share more about what's working well ðŸ˜Š",
                okay: "It's okay to have average days. What could make it better? ðŸ¤—",
                rough: "Thank you for being honest. You're not alone in this ðŸ’™"
            };
            promptElement.textContent = moodPrompts[mood] || "Tell us more about your day...";
        }
    }

    // Setup periodic prompts
    setupPeriodicPrompts() {
        // Update contextual prompt every 30 seconds
        setInterval(() => {
            if (!this.currentMood) {
                this.updateContextualPrompt();
            }
        }, 30000);
    }

    // Check for achievements
    checkForAchievements() {
        if (this.streakData.current === 7) {
            this.showAchievement('ðŸ”¥ Week Warrior!', 'You\'ve checked in for 7 days straight!');
        } else if (this.streakData.current === 30) {
            this.showAchievement('ðŸ† Monthly Master!', 'Incredible! 30 days of emotional wellness!');
        } else if (this.streakData.current === 100) {
            this.showAchievement('ðŸš€ Centurion Champion!', 'You\'re a true wellness warrior - 100 days!');
        }
    }

    // Show achievement notification
    showAchievement(title, message) {
        // Create achievement modal
        const achievementHTML = `
            <div id="achievementModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 10000;">
                <div style="background: linear-gradient(135deg, rgba(30, 30, 30, 0.95), rgba(40, 40, 40, 0.95)); border: 2px solid #3b82f6; border-radius: 20px; padding: 40px; text-align: center; max-width: 400px; animation: achievementBounce 0.5s ease;">
                    <div style="font-size: 60px; margin-bottom: 20px;">${title.split(' ')[0]}</div>
                    <h2 style="color: #3b82f6; margin-bottom: 15px;">${title}</h2>
                    <p style="color: #dbeafe; margin-bottom: 25px;">${message}</p>
                    <button onclick="document.getElementById('achievementModal').remove()" style="background: #3b82f6; border: none; border-radius: 12px; color: white; padding: 12px 24px; font-weight: 600; cursor: pointer;">Awesome! ðŸŽ‰</button>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', achievementHTML);

        // Add achievement animation styles
        if (!document.querySelector('#achievementStyles')) {
            const style = document.createElement('style');
            style.id = 'achievementStyles';
            style.textContent = `
                @keyframes achievementBounce {
                    0% { transform: scale(0.5) rotate(-5deg); opacity: 0; }
                    50% { transform: scale(1.1) rotate(2deg); opacity: 1; }
                    100% { transform: scale(1) rotate(0deg); opacity: 1; }
                }
            `;
            document.head.appendChild(style);
        }
    }

    // Show notification
    showNotification(message, type = 'info') {
        if (window.ymirAuth) {
            window.ymirAuth.showNotification(message, type);
        }
    }

    // ===============================================
    // ðŸ“Š MOOD HISTORY & VISUALIZATION SYSTEM
    // ===============================================

    // Initialize mood history system
    initializeMoodHistory() {
        this.setupMoodHistoryControls();
        this.loadMoodHistory();
        
        // For testing - add sample data if no data exists
        setTimeout(() => {
            if (!this.moodHistoryData || this.moodHistoryData.length === 0) {
                console.log('ðŸ“Š No mood data found, you can test by doing a check-in first!');
                // Show helpful message
                this.showTestDataOption();
            }
        }, 2000);
    }

    // Setup mood history controls
    setupMoodHistoryControls() {
        // View toggle buttons
        const chartViewBtn = document.getElementById('chartViewBtn');
        const tableViewBtn = document.getElementById('tableViewBtn');
        const exportDataBtn = document.getElementById('exportDataBtn');
        const clearDataBtn = document.getElementById('clearDataBtn');

        if (chartViewBtn) {
            chartViewBtn.addEventListener('click', () => this.switchView('chart'));
        }
        if (tableViewBtn) {
            tableViewBtn.addEventListener('click', () => this.switchView('table'));
        }
        if (exportDataBtn) {
            exportDataBtn.addEventListener('click', () => this.exportMoodData());
        }
        if (clearDataBtn) {
            clearDataBtn.addEventListener('click', () => this.clearMoodHistory());
        }
    }

    // Switch between chart and table view
    switchView(viewType) {
        console.log('ðŸ”„ Switching to view:', viewType);
        
        const chartView = document.getElementById('chartView');
        const tableView = document.getElementById('tableView');
        const chartBtn = document.getElementById('chartViewBtn');
        const tableBtn = document.getElementById('tableViewBtn');

        if (!chartView || !tableView || !chartBtn || !tableBtn) {
            console.error('âŒ View switching elements not found');
            return;
        }

        if (viewType === 'chart') {
            chartView.style.display = 'block';
            tableView.style.display = 'none';
            chartBtn.classList.add('active');
            tableBtn.classList.remove('active');
            chartBtn.style.background = '#3b82f6';
            chartBtn.style.color = 'white';
            chartBtn.style.border = '1px solid #3b82f6';
            tableBtn.style.background = 'rgba(59, 130, 246, 0.2)';
            tableBtn.style.color = '#3b82f6';
            tableBtn.style.border = '1px solid #3b82f6';
            this.renderMoodChart();
            console.log('âœ… Switched to chart view');
        } else {
            chartView.style.display = 'none';
            tableView.style.display = 'block';
            tableBtn.classList.add('active');
            chartBtn.classList.remove('active');
            tableBtn.style.background = '#3b82f6';
            tableBtn.style.color = 'white';
            tableBtn.style.border = '1px solid #3b82f6';
            chartBtn.style.background = 'rgba(59, 130, 246, 0.2)';
            chartBtn.style.color = '#3b82f6';
            chartBtn.style.border = '1px solid #3b82f6';
            this.renderMoodTable();
            console.log('âœ… Switched to table view');
        }
    }

    // Load mood history from Firebase
    async loadMoodHistory() {
        try {
            if (window.ymirAuth) {
                const checkInData = window.ymirAuth.getUserData('dailyCheckIns');
                this.moodHistoryData = checkInData || [];
                
                console.log('ðŸ“Š Loaded mood history:', this.moodHistoryData.length, 'entries');
                
                // Always render both views to make sure they work
                this.renderMoodChart();
                this.renderMoodTable();
                this.updateHistoryStats();
            }
        } catch (error) {
            console.error('Error loading mood history:', error);
            // Show empty state
            this.moodHistoryData = [];
            this.renderMoodChart();
            this.renderMoodTable();
        }
    }

    // Render mood chart visualization
    renderMoodChart() {
        const chartContainer = document.querySelector('.mood-chart');
        if (!chartContainer) return;

        if (!this.moodHistoryData || this.moodHistoryData.length === 0) {
            chartContainer.innerHTML = `
                <div class="mood-placeholder" style="text-align: center; color: #666; padding: 40px;">
                    <div style="font-size: 48px; margin-bottom: 20px; opacity: 0.5;">ðŸ“Š</div>
                    <h3 style="color: #60a5fa; margin-bottom: 10px;">No Data Yet</h3>
                    <p>Complete your first daily check-in to see your mood trends!</p>
                </div>
            `;
            return;
        }

        // Create simple but beautiful chart
        const last7Days = this.moodHistoryData.slice(-7);
        const maxValue = 5;
        
        let chartHTML = `
            <div style="padding: 20px;">
                <h4 style="color: #60a5fa; margin-bottom: 20px; text-align: center;">Last 7 Days Mood Trend</h4>
                <div style="display: flex; align-items: end; justify-content: space-between; height: 200px; margin-bottom: 20px; padding: 0 20px;">
        `;

        last7Days.forEach((entry, index) => {
            const height = (entry.mood.value / maxValue) * 150;
            const color = this.getMoodColor(entry.mood.type, 0.8);
            const date = new Date(entry.timestamp).toLocaleDateString();
            
            chartHTML += `
                <div style="display: flex; flex-direction: column; align-items: center; flex: 1;">
                    <div style="
                        width: 40px; 
                        height: ${height}px; 
                        background: ${color}; 
                        border-radius: 8px 8px 0 0;
                        margin-bottom: 10px;
                        position: relative;
                        transition: all 0.3s ease;
                        cursor: pointer;
                        box-shadow: 0 4px 15px ${color.replace(')', ', 0.3)')};
                    " title="${entry.mood.type} - ${entry.mood.value}/5">
                        <div style="
                            position: absolute;
                            top: -25px;
                            left: 50%;
                            transform: translateX(-50%);
                            font-size: 18px;
                        ">${entry.mood.emoji}</div>
                    </div>
                    <div style="font-size: 0.8rem; color: #93c5fd; text-align: center; transform: rotate(-45deg); margin-top: 5px;">
                        ${date.split('/')[1]}/${date.split('/')[2]}
                    </div>
                </div>
            `;
        });

        chartHTML += `
                </div>
                <div style="display: flex; justify-content: center; gap: 20px; flex-wrap: wrap;">
                    ${this.generateMoodLegend()}
                </div>
                <div style="margin-top: 20px; text-align: center;">
                    ${this.generateInsights()}
                </div>
            </div>
        `;

        chartContainer.innerHTML = chartHTML;
    }

    // Generate mood legend
    generateMoodLegend() {
        const moods = [
            { type: 'amazing', emoji: 'âœ¨', label: 'Amazing' },
            { type: 'great', emoji: 'ðŸ˜Š', label: 'Great' },
            { type: 'good', emoji: 'ðŸ™‚', label: 'Good' },
            { type: 'okay', emoji: 'ðŸ˜', label: 'Okay' },
            { type: 'rough', emoji: 'ðŸ˜”', label: 'Rough' }
        ];

        return moods.map(mood => `
            <div style="display: flex; align-items: center; gap: 8px;">
                <div style="
                    width: 16px; 
                    height: 16px; 
                    background: ${this.getMoodColor(mood.type, 0.8)}; 
                    border-radius: 4px;
                "></div>
                <span style="color: #dbeafe; font-size: 0.9rem;">${mood.emoji} ${mood.label}</span>
            </div>
        `).join('');
    }

    // Generate insights from mood data
    generateInsights() {
        if (!this.moodHistoryData || this.moodHistoryData.length === 0) return '';

        const recent = this.moodHistoryData.slice(-7);
        const averageMood = recent.reduce((sum, entry) => sum + entry.mood.value, 0) / recent.length;
        const averageEnergy = recent.reduce((sum, entry) => sum + entry.context.energy, 0) / recent.length;
        const averageStress = recent.reduce((sum, entry) => sum + entry.context.stress, 0) / recent.length;

        let insight = '';
        if (averageMood >= 4) {
            insight = 'ðŸŒŸ You\'re having a great week! Your mood is consistently positive.';
        } else if (averageMood >= 3) {
            insight = 'ðŸ“ˆ Your mood is stable this week. Keep up the good work!';
        } else {
            insight = 'ðŸ’™ This week has been challenging. Remember to be kind to yourself.';
        }

        return `
            <div style="background: rgba(64, 112, 255, 0.1); border-radius: 12px; padding: 15px; border: 1px solid rgba(64, 112, 255, 0.3);">
                <h5 style="color: #60a5fa; margin-bottom: 10px;">Weekly Insights</h5>
                <p style="color: #dbeafe; margin-bottom: 10px;">${insight}</p>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; font-size: 0.9rem; color: #93c5fd;">
                    <div>Avg Mood: ${averageMood.toFixed(1)}/5</div>
                    <div>Avg Energy: ${averageEnergy.toFixed(1)}/10</div>
                    <div>Avg Stress: ${averageStress.toFixed(1)}/10</div>
                </div>
            </div>
        `;
    }

    // Render mood table
    renderMoodTable() {
        const tableBody = document.getElementById('moodTableBody');
        if (!tableBody) return;

        if (!this.moodHistoryData || this.moodHistoryData.length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="4" style="text-align: center; color: #666; padding: 40px;">
                        No mood data available yet. Complete your first check-in!
                    </td>
                </tr>
            `;
            return;
        }

        const sortedData = [...this.moodHistoryData].reverse(); // Most recent first
        
        tableBody.innerHTML = sortedData.map((entry, index) => {
            const date = new Date(entry.timestamp);
            const formattedDate = date.toLocaleDateString();
            const formattedTime = date.toLocaleTimeString();
            
            return `
                <tr style="border-bottom: 1px solid rgba(100, 100, 255, 0.1);">
                    <td style="padding: 12px; color: #dbeafe;">${formattedDate}</td>
                    <td style="padding: 12px; color: #dbeafe;">${formattedTime}</td>
                    <td style="padding: 12px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 20px;">${entry.mood.emoji}</span>
                            <span style="color: ${this.getMoodColor(entry.mood.type, 1)}; font-weight: 600;">
                                ${entry.mood.type.charAt(0).toUpperCase() + entry.mood.type.slice(1)}
                            </span>
                            <span style="color: #93c5fd; font-size: 0.9rem;">(${entry.mood.value}/5)</span>
                        </div>
                        ${entry.context.thoughts ? `<div style="font-size: 0.8rem; color: #b0b0b0; margin-top: 4px;">"${entry.context.thoughts.substring(0, 50)}${entry.context.thoughts.length > 50 ? '...' : ''}"</div>` : ''}
                    </td>
                    <td style="padding: 12px;">
                        <button onclick="dailyCheckIn.viewMoodDetails(${index})" style="background: rgba(59, 130, 246, 0.2); color: #3b82f6; border: 1px solid #3b82f6; border-radius: 6px; padding: 4px 8px; cursor: pointer; font-size: 0.8rem;">
                            View Details
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
    }

    // View detailed mood entry
    viewMoodDetails(index) {
        const entry = [...this.moodHistoryData].reverse()[index];
        if (!entry) return;

        const date = new Date(entry.timestamp);
        const detailsHTML = `
            <div id="moodDetailModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 10000;">
                <div style="background: linear-gradient(135deg, rgba(30, 30, 30, 0.95), rgba(40, 40, 40, 0.95)); border: 2px solid #3b82f6; border-radius: 20px; padding: 30px; max-width: 500px; width: 90%;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="color: #3b82f6; margin: 0;">Mood Check-in Details</h3>
                        <button onclick="document.getElementById('moodDetailModal').remove()" style="background: none; border: none; color: #dbeafe; font-size: 24px; cursor: pointer;">&times;</button>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px;">
                            <span style="font-size: 32px;">${entry.mood.emoji}</span>
                            <div>
                                <div style="color: ${this.getMoodColor(entry.mood.type, 1)}; font-size: 1.2rem; font-weight: 600;">
                                    ${entry.mood.type.charAt(0).toUpperCase() + entry.mood.type.slice(1)}
                                </div>
                                <div style="color: #93c5fd; font-size: 0.9rem;">
                                    ${date.toLocaleDateString()} at ${date.toLocaleTimeString()}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div style="background: rgba(59, 130, 246, 0.1); border-radius: 8px; padding: 12px;">
                            <div style="color: #60a5fa; font-size: 0.9rem; margin-bottom: 4px;">Energy Level</div>
                            <div style="color: #dbeafe; font-weight: 600;">${entry.context.energy}/10</div>
                        </div>
                        <div style="background: rgba(239, 68, 68, 0.1); border-radius: 8px; padding: 12px;">
                            <div style="color: #f87171; font-size: 0.9rem; margin-bottom: 4px;">Stress Level</div>
                            <div style="color: #dbeafe; font-weight: 600;">${entry.context.stress}/10</div>
                        </div>
                        <div style="background: rgba(34, 197, 94, 0.1); border-radius: 8px; padding: 12px;">
                            <div style="color: #4ade80; font-size: 0.9rem; margin-bottom: 4px;">Social Connection</div>
                            <div style="color: #dbeafe; font-weight: 600;">${entry.context.social}/10</div>
                        </div>
                    </div>

                    ${entry.context.thoughts ? `
                        <div style="background: rgba(40, 40, 40, 0.8); border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                            <div style="color: #60a5fa; font-size: 0.9rem; margin-bottom: 8px;">Your Thoughts</div>
                            <div style="color: #dbeafe; line-height: 1.5;">"${entry.context.thoughts}"</div>
                        </div>
                    ` : ''}

                    <button onclick="document.getElementById('moodDetailModal').remove()" style="width: 100%; background: #3b82f6; border: none; border-radius: 12px; color: white; padding: 12px; font-weight: 600; cursor: pointer;">
                        Close
                    </button>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', detailsHTML);
    }

    // Export mood data
    exportMoodData() {
        console.log('ðŸ“ Attempting to export data...');
        
        if (!this.moodHistoryData || this.moodHistoryData.length === 0) {
            this.showNotification('No data available to export! Create some mood entries first! ðŸ“Š', 'warning');
            return;
        }

        try {
            const csvContent = this.generateCSV();
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `ymir-mood-data-${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Clean up
            URL.revokeObjectURL(url);
            
            this.showNotification('âœ… Mood data exported successfully! Check your Downloads folder! ðŸ“', 'success');
            console.log('âœ… Export completed successfully');
        } catch (error) {
            console.error('âŒ Export failed:', error);
            this.showNotification('âŒ Export failed. Please try again!', 'error');
        }
    }

    // Generate CSV content
    generateCSV() {
        const headers = ['Date', 'Time', 'Mood', 'Mood Value', 'Energy', 'Stress', 'Social Connection', 'Thoughts'];
        const rows = this.moodHistoryData.map(entry => {
            const date = new Date(entry.timestamp);
            return [
                date.toLocaleDateString(),
                date.toLocaleTimeString(),
                entry.mood.type,
                entry.mood.value,
                entry.context.energy,
                entry.context.stress,
                entry.context.social,
                `"${(entry.context.thoughts || '').replace(/"/g, '""')}"`
            ];
        });

        return [headers, ...rows].map(row => row.join(',')).join('\n');
    }

    // Clear mood history
    clearMoodHistory() {
        if (!this.moodHistoryData || this.moodHistoryData.length === 0) {
            this.showNotification('No data to clear! ðŸ§¹', 'info');
            return;
        }

        if (confirm('Are you sure you want to clear all mood history? This action cannot be undone.')) {
            this.moodHistoryData = [];
            
            // Clear from Firebase (in real implementation)
            if (window.ymirAuth) {
                // For now, just clear local data
                // In a real app, you'd need to delete from Firestore
                console.log('ðŸ—‘ï¸ Clearing mood history from Firebase...');
            }
            
            this.renderMoodChart();
            this.renderMoodTable();
            this.showNotification('ðŸ§¹ Mood history cleared successfully!', 'success');
        }
    }

    // Update history stats
    updateHistoryStats() {
        // Could add total check-ins, average mood, etc. to the UI
        console.log(`ðŸ“Š Total check-ins: ${this.moodHistoryData?.length || 0}`);
    }

    // Show test data option for empty history
    showTestDataOption() {
        const chartContainer = document.querySelector('.mood-chart');
        if (chartContainer) {
            chartContainer.innerHTML = `
                <div class="mood-placeholder" style="text-align: center; color: #666; padding: 40px;">
                    <div style="font-size: 48px; margin-bottom: 20px; opacity: 0.5;">ðŸ“Š</div>
                    <h3 style="color: #60a5fa; margin-bottom: 15px;">No Mood Data Yet</h3>
                    <p style="margin-bottom: 20px;">Complete your first daily check-in above to see your mood trends!</p>
                    <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                        <button onclick="dailyCheckIn.generateTestData()" style="background: rgba(59, 130, 246, 0.2); color: #3b82f6; border: 1px solid #3b82f6; border-radius: 8px; padding: 10px 15px; cursor: pointer;">
                            ðŸ“ˆ Add Test Data
                        </button>
                        <button onclick="dailyCheckIn.scrollToCheckIn()" style="background: #3b82f6; color: white; border: none; border-radius: 8px; padding: 10px 15px; cursor: pointer;">
                            âœ¨ Do Check-In Now
                        </button>
                    </div>
                </div>
            `;
        }
    }

    // Generate test data for demonstration
    generateTestData() {
        console.log('ðŸ“Š Generating test mood data...');
        
        const testData = [];
        const moods = ['amazing', 'great', 'good', 'okay', 'rough'];
        const moodValues = [5, 4, 3, 2, 1];
        const moodEmojis = ['âœ¨', 'ðŸ˜Š', 'ðŸ™‚', 'ðŸ˜', 'ðŸ˜”'];
        
        // Generate data for last 7 days
        for (let i = 6; i >= 0; i--) {
            const date = new Date();
            date.setDate(date.getDate() - i);
            
            const randomMoodIndex = Math.floor(Math.random() * moods.length);
            const mood = moods[randomMoodIndex];
            
            testData.push({
                mood: {
                    type: mood,
                    value: moodValues[randomMoodIndex],
                    emoji: moodEmojis[randomMoodIndex]
                },
                context: {
                    energy: Math.floor(Math.random() * 10) + 1,
                    stress: Math.floor(Math.random() * 10) + 1,
                    social: Math.floor(Math.random() * 10) + 1,
                    thoughts: `Test mood entry for ${date.toDateString()}`
                },
                timestamp: date,
                date: date.toDateString(),
                isTestData: true
            });
        }
        
        this.moodHistoryData = testData;
        this.renderMoodChart();
        this.renderMoodTable();
        
        this.showNotification('ðŸ“Š Test data generated! Try switching between Chart and Table view! ðŸŽ¯', 'success');
    }

    // Scroll to check-in section
    scrollToCheckIn() {
        const checkInSection = document.querySelector('.mood-check-in');
        if (checkInSection) {
            checkInSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // Add highlight effect
            checkInSection.style.boxShadow = '0 0 20px rgba(64, 112, 255, 0.5)';
            setTimeout(() => {
                checkInSection.style.boxShadow = '';
            }, 2000);
        }
    }

    // ===============================================
    // ðŸš€ LAZY USER FEATURES - MAXIMUM EASE
    // ===============================================

    setupLazyUserFeatures() {
        this.setupQuickMoodButtons();
        this.setupSmartSuggestions();
        this.setupGentleNudges();
        this.setupProgressGamification();
        this.checkForMoodPatterns();
    }

    // Setup quick one-click mood buttons
    setupQuickMoodButtons() {
        const quickGoodBtn = document.getElementById('quickGoodBtn');
        const quickOkayBtn = document.getElementById('quickOkayBtn');
        const skipTodayBtn = document.getElementById('skipTodayBtn');

        if (quickGoodBtn) {
            quickGoodBtn.addEventListener('click', () => {
                this.quickMoodCheckIn('good', 3, {
                    energy: 6,
                    stress: 4,
                    social: 6,
                    thoughts: 'Just a regular good day'
                });
            });
        }

        if (quickOkayBtn) {
            quickOkayBtn.addEventListener('click', () => {
                this.quickMoodCheckIn('okay', 2, {
                    energy: 5,
                    stress: 6,
                    social: 5,
                    thoughts: 'Nothing special, just okay'
                });
            });
        }

        if (skipTodayBtn) {
            skipTodayBtn.addEventListener('click', () => {
                this.skipTodayButKeepStreak();
            });
        }

        // Add hover effects
        document.querySelectorAll('.quick-mood-btn').forEach(btn => {
            btn.addEventListener('mouseenter', (e) => {
                e.target.style.transform = 'translateY(-2px)';
                e.target.style.boxShadow = '0 4px 15px rgba(64, 112, 255, 0.3)';
            });
            btn.addEventListener('mouseleave', (e) => {
                e.target.style.transform = 'translateY(0)';
                e.target.style.boxShadow = 'none';
            });
        });
    }

    // Quick mood check-in with smart defaults
    async quickMoodCheckIn(moodType, moodValue, smartDefaults) {
        // Show loading state
        const button = event.target;
        const originalText = button.textContent;
        button.textContent = 'âš¡ Saving...';
        button.disabled = true;

        try {
            // Set mood data
            this.currentMood = {
                type: moodType,
                value: moodValue,
                timestamp: new Date(),
                emoji: this.getMoodEmoji(moodType)
            };

            // Set smart context defaults
            this.currentContext = smartDefaults;

            // Prepare check-in data
            const checkInData = {
                mood: this.currentMood,
                context: this.currentContext,
                timestamp: new Date(),
                date: new Date().toDateString(),
                isQuickCheckIn: true,
                deviceInfo: {
                    userAgent: navigator.userAgent,
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
                }
            };

            // Save to Firebase
            if (window.ymirAuth) {
                await window.ymirAuth.saveData('dailyCheckIns', checkInData);
                
                // Update streak
                await this.updateStreak();
                
                // Show celebration
                this.showQuickCheckInCelebration(moodType);
                
                // Reset for next time
                this.resetQuickCheckIn();
                
                // Show achievement if applicable
                this.checkForAchievements();
                
            } else {
                throw new Error('Authentication system not available');
            }

        } catch (error) {
            console.error('âŒ Error with quick check-in:', error);
            this.showNotification('Quick check-in failed. Please try again! ðŸ”„', 'error');
        } finally {
            // Reset button
            button.textContent = originalText;
            button.disabled = false;
        }
    }

    // Skip today but maintain streak (for lazy users)
    async skipTodayButKeepStreak() {
        const today = new Date().toDateString();
        
        try {
            // Create a "maintenance" entry that counts for streak but isn't a real check-in
            const skipData = {
                mood: { type: 'maintenance', value: 0, emoji: 'â­ï¸' },
                context: { energy: 0, stress: 0, social: 0, thoughts: 'Skipped today' },
                timestamp: new Date(),
                date: today,
                isSkip: true,
                deviceInfo: {
                    userAgent: navigator.userAgent,
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
                }
            };

            if (window.ymirAuth) {
                await window.ymirAuth.saveData('dailyCheckIns', skipData);
                
                // Update streak (skip days still count!)
                await this.updateStreak();
                
                this.showNotification('âœ… Day skipped but streak maintained! Come back tomorrow! ðŸ’ª', 'success');
                
                // Hide quick buttons for today
                this.hideQuickButtonsForToday();
            }

        } catch (error) {
            console.error('âŒ Error skipping day:', error);
            this.showNotification('Unable to skip day. Please try again! ðŸ”„', 'error');
        }
    }

    // Show quick check-in celebration
    showQuickCheckInCelebration(moodType) {
        const insights = this.getQuickInsights(moodType);
        this.showNotification(`ðŸš€ Quick check-in complete! ${insights}`, 'success');
        
        // Add sparkle effect
        this.createSparkleEffect();
        
        // Update mood history immediately
        this.loadMoodHistory();
    }

    // Get quick insights for lazy users
    getQuickInsights(moodType) {
        const quickInsights = {
            good: ['Great choice! ðŸ‘', 'Good vibes! âœ¨', 'Solid day! ðŸ’ª'],
            okay: ['That\'s honest! ðŸ¤—', 'Tomorrow will be better! ðŸŒ…', 'You\'re doing fine! ðŸ’™']
        };
        
        const insights = quickInsights[moodType] || ['Thanks for checking in! ðŸ™'];
        return insights[Math.floor(Math.random() * insights.length)];
    }

    // Create sparkle effect for celebrations
    createSparkleEffect() {
        for (let i = 0; i < 8; i++) {
            setTimeout(() => {
                const sparkle = document.createElement('div');
                sparkle.textContent = 'âœ¨';
                sparkle.style.cssText = `
                    position: fixed;
                    font-size: 20px;
                    pointer-events: none;
                    z-index: 1000;
                    animation: sparkleFloat 2s ease-out forwards;
                `;
                
                // Random position around screen center
                sparkle.style.left = (window.innerWidth / 2 + (Math.random() - 0.5) * 200) + 'px';
                sparkle.style.top = (window.innerHeight / 2 + (Math.random() - 0.5) * 200) + 'px';
                
                document.body.appendChild(sparkle);
                
                setTimeout(() => {
                    if (sparkle.parentNode) {
                        sparkle.parentNode.removeChild(sparkle);
                    }
                }, 2000);
            }, i * 150);
        }

        // Add sparkle animation if not exists
        if (!document.querySelector('#sparkleAnimation')) {
            const style = document.createElement('style');
            style.id = 'sparkleAnimation';
            style.textContent = `
                @keyframes sparkleFloat {
                    0% { transform: translateY(0) scale(0.5) rotate(0deg); opacity: 0; }
                    50% { transform: translateY(-30px) scale(1) rotate(180deg); opacity: 1; }
                    100% { transform: translateY(-60px) scale(0.5) rotate(360deg); opacity: 0; }
                }
            `;
            document.head.appendChild(style);
        }
    }

    // Setup smart suggestions based on patterns
    setupSmartSuggestions() {
        setTimeout(() => {
            this.showSmartSuggestion();
        }, 3000); // Show after 3 seconds

        // Setup accept suggestion button
        const acceptBtn = document.getElementById('acceptSuggestionBtn');
        if (acceptBtn) {
            acceptBtn.addEventListener('click', () => {
                this.acceptSmartSuggestion();
            });
        }
    }

    // Show smart suggestions based on user patterns
    showSmartSuggestion() {
        const suggestions = document.getElementById('smartSuggestions');
        const suggestionText = document.getElementById('suggestionText');
        
        if (!suggestions || !suggestionText) return;

        // Get user's historical data for patterns
        const history = this.moodHistoryData || [];
        let suggestion = this.generateSmartSuggestion(history);
        
        if (suggestion) {
            suggestionText.textContent = suggestion.text;
            suggestions.style.display = 'block';
            this.currentSuggestion = suggestion;
        }
    }

    // Generate smart suggestions
    generateSmartSuggestion(history) {
        const today = new Date();
        const dayOfWeek = today.getDay(); // 0 = Sunday, 1 = Monday, etc.
        const hour = today.getHours();
        
        // Time-based suggestions
        if (hour < 12) {
            return {
                text: "Good morning! Mondays usually start with 'Good' mood for most people. Try it?",
                mood: 'good',
                context: { energy: 6, stress: 4, social: 5, thoughts: 'Monday morning vibes' }
            };
        } else if (hour > 18) {
            return {
                text: "Evening check-in! How about 'Okay' - reflecting on the day?",
                mood: 'okay',
                context: { energy: 5, stress: 5, social: 6, thoughts: 'Wrapping up the day' }
            };
        }

        // Pattern-based suggestions
        if (history.length > 3) {
            const recent = history.slice(-3);
            const avgMood = recent.reduce((sum, entry) => sum + entry.mood.value, 0) / recent.length;
            
            if (avgMood >= 3.5) {
                return {
                    text: "You've been feeling good lately! Keep the positive streak going?",
                    mood: 'great',
                    context: { energy: 7, stress: 3, social: 7, thoughts: 'Continuing the positive streak' }
                };
            }
        }

        // Default suggestion
        return {
            text: "Most people feel 'Good' around this time. Want to go with that?",
            mood: 'good',
            context: { energy: 6, stress: 4, social: 6, thoughts: 'Going with the flow' }
        };
    }

    // Accept smart suggestion
    acceptSmartSuggestion() {
        if (this.currentSuggestion) {
            const suggestion = this.currentSuggestion;
            this.quickMoodCheckIn(suggestion.mood, this.getMoodValue(suggestion.mood), suggestion.context);
            
            // Hide suggestions
            const suggestions = document.getElementById('smartSuggestions');
            if (suggestions) suggestions.style.display = 'none';
        }
    }

    // Setup gentle nudges for engagement
    setupGentleNudges() {
        // Check if user hasn't checked in today
        setTimeout(() => {
            this.checkForTodaysCheckIn();
        }, 5000);

        // Periodic gentle reminders
        setInterval(() => {
            this.maybeShowGentleNudge();
        }, 30000); // Every 30 seconds
    }

    // Check if user has checked in today
    checkForTodaysCheckIn() {
        const today = new Date().toDateString();
        const history = this.moodHistoryData || [];
        const todaysCheckIn = history.find(entry => 
            new Date(entry.timestamp).toDateString() === today
        );

        if (!todaysCheckIn) {
            // Show gentle nudge after 10 seconds
            setTimeout(() => {
                this.showGentleNudge();
            }, 10000);
        }
    }

    // Show gentle nudge
    showGentleNudge() {
        const prompt = document.getElementById('contextualPrompt');
        if (prompt) {
            const originalText = prompt.textContent;
            prompt.style.color = '#4fd1c7';
            prompt.style.fontWeight = '600';
            prompt.textContent = 'ðŸ’™ Quick check-in? Just one click above! â¬†ï¸';
            
            setTimeout(() => {
                prompt.style.color = '#b0b0b0';
                prompt.style.fontWeight = 'normal';
                prompt.textContent = originalText;
            }, 5000);
        }
    }

    // Maybe show gentle nudge based on patterns
    maybeShowGentleNudge() {
        const today = new Date().toDateString();
        const history = this.moodHistoryData || [];
        const todaysCheckIn = history.find(entry => 
            new Date(entry.timestamp).toDateString() === today
        );

        // Only nudge if no check-in today and user has been on page for a while
        if (!todaysCheckIn && Math.random() < 0.1) { // 10% chance every 30 seconds
            this.updateContextualPrompt();
            const prompts = [
                'ðŸŒŸ One quick click = streak maintained!',
                'âš¡ 2 seconds to check in?',
                'ðŸ’ª Keep that streak alive!',
                'ðŸŽ¯ Quick mood check?'
            ];
            
            const prompt = document.getElementById('contextualPrompt');
            if (prompt) {
                const randomPrompt = prompts[Math.floor(Math.random() * prompts.length)];
                prompt.textContent = randomPrompt;
                prompt.style.color = '#4fd1c7';
            }
        }
    }

    // Setup progress gamification
    setupProgressGamification() {
        this.showProgressIndicators();
        this.setupMicroRewards();
    }

    // Show progress indicators
    showProgressIndicators() {
        // Add progress towards next milestone
        const streakCount = this.streakData.current;
        const nextMilestone = this.getNextMilestone(streakCount);
        
        if (nextMilestone > streakCount) {
            const progress = (streakCount / nextMilestone) * 100;
            this.addProgressBar(progress, nextMilestone);
        }
    }

    // Get next milestone
    getNextMilestone(current) {
        const milestones = [7, 30, 100, 365];
        return milestones.find(milestone => milestone > current) || 365;
    }

    // Add progress bar to UI
    addProgressBar(progress, milestone) {
        const achievementBar = document.getElementById('achievementBar');
        if (achievementBar && !document.getElementById('progressBar')) {
            const progressHTML = `
                <div id="progressBar" style="margin-left: 20px; flex: 1; max-width: 200px;">
                    <div style="display: flex; justify-content: space-between; font-size: 0.8rem; color: #93c5fd; margin-bottom: 4px;">
                        <span>Next Goal</span>
                        <span>${milestone} days</span>
                    </div>
                    <div style="background: rgba(100, 100, 255, 0.2); height: 6px; border-radius: 3px; overflow: hidden;">
                        <div style="background: linear-gradient(90deg, #3b82f6, #06b6d4); height: 100%; width: ${progress}%; transition: width 0.5s ease; border-radius: 3px;"></div>
                    </div>
                </div>
            `;
            achievementBar.insertAdjacentHTML('beforeend', progressHTML);
        }
    }

    // Setup micro-rewards
    setupMicroRewards() {
        // Small celebrations for any interaction
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('mood-btn') || e.target.classList.contains('quick-mood-btn')) {
                this.showMicroReward();
            }
        });
    }

    // Show micro reward
    showMicroReward() {
        const rewards = ['ðŸŒŸ', 'âœ¨', 'ðŸ’«', 'â­', 'ðŸŽ¯'];
        const reward = rewards[Math.floor(Math.random() * rewards.length)];
        
        const element = document.createElement('div');
        element.textContent = reward;
        element.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            font-size: 24px;
            z-index: 1000;
            animation: microReward 1s ease-out forwards;
            pointer-events: none;
        `;
        
        document.body.appendChild(element);
        
        setTimeout(() => {
            if (element.parentNode) {
                element.parentNode.removeChild(element);
            }
        }, 1000);

        // Add micro reward animation
        if (!document.querySelector('#microRewardAnimation')) {
            const style = document.createElement('style');
            style.id = 'microRewardAnimation';
            style.textContent = `
                @keyframes microReward {
                    0% { transform: scale(0) rotate(0deg); opacity: 0; }
                    50% { transform: scale(1.2) rotate(180deg); opacity: 1; }
                    100% { transform: scale(1) rotate(360deg); opacity: 0; }
                }
            `;
            document.head.appendChild(style);
        }
    }

    // Check for mood patterns
    checkForMoodPatterns() {
        if (this.moodHistoryData && this.moodHistoryData.length >= 7) {
            const patterns = this.analyzeMoodPatterns();
            if (patterns.hasPattern) {
                this.showPatternInsight(patterns);
            }
        }
    }

    // Analyze mood patterns
    analyzeMoodPatterns() {
        const recent = this.moodHistoryData.slice(-7);
        const moods = recent.map(entry => entry.mood.value);
        
        // Check for consistent patterns
        const avg = moods.reduce((a, b) => a + b, 0) / moods.length;
        const isStable = moods.every(mood => Math.abs(mood - avg) <= 1);
        const isImproving = moods.slice(-3).every((mood, i, arr) => i === 0 || mood >= arr[i-1]);
        
        return {
            hasPattern: isStable || isImproving,
            isStable,
            isImproving,
            average: avg
        };
    }

    // Show pattern insight
    showPatternInsight(patterns) {
        let message = '';
        if (patterns.isImproving) {
            message = 'ðŸ“ˆ Your mood is trending upward! Keep it up!';
        } else if (patterns.isStable) {
            message = 'âš–ï¸ Your mood is very consistent. That\'s great emotional stability!';
        }
        
        if (message) {
            setTimeout(() => {
                this.showNotification(message, 'info');
            }, 2000);
        }
    }

    // Reset quick check-in
    resetQuickCheckIn() {
        this.currentMood = null;
        this.currentContext = {
            energy: 5,
            stress: 5,
            social: 5,
            thoughts: ''
        };
    }

    // Hide quick buttons after check-in
    hideQuickButtonsForToday() {
        const quickButtons = document.querySelectorAll('.quick-mood-btn');
        quickButtons.forEach(btn => {
            btn.style.opacity = '0.5';
            btn.disabled = true;
            btn.textContent = btn.textContent.replace('âš¡', 'âœ…').replace('ðŸ˜', 'âœ…').replace('â­ï¸', 'âœ…');
        });
    }

    // Get mood emoji
    getMoodEmoji(moodType) {
        const emojis = {
            amazing: 'âœ¨',
            great: 'ðŸ˜Š',
            good: 'ðŸ™‚',
            okay: 'ðŸ˜',
            rough: 'ðŸ˜”'
        };
        return emojis[moodType] || 'ðŸ™‚';
    }

    // Get mood value
    getMoodValue(moodType) {
        const values = {
            amazing: 5,
            great: 4,
            good: 3,
            okay: 2,
            rough: 1
        };
        return values[moodType] || 3;
    }


}

// Initialize Daily Check-in System
let dailyCheckIn;

// Wait for DOM and Firebase to be ready
document.addEventListener('DOMContentLoaded', () => {
    setTimeout(() => {
        dailyCheckIn = new DailyCheckInManager();
        console.log('ðŸ§  Daily Check-in System Initialized');
    }, 1000);
});

// Export functions for global access
window.YMIRAuth = {
    onUserAuthenticated,
    onTemporaryMode,
    updateDashboardForAuthenticatedUser,
    updateDashboardForTemporaryUser,
    showNotification
};

// Export daily check-in manager
window.DailyCheckIn = () => dailyCheckIn;
</script>

<!-- Visual Settings Modal -->
<div id="visualSettingsModal" class="visual-settings-modal">
    <div class="visual-settings-modal-content">
        <div class="visual-settings-header">
            <h2>
                <span class="gear-icon">âš™ï¸</span>
                Advanced Visual Controls
            </h2>
            <button class="close-button" onclick="closeVisualSettingsModal()">&times;</button>
        </div>
        
        <div class="visual-settings-body">
            <!-- MediaPipe Features Section -->
            <div class="control-section">
                <h4 style="color: #fbbf24;">MediaPipe Features</h4>
                <div class="control-grid">
                    <label class="toggle-label">
                        <input type="checkbox" id="toggle_face_mesh" checked onchange="updateVisualSettings()">
                        <span>Face Mesh</span>
                    </label>
                    <label class="toggle-label">
                        <input type="checkbox" id="toggle_body_pose" checked onchange="updateVisualSettings()">
                        <span>Body Pose</span>
                    </label>
                    <label class="toggle-label">
                        <input type="checkbox" id="toggle_hand_tracking" checked onchange="updateVisualSettings()">
                        <span>Hand Tracking</span>
                    </label>
                    <label class="toggle-label">
                        <input type="checkbox" id="toggle_gaze_tracking" checked onchange="updateVisualSettings()">
                        <span>Gaze Tracking</span>
                    </label>
                </div>
            </div>

            <!-- YOLO Object Detection Section -->
            <div class="control-section">
                <h4 style="color: #f97316;">YOLO Object Detection</h4>
                <div class="control-grid">
                    <label class="toggle-label">
                        <input type="checkbox" id="toggle_object_detection" checked onchange="updateVisualSettings()">
                        <span>ðŸ“¦ Object Detection</span>
                    </label>
                    <label class="toggle-label">
                        <input type="checkbox" id="toggle_emotion_context" checked onchange="updateVisualSettings()">
                        <span>ðŸŽ­ Emotion Context</span>
                    </label>
                    <div class="settings-input-group full-width">
                        <label class="settings-label">ðŸŽšï¸ Detection Confidence</label>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="range" id="confidence_threshold" class="settings-range" 
                                   min="0.1" max="0.9" step="0.05" value="0.25" 
                                   onchange="updateVisualSettings(); updateConfidenceValue()">
                            <span id="confidence_value" class="range-value">0.25</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Performance & Quality Section -->
            <div class="control-section">
                <h4 style="color: #ef4444;">âš¡ Performance & Quality</h4>
                <div class="control-grid">
                    <div class="settings-input-group">
                        <label class="settings-label">ðŸ“¹ Video Quality</label>
                        <select id="video_quality" class="settings-select" onchange="updateVisualSettings()">
                            <option value="720p">720p (Recommended)</option>
                            <option value="1080p">1080p (High Quality)</option>
                            <option value="480p">480p (Fast)</option>
                        </select>
                    </div>
                    <div class="settings-input-group">
                        <label class="settings-label">ðŸŽšï¸ Analysis Interval</label>
                        <select id="analysis_interval" class="settings-select" onchange="updateVisualSettings()">
                            <option value="15">15 frames (2x per sec)</option>
                            <option value="30" selected>30 frames (1x per sec)</option>
                            <option value="60">60 frames (0.5x per sec)</option>
                        </select>
                    </div>
                    <label class="toggle-label">
                        <input type="checkbox" id="toggle_quality_indicators" checked onchange="updateVisualSettings()">
                        <span>Quality Indicators</span>
                    </label>
                    <label class="toggle-label">
                        <input type="checkbox" id="toggle_fps_display" onchange="updateVisualSettings()">
                        <span>FPS Display</span>
                    </label>
                </div>
            </div>
        </div>
    </div>
</div>

</body>
</html>